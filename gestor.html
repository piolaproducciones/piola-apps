<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Producci√≥n Master</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,700;0,800;1,700;1,800&family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0c0c0f;
    --surface: #141418;
    --surface2: #1c1c22;
    --surface3: #222228;
    --border: #2a2a38;
    --accent: #e8c800;
    --accent2: #e8c800;
    --danger: #ff5757;
    --warn: #ffb857;
    --text: #e8e8f0;
    --muted: #6b6b80;
    --muted2: #4a4a5a;
    --radius: 10px;
    --font-body: 'Syne', sans-serif;
    --font-mono: 'DM Mono', monospace;
    --font-display: 'Barlow Condensed', sans-serif;
    --col-cost: #ff8fa3;
    --col-sale: #e8c800;
    --col-fin: #57c8ff;
  }
  :root[data-theme="light"] {
    --bg: #f0f0f5; --surface: #ffffff; --surface2: #f4f4f8; --surface3: #eaeaf0;
    --border: #dcdce8; --accent: #b89a00; --danger: #cc2200; --warn: #cc7700;
    --text: #1a1a2e; --muted: #70708a; --muted2: #a0a0b8;
    --col-cost: #cc3355; --col-fin: #0077aa; --col-sale: #b89a00;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: var(--font-body); font-size: 13px; min-height: 100vh; }

  .topbar {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 0 28px; height: 56px; display: flex; align-items: center;
    justify-content: space-between; position: sticky; top: 0; z-index: 100;
  }
  .logo { font-family: var(--font-display); font-size: 22px; color: var(--text); letter-spacing: -0.5px; }
  .logo span { color: var(--accent); }
  .logo .role { font-family: var(--font-mono); font-size: 11px; color: var(--muted); margin-left: 10px; letter-spacing: 1px; text-transform: uppercase; }

  .tabs { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 28px; display: flex; gap: 2px; }
  .tab { padding: 12px 20px; font-size: 12px; font-weight: 600; letter-spacing: 0.8px; text-transform: uppercase; color: var(--muted); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  .main { padding: 24px 28px; max-width: 1400px; margin: 0 auto; }

  .panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; margin-bottom: 16px; }
  .panel-header { padding: 14px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: var(--surface2); }
  .panel-title { font-size: 11px; font-weight: 700; letter-spacing: 1.2px; text-transform: uppercase; color: var(--muted); }
  .panel-body { padding: 20px; }

  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group label { font-size: 10px; font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase; color: var(--muted); }
  .form-control { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); padding: 8px 12px; font-family: var(--font-body); font-size: 13px; outline: none; transition: border-color 0.2s; width: 100%; }
  .form-control:focus { border-color: var(--accent); }
  select.form-control option { background: var(--surface2); }

  .btn { padding: 9px 18px; border-radius: 6px; border: none; cursor: pointer; font-family: var(--font-body); font-size: 12px; font-weight: 600; letter-spacing: 0.5px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
  .btn-primary { background: var(--accent); color: var(--bg); }
  .btn-primary:hover { background: #7affa8; transform: translateY(-1px); }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger { background: rgba(255,87,87,0.15); color: var(--danger); border: 1px solid rgba(255,87,87,0.3); }
  .del-btn { background: none; border: none; color: var(--muted2); cursor: pointer; padding: 4px 6px; border-radius: 4px; font-size: 14px; transition: all 0.2s; }
  .del-btn:hover { color: var(--danger); background: rgba(255,87,87,0.1); }

  .view { display: none; }
  .view.active { display: block; }

  th { padding: 10px; text-align: left; font-size: 9px; font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase; color: var(--muted); border-bottom: 1px solid var(--border); white-space: nowrap; }
  td { padding: 10px; vertical-align: middle; }
  tbody tr { border-bottom: 1px solid rgba(42,56,42,0.5); transition: background 0.15s; }
  tbody tr:hover { background: rgba(255,255,255,0.02); }

  .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; font-family: var(--font-mono); }
  .badge-unit { background: var(--surface3); border: 1px solid var(--border); color: var(--muted); }

  /* MODAL */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 200; align-items: center; justify-content: center; }
  .modal-overlay.open { display: flex; }
  .modal-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); width: 740px; max-width: 95vw; max-height: 88vh; overflow-y: auto; }
  .modal-header { padding: 18px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--surface2); position: sticky; top: 0; z-index: 10; }
  .modal-body { padding: 24px; }

  .costo-badge { font-family: var(--font-mono); font-size: 22px; font-weight: 500; color: var(--col-sale); }
  .costo-badge.empty { color: var(--muted2); font-size: 14px; }

  .loading { display: flex; align-items: center; gap: 10px; color: var(--muted); font-size: 12px; padding: 30px; justify-content: center; }
  .spinner { width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .empty-state { padding: 50px; text-align: center; color: var(--muted); font-size: 13px; }
  .empty-state .icon { font-size: 36px; margin-bottom: 12px; }
  .empty-state p { color: var(--muted2); font-size: 11px; margin-top: 6px; }

  .toast { position: fixed; bottom: 24px; right: 24px; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 20px; font-size: 13px; z-index: 999; transform: translateY(80px); opacity: 0; transition: all 0.3s; }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.success { border-color: rgba(87,255,143,0.4); }

  .table-wrapper { overflow-x: auto; }

  input[type=number]::-webkit-inner-spin-button { opacity: 0.5; }
</style>
</head>
<body>

<div class="topbar">
  <div style="display:flex; align-items:center; gap:12px;">
    <a href="index.html" style="background:var(--surface2); border:1px solid var(--border); color:var(--muted); border-radius:8px; padding:6px 12px; font-size:12px; font-weight:600; text-decoration:none; font-family:var(--font-body);">‚Üê Inicio</a>
    <div class="logo">Producci√≥n <span>¬∑</span> Master<span class="role">Producci√≥n</span></div>
  </div>
  <div style="display:flex; align-items:center; gap:10px;">
    <button id="theme-btn" onclick="toggleTheme()" style="background:var(--surface2); border:1px solid var(--border); color:var(--muted); border-radius:8px; padding:6px 12px; font-family:var(--font-body); font-size:12px; font-weight:600; cursor:pointer;">‚òÄÔ∏è Claro</button>
    <span id="fb-status" style="font-size:11px; font-family:var(--font-mono); color:var(--muted);">‚è≥ conectando...</span>
  </div>
</div>

<div class="tabs">
  <div class="tab active" onclick="showTab('materiales', this)">üßµ Materiales</div>
  <div class="tab" onclick="showTab('productos', this)">üì¶ Productos</div>
</div>

<div class="main">

<!-- ===== MATERIALES ===== -->
<div class="view active" id="tab-materiales">
  <div class="panel">
    <div class="panel-header">
      <span class="panel-title">Lista Maestra de Materiales</span>
      <span id="mat-count" style="font-size:11px; color:var(--muted); font-family:var(--font-mono);">0 materiales</span>
    </div>
    <div class="panel-body">
      <div style="display:grid; grid-template-columns:2fr 1fr 1fr auto; gap:10px; align-items:end; margin-bottom:20px;">
        <div class="form-group">
          <label>Nombre del Material</label>
          <input type="text" class="form-control" id="mat-nombre" placeholder="Ej: Tela Oxford 600D, Av√≠os met√°licos...">
        </div>
        <div class="form-group">
          <label>Unidad</label>
          <select class="form-control" id="mat-unidad">
            <option value="unidad">Unidad</option>
            <option value="metro">Metro</option>
            <option value="kg">Kg</option>
            <option value="gr">Gramo</option>
            <option value="metro2">Metro¬≤</option>
            <option value="litro">Litro</option>
            <option value="rollo">Rollo</option>
            <option value="paquete">Paquete</option>
          </select>
        </div>
        <div class="form-group">
          <label>Costo por Unidad $</label>
          <input type="number" class="form-control" id="mat-costo" placeholder="0" min="0" step="10">
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <button class="btn btn-primary" onclick="addMaterial()">+ Agregar</button>
        </div>
      </div>
      <input type="text" class="form-control" id="mat-search" placeholder="üîç  Buscar material..." oninput="renderMateriales()" style="max-width:340px; margin-bottom:14px; float:left;">
      <div style="float:right; margin-bottom:14px;">
        <button class="btn btn-secondary" onclick="document.getElementById('csv-modal').style.display='flex'" style="font-size:12px;">üìÇ Importar CSV</button>
      </div>
      <div style="clear:both;"></div>
      <div id="mat-loading" class="loading"><div class="spinner"></div> Cargando materiales...</div>
      <div class="table-wrapper">
        <table style="width:100%; border-collapse:collapse;">
          <thead><tr>
            <th>Material</th>
            <th style="text-align:center;">Unidad</th>
            <th style="text-align:right; color:var(--col-cost);">Costo / Unidad</th>
            <th style="text-align:right;">Usado en</th>
            <th></th>
          </tr></thead>
          <tbody id="mat-tbody"></tbody>
        </table>
      </div>
      <div id="mat-empty" class="empty-state" style="display:none;">
        <div class="icon">üßµ</div>
        No hay materiales cargados a√∫n.
        <p>Agreg√° los materiales base para luego armar las fichas t√©cnicas de cada producto.</p>
      </div>
    </div>
  </div>
</div>

<!-- ===== PRODUCTOS ===== -->
<div class="view" id="tab-productos">
  <div class="panel">
    <div class="panel-header">
      <span class="panel-title">Productos</span>
      <span id="prod-count" style="font-size:11px; color:var(--muted); font-family:var(--font-mono);">0 productos</span>
    </div>
    <div class="panel-body">
      <div style="display:grid; grid-template-columns:2fr 1fr auto; gap:10px; align-items:end; margin-bottom:20px;">
        <div class="form-group">
          <label>Nombre del Producto</label>
          <input type="text" class="form-control" id="prod-nombre" placeholder="Ej: Mochila escolar, Totebag premium 300gr...">
        </div>
        <div class="form-group">
          <label>Proveedor / √Årea</label>
          <input type="text" class="form-control" id="prod-proveedor" placeholder="Opcional">
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <button class="btn btn-primary" onclick="addProducto()">+ Crear Producto</button>
        </div>
      </div>
      <input type="text" class="form-control" id="prod-search" placeholder="üîç  Buscar producto..." oninput="renderProductos()" style="max-width:340px; margin-bottom:14px;">
      <div id="prod-loading" class="loading"><div class="spinner"></div> Cargando productos...</div>
      <div class="table-wrapper">
        <table style="width:100%; border-collapse:collapse;">
          <thead><tr>
            <th>Producto</th>
            <th>Proveedor / √Årea</th>
            <th style="text-align:center;">Materiales</th>
            <th style="text-align:right; color:var(--col-sale);">Costo Total</th>
            <th style="text-align:right;">Actualizado</th>
            <th></th>
          </tr></thead>
          <tbody id="prod-tbody"></tbody>
        </table>
      </div>
      <div id="prod-empty" class="empty-state" style="display:none;">
        <div class="icon">üì¶</div>
        No hay productos cargados a√∫n.
        <p>Cre√° un producto y arm√° su ficha t√©cnica con los materiales que lo componen.</p>
      </div>
    </div>
  </div>
</div>

</div><!-- main -->

<!-- MODAL FICHA T√âCNICA -->
<div class="modal-overlay" id="ficha-modal">
  <div class="modal-box">
    <div class="modal-header">
      <div>
        <div class="panel-title">Ficha T√©cnica</div>
        <div id="ficha-titulo" style="font-size:17px; font-weight:700; color:var(--text); margin-top:4px;"></div>
      </div>
      <div style="display:flex; align-items:center; gap:16px;">
        <div>
          <div style="font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:0.6px; margin-bottom:2px;">Costo Total</div>
          <div class="costo-badge" id="ficha-costo-total">$0</div>
        </div>
        <button class="del-btn" style="font-size:22px;" onclick="closeFicha()">√ó</button>
      </div>
    </div>
    <div class="modal-body">
      <!-- Agregar componente -->
      <div style="background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius); padding:16px; margin-bottom:20px;">
        <div style="font-size:10px; font-weight:700; letter-spacing:0.8px; text-transform:uppercase; color:var(--muted); margin-bottom:12px;">Agregar Material</div>
        <div style="display:grid; grid-template-columns:2fr 1fr auto; gap:10px; align-items:end;">
          <div class="form-group" style="margin:0;">
            <label>Material</label>
            <select class="form-control" id="ficha-mat-sel" onchange="updateCantLabel()">
              <option value="">‚Äî Seleccion√° un material ‚Äî</option>
            </select>
          </div>
          <div class="form-group" style="margin:0;">
            <label id="ficha-cant-label">Cantidad</label>
            <input type="number" class="form-control" id="ficha-cant" placeholder="0" min="0" step="0.01">
          </div>
          <div class="form-group" style="margin:0;">
            <label>&nbsp;</label>
            <button class="btn btn-primary" onclick="addComponente()" style="width:100%;">+ Agregar</button>
          </div>
        </div>
      </div>
      <!-- Tabla componentes -->
      <div id="ficha-loading" class="loading" style="display:none;"><div class="spinner"></div></div>
      <table style="width:100%; border-collapse:collapse;" id="ficha-tabla">
        <thead><tr>
          <th>Material</th>
          <th style="text-align:center;">Unidad</th>
          <th style="text-align:center;">Cantidad</th>
          <th style="text-align:right; color:var(--col-cost);">Costo Unit.</th>
          <th style="text-align:right; color:var(--col-cost);">Subtotal</th>
          <th></th>
        </tr></thead>
        <tbody id="ficha-tbody"></tbody>
      </table>
      <div id="ficha-empty" style="display:none; padding:30px; text-align:center; color:var(--muted); font-size:12px;">
        Sin materiales. Agreg√° componentes desde la lista de arriba.
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- MODAL CSV IMPORT -->
<div id="csv-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:300; align-items:center; justify-content:center; padding:20px;">
  <div style="background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); width:600px; max-width:95vw;">
    <div style="padding:18px 24px; border-bottom:1px solid var(--border); background:var(--surface2); display:flex; justify-content:space-between; align-items:center;">
      <div>
        <div style="font-size:11px; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--muted); margin-bottom:4px;">Importar materiales</div>
        <div style="font-size:16px; font-weight:700;">Carga masiva por CSV</div>
      </div>
      <button onclick="closeCsvModal()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:22px;">√ó</button>
    </div>
    <div style="padding:24px;">
      <div style="background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:14px 16px; margin-bottom:18px; font-size:12px; color:var(--muted); line-height:1.7;">
        <strong style="color:var(--text);">Formato esperado del CSV:</strong><br>
        Una fila por material con 3 columnas: <code style="color:var(--accent);">nombre, unidad, costo</code><br>
        Ejemplo: <code style="color:var(--muted);">Lona 220gr, metro2, 1850</code><br>
        Si el material ya existe (mismo nombre), <strong style="color:var(--warn);">actualiza el costo</strong>. Si no existe, lo crea.
      </div>
      <div style="margin-bottom:16px;">
        <label style="display:block; font-size:11px; font-weight:700; letter-spacing:0.6px; text-transform:uppercase; color:var(--muted); margin-bottom:8px;">Seleccionar archivo CSV</label>
        <input type="file" id="csv-file" accept=".csv,.txt" onchange="previewCsv(this)"
          style="background:var(--surface2); border:1px solid var(--border); border-radius:6px; color:var(--text); padding:8px 12px; font-size:13px; width:100%; cursor:pointer;">
      </div>
      <div id="csv-preview" style="display:none; margin-bottom:16px;">
        <div style="font-size:10px; font-weight:700; letter-spacing:0.8px; text-transform:uppercase; color:var(--muted); margin-bottom:8px;" id="csv-preview-title"></div>
        <div style="max-height:200px; overflow-y:auto; border:1px solid var(--border); border-radius:6px;">
          <table style="width:100%; border-collapse:collapse; font-size:12px;" id="csv-preview-table">
            <thead><tr>
              <th style="padding:7px 12px; text-align:left; font-size:9px; font-weight:700; letter-spacing:0.7px; text-transform:uppercase; color:var(--muted); border-bottom:1px solid var(--border);">Nombre</th>
              <th style="padding:7px 12px; text-align:left; font-size:9px; font-weight:700; letter-spacing:0.7px; text-transform:uppercase; color:var(--muted); border-bottom:1px solid var(--border);">Unidad</th>
              <th style="padding:7px 12px; text-align:right; font-size:9px; font-weight:700; letter-spacing:0.7px; text-transform:uppercase; color:var(--col-cost); border-bottom:1px solid var(--border);">Costo</th>
              <th style="padding:7px 12px; text-align:center; font-size:9px; font-weight:700; letter-spacing:0.7px; text-transform:uppercase; color:var(--muted); border-bottom:1px solid var(--border);">Acci√≥n</th>
            </tr></thead>
            <tbody id="csv-preview-body"></tbody>
          </table>
        </div>
      </div>
      <div id="csv-result" style="display:none; padding:12px 16px; border-radius:6px; font-size:12px; margin-bottom:16px;"></div>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button class="btn btn-secondary" onclick="closeCsvModal()">Cancelar</button>
        <button class="btn btn-primary" id="csv-import-btn" onclick="importCsv()" style="display:none;">‚¨Ü Importar</button>
      </div>
    </div>
  </div>
</div>

<!-- FIREBASE MODULE -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, collection, doc, getDocs, addDoc, updateDoc, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyAQNT8-8Q5v7Tfn9MIy530RSHdZj6Am390",
  authDomain: "piola-cotizador.firebaseapp.com",
  projectId: "piola-cotizador",
  storageBucket: "piola-cotizador.firebasestorage.app",
  messagingSenderId: "881054830595",
  appId: "1:881054830595:web:3d138a4952bba717d63e36"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// ‚îÄ‚îÄ‚îÄ Exponer al scope global ‚îÄ‚îÄ‚îÄ
window.db          = db;
window.fbDoc       = doc;
window.fbCollection= collection;
window.fbGetDocs   = getDocs;
window.fbAddDoc    = addDoc;
window.fbUpdateDoc = updateDoc;
window.fbDeleteDoc = deleteDoc;
window.fbOnSnapshot= onSnapshot;

// ‚îÄ‚îÄ‚îÄ Iniciar listeners en tiempo real ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', () => {
  initListeners();
});
</script>

<script>
// ============================================================
// STATE
// ============================================================
let materialesDB = {};  // { id: { nombre, unidad, costo } }
let productosDB  = {};  // { id: { nombre, proveedor, componentes:[], costoTotal } }
let fichaActivaId = null;

// ============================================================
// NAVIGATION
// ============================================================
function showTab(name, el) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  el.classList.add('active');
}

// ============================================================
// FIREBASE LISTENERS (tiempo real)
// ============================================================
function initListeners() {
  const fbStatus = document.getElementById('fb-status');

  // Materiales
  window.fbOnSnapshot(
    window.fbCollection(window.db, 'materiales'),
    snap => {
      materialesDB = {};
      snap.forEach(d => materialesDB[d.id] = { id: d.id, ...d.data() });
      renderMateriales();
      if (fichaActivaId) refreshFichaSelect();
      fbStatus.textContent = 'üü¢ conectado';
      fbStatus.style.color = 'var(--accent)';
      document.getElementById('mat-loading').style.display = 'none';
    },
    err => {
      fbStatus.textContent = 'üî¥ error conexi√≥n';
      fbStatus.style.color = 'var(--danger)';
      console.error(err);
    }
  );

  // Productos
  window.fbOnSnapshot(
    window.fbCollection(window.db, 'productos'),
    snap => {
      productosDB = {};
      snap.forEach(d => productosDB[d.id] = { id: d.id, ...d.data() });
      renderProductos();
      if (fichaActivaId) renderFichaComponentes();
      document.getElementById('prod-loading').style.display = 'none';
    },
    err => console.error(err)
  );
}

// ============================================================
// MATERIALES
// ============================================================
async function addMaterial() {
  const nombre = document.getElementById('mat-nombre').value.trim();
  const unidad = document.getElementById('mat-unidad').value;
  const costo  = parseFloat(document.getElementById('mat-costo').value) || 0;
  if (!nombre) { toast('Ingres√° un nombre de material', ''); return; }
  const existe = Object.values(materialesDB).find(m => m.nombre.toLowerCase() === nombre.toLowerCase());
  if (existe) { toast('Ya existe un material con ese nombre', ''); return; }
  try {
    await window.fbAddDoc(window.fbCollection(window.db, 'materiales'), {
      nombre, unidad, costo,
      creadoEn: new Date().toLocaleDateString('es-AR')
    });
    document.getElementById('mat-nombre').value = '';
    document.getElementById('mat-costo').value = '';
    document.getElementById('mat-nombre').focus();
    toast('‚úì Material agregado', 'success');
  } catch(e) { toast('Error al guardar: ' + e.message, ''); }
}

async function editMaterial(id) {
  const m = materialesDB[id];
  if (!m) return;
  const nombre = prompt('Nombre del material:', m.nombre);
  if (nombre === null) return;
  const costo = parseFloat(prompt(`Costo por ${m.unidad} $:`, m.costo));
  if (isNaN(costo)) return;
  try {
    await window.fbUpdateDoc(window.fbDoc(window.db, 'materiales', id), { nombre: nombre.trim() || m.nombre, costo });
    // Recalcular costos de todos los productos que usen este material
    for (const p of Object.values(productosDB)) {
      const comps = p.componentes || [];
      const updated = comps.map(c => c.materialId === id ? { ...c, costoUnit: costo } : c);
      const nuevoTotal = updated.reduce((s, c) => s + c.cantidad * c.costoUnit, 0);
      if (JSON.stringify(comps) !== JSON.stringify(updated)) {
        await window.fbUpdateDoc(window.fbDoc(window.db, 'productos', p.id), {
          componentes: updated, costoTotal: nuevoTotal
        });
      }
    }
    toast('‚úì Material actualizado y productos recalculados', 'success');
  } catch(e) { toast('Error: ' + e.message, ''); }
}

async function deleteMaterial(id) {
  const usado = Object.values(productosDB).some(p => (p.componentes || []).some(c => c.materialId === id));
  const msg = usado
    ? 'Este material est√° en fichas de productos. ¬øEliminar igual?'
    : '¬øEliminar este material?';
  if (!confirm(msg)) return;
  try {
    await window.fbDeleteDoc(window.fbDoc(window.db, 'materiales', id));
    toast('Material eliminado', '');
  } catch(e) { toast('Error: ' + e.message, ''); }
}

function renderMateriales() {
  const search  = (document.getElementById('mat-search')?.value || '').toLowerCase();
  const mats    = Object.values(materialesDB);
  const filtered = mats.filter(m => m.nombre.toLowerCase().includes(search));
  const count   = document.getElementById('mat-count');
  if (count) count.textContent = mats.length + ' material' + (mats.length !== 1 ? 'es' : '');
  const tbody = document.getElementById('mat-tbody');
  const empty = document.getElementById('mat-empty');
  if (!tbody) return;
  if (mats.length === 0) { empty.style.display = 'block'; tbody.innerHTML = ''; return; }
  empty.style.display = 'none';

  // Contar cu√°ntos productos usan cada material
  const usoCount = {};
  Object.values(productosDB).forEach(p =>
    (p.componentes || []).forEach(c => { usoCount[c.materialId] = (usoCount[c.materialId] || 0) + 1; })
  );

  tbody.innerHTML = filtered.map(m => `
    <tr>
      <td style="font-size:13px; font-weight:600;">${m.nombre}</td>
      <td style="text-align:center;"><span class="badge badge-unit">${m.unidad}</span></td>
      <td style="font-family:var(--font-mono); font-size:13px; color:var(--col-cost); text-align:right;">
        $${fmtDec(m.costo)} <span style="color:var(--muted); font-size:10px;">/ ${m.unidad}</span>
      </td>
      <td style="text-align:right; font-size:11px; color:var(--muted);">
        ${usoCount[m.id] ? usoCount[m.id] + ' prod.' : '‚Äî'}
      </td>
      <td style="display:flex; gap:6px; justify-content:flex-end;">
        <button class="btn btn-secondary" style="font-size:11px; padding:4px 10px;" onclick="editMaterial('${m.id}')">‚úèÔ∏è Editar</button>
        <button class="del-btn" onclick="deleteMaterial('${m.id}')">√ó</button>
      </td>
    </tr>
  `).join('') || `<tr><td colspan="5" style="padding:20px; text-align:center; color:var(--muted);">Sin resultados</td></tr>`;
}

// ============================================================
// PRODUCTOS
// ============================================================
async function addProducto() {
  const nombre    = document.getElementById('prod-nombre').value.trim();
  const proveedor = document.getElementById('prod-proveedor').value.trim();
  if (!nombre) { toast('Ingres√° un nombre de producto', ''); return; }
  const existe = Object.values(productosDB).find(p => p.nombre.toLowerCase() === nombre.toLowerCase());
  if (existe) { toast('Ya existe un producto con ese nombre', ''); return; }
  try {
    const ref = await window.fbAddDoc(window.fbCollection(window.db, 'productos'), {
      nombre, proveedor, componentes: [], costoTotal: 0,
      actualizadoEn: new Date().toLocaleDateString('es-AR')
    });
    document.getElementById('prod-nombre').value = '';
    document.getElementById('prod-proveedor').value = '';
    toast('‚úì Producto creado', 'success');
    openFicha(ref.id);
  } catch(e) { toast('Error: ' + e.message, ''); }
}

async function deleteProducto(id) {
  if (!confirm('¬øEliminar este producto?')) return;
  try {
    await window.fbDeleteDoc(window.fbDoc(window.db, 'productos', id));
    toast('Producto eliminado', '');
  } catch(e) { toast('Error: ' + e.message, ''); }
}

function renderProductos() {
  const search   = (document.getElementById('prod-search')?.value || '').toLowerCase();
  const prods    = Object.values(productosDB);
  const filtered = prods.filter(p =>
    p.nombre.toLowerCase().includes(search) || (p.proveedor || '').toLowerCase().includes(search)
  );
  const count = document.getElementById('prod-count');
  if (count) count.textContent = prods.length + ' producto' + (prods.length !== 1 ? 's' : '');
  const tbody = document.getElementById('prod-tbody');
  const empty = document.getElementById('prod-empty');
  if (!tbody) return;
  if (prods.length === 0) { empty.style.display = 'block'; tbody.innerHTML = ''; return; }
  empty.style.display = 'none';
  tbody.innerHTML = filtered.map(p => `
    <tr>
      <td style="font-size:13px; font-weight:600;">${p.nombre}</td>
      <td style="font-size:12px; color:var(--muted);">${p.proveedor || '‚Äî'}</td>
      <td style="text-align:center;">
        <span class="badge badge-unit">${(p.componentes || []).length} mat.</span>
      </td>
      <td style="font-family:var(--font-mono); font-size:14px; font-weight:700; color:var(--col-sale); text-align:right;">
        ${(p.componentes || []).length > 0 ? '$' + fmtN(p.costoTotal) : '<span style="color:var(--muted2); font-size:11px;">sin ficha</span>'}
      </td>
      <td style="font-size:11px; color:var(--muted2);">${p.actualizadoEn || '‚Äî'}</td>
      <td style="display:flex; gap:6px; justify-content:flex-end;">
        <button class="btn btn-primary" style="font-size:11px; padding:4px 12px;" onclick="openFicha('${p.id}')">üìã Ficha</button>
        <button class="del-btn" onclick="deleteProducto('${p.id}')">√ó</button>
      </td>
    </tr>
  `).join('') || `<tr><td colspan="6" style="padding:20px; text-align:center; color:var(--muted);">Sin resultados</td></tr>`;
}

// ============================================================
// FICHA T√âCNICA
// ============================================================
function openFicha(id) {
  // Wait a tick so Firestore listeners have time to populate if brand new
  setTimeout(() => {
    fichaActivaId = id;
    const p = productosDB[id];
    const nombre = p ? p.nombre : '...';
    document.getElementById('ficha-titulo').textContent = nombre;
    refreshFichaSelect();
    renderFichaComponentes();
    document.getElementById('ficha-modal').classList.add('open');
  }, 100);
}

function closeFicha() {
  document.getElementById('ficha-modal').classList.remove('open');
  fichaActivaId = null;
}

function refreshFichaSelect() {
  const sel = document.getElementById('ficha-mat-sel');
  if (!sel) return;
  const current = sel.value;
  sel.innerHTML = '<option value="">‚Äî Seleccion√° un material ‚Äî</option>' +
    Object.values(materialesDB).map(m =>
      `<option value="${m.id}">${m.nombre} (${m.unidad}) ‚Äî $${fmtDec(m.costo)}/${m.unidad}</option>`
    ).join('');
  sel.value = current;
}

function updateCantLabel() {
  const sel = document.getElementById('ficha-mat-sel');
  const mat = materialesDB[sel.value];
  document.getElementById('ficha-cant-label').textContent = mat ? `Cantidad (${mat.unidad})` : 'Cantidad';
}

async function addComponente() {
  const p = productosDB[fichaActivaId];
  if (!p) return;
  const matId = document.getElementById('ficha-mat-sel').value;
  const cant  = parseFloat(document.getElementById('ficha-cant').value);
  const mat   = materialesDB[matId];
  if (!mat)        { toast('Seleccion√° un material', ''); return; }
  if (!cant || cant <= 0) { toast('Ingres√° una cantidad v√°lida', ''); return; }

  const comps = [...(p.componentes || [])];
  const idx   = comps.findIndex(c => c.materialId === matId);
  if (idx >= 0) {
    comps[idx] = { ...comps[idx], cantidad: cant, costoUnit: mat.costo };
  } else {
    comps.push({ materialId: matId, nombre: mat.nombre, unidad: mat.unidad, cantidad: cant, costoUnit: mat.costo });
  }
  const costoTotal = comps.reduce((s, c) => s + c.cantidad * c.costoUnit, 0);
  try {
    await window.fbUpdateDoc(window.fbDoc(window.db, 'productos', fichaActivaId), {
      componentes: comps, costoTotal, actualizadoEn: new Date().toLocaleDateString('es-AR')
    });
    document.getElementById('ficha-cant').value = '';
    document.getElementById('ficha-mat-sel').value = '';
    document.getElementById('ficha-cant-label').textContent = 'Cantidad';
    toast('‚úì Material agregado', 'success');
  } catch(e) { toast('Error: ' + e.message, ''); }
}

async function removeComponente(materialId) {
  const p = productosDB[fichaActivaId];
  if (!p) return;
  const comps     = (p.componentes || []).filter(c => c.materialId !== materialId);
  const costoTotal = comps.reduce((s, c) => s + c.cantidad * c.costoUnit, 0);
  try {
    await window.fbUpdateDoc(window.fbDoc(window.db, 'productos', fichaActivaId), {
      componentes: comps, costoTotal, actualizadoEn: new Date().toLocaleDateString('es-AR')
    });
  } catch(e) { toast('Error: ' + e.message, ''); }
}

async function updateCantidad(materialId, nuevaCant) {
  const p    = productosDB[fichaActivaId];
  if (!p) return;
  const comps = (p.componentes || []).map(c =>
    c.materialId === materialId ? { ...c, cantidad: parseFloat(nuevaCant) || 0 } : c
  );
  const costoTotal = comps.reduce((s, c) => s + c.cantidad * c.costoUnit, 0);
  try {
    await window.fbUpdateDoc(window.fbDoc(window.db, 'productos', fichaActivaId), {
      componentes: comps, costoTotal, actualizadoEn: new Date().toLocaleDateString('es-AR')
    });
  } catch(e) { toast('Error: ' + e.message, ''); }
}

function renderFichaComponentes() {
  const p = productosDB[fichaActivaId];
  if (!p) return;
  const comps = p.componentes || [];
  const tbody = document.getElementById('ficha-tbody');
  const empty = document.getElementById('ficha-empty');
  document.getElementById('ficha-costo-total').textContent = comps.length > 0 ? '$' + fmtN(p.costoTotal) : '$0';

  if (comps.length === 0) { empty.style.display = 'block'; tbody.innerHTML = ''; return; }
  empty.style.display = 'none';
  tbody.innerHTML = comps.map(c => `
    <tr>
      <td style="font-size:13px;">${c.nombre}</td>
      <td style="text-align:center;"><span class="badge badge-unit">${c.unidad}</span></td>
      <td style="text-align:center;">
        <input type="number" value="${c.cantidad}" min="0" step="0.01"
          style="width:80px; background:var(--surface2); border:1px solid var(--border); border-radius:4px; color:var(--text); padding:4px 6px; font-family:var(--font-mono); font-size:12px; text-align:center; outline:none;"
          onchange="updateCantidad('${c.materialId}', this.value)"
          onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
      </td>
      <td style="font-family:var(--font-mono); font-size:12px; color:var(--col-cost); text-align:right;">
        $${fmtDec(c.costoUnit)}<span style="color:var(--muted); font-size:10px;">/${c.unidad}</span>
      </td>
      <td style="font-family:var(--font-mono); font-size:13px; font-weight:600; color:var(--col-cost); text-align:right;">
        $${fmtN(c.cantidad * c.costoUnit)}
      </td>
      <td><button class="del-btn" onclick="removeComponente('${c.materialId}')">√ó</button></td>
    </tr>
  `).join('');
}

// Close modal on backdrop click
document.getElementById('ficha-modal').addEventListener('click', e => {
  if (e.target === document.getElementById('ficha-modal')) closeFicha();
});

// Enter key on material name
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('mat-nombre')?.addEventListener('keydown', e => { if (e.key === 'Enter') addMaterial(); });
  document.getElementById('prod-nombre')?.addEventListener('keydown', e => { if (e.key === 'Enter') addProducto(); });
  document.getElementById('ficha-cant')?.addEventListener('keydown', e => { if (e.key === 'Enter') addComponente(); });
});

// ============================================================
// CSV IMPORT
// ============================================================
let csvParsed = [];

function closeCsvModal() {
  document.getElementById('csv-modal').style.display = 'none';
  document.getElementById('csv-file').value = '';
  document.getElementById('csv-preview').style.display = 'none';
  document.getElementById('csv-result').style.display = 'none';
  document.getElementById('csv-import-btn').style.display = 'none';
  csvParsed = [];
}

function previewCsv(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const text = e.target.result;
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    csvParsed = [];
    // Saltear la primera fila si es encabezado
    const startLine = lines[0].toLowerCase().includes('nombre') ? 1 : 0;

    lines.slice(startLine).forEach(line => {
      // Soporte para separador coma o punto y coma
      const sep = line.includes(';') ? ';' : ',';
      const parts = line.split(sep).map(p => p.trim().replace(/^["']|["']$/g, ''));
      if (parts.length < 2) return;
      const nombre = parts[0];
      const unidad = parts[1] || 'unidad';
      // Limpiar el costo: sacar $, espacios y puntos de miles, reemplazar coma decimal por punto
      const costoRaw = (parts[2] || '0').replace(/\$/g, '').replace(/\s/g, '').replace(/\./g, '').replace(/,/g, '.');
      const costo  = parseFloat(costoRaw) || 0;
      if (!nombre) return;
      csvParsed.push({ nombre, unidad, costo });
    });

    const tbody = document.getElementById('csv-preview-body');
    tbody.innerHTML = csvParsed.map(r => {
      const existe = Object.values(materialesDB).find(m => m.nombre.toLowerCase() === r.nombre.toLowerCase());
      const accion = existe
        ? `<span style="color:var(--warn); font-size:10px; font-weight:700;">ACTUALIZAR</span>`
        : `<span style="color:var(--accent); font-size:10px; font-weight:700;">CREAR</span>`;
      return `<tr style="border-bottom:1px solid rgba(42,42,56,0.3);">
        <td style="padding:6px 12px;">${r.nombre}</td>
        <td style="padding:6px 12px; color:var(--muted);">${r.unidad}</td>
        <td style="padding:6px 12px; text-align:right; font-family:var(--font-mono); color:var(--col-cost);">$${fmtN(r.costo)}</td>
        <td style="padding:6px 12px; text-align:center;">${accion}</td>
      </tr>`;
    }).join('');

    document.getElementById('csv-preview-title').textContent = csvParsed.length + ' materiales detectados';
    document.getElementById('csv-preview').style.display = 'block';
    document.getElementById('csv-import-btn').style.display = csvParsed.length > 0 ? 'inline-flex' : 'none';
  };
  reader.readAsText(file, 'UTF-8');
}

async function importCsv() {
  if (csvParsed.length === 0) return;
  const btn = document.getElementById('csv-import-btn');
  btn.textContent = '‚è≥ Importando...';
  btn.disabled = true;

  let creados = 0, actualizados = 0, errores = 0;

  for (const r of csvParsed) {
    try {
      const existe = Object.values(materialesDB).find(m => m.nombre.toLowerCase() === r.nombre.toLowerCase());
      if (existe) {
        await window.fbUpdateDoc(window.fbDoc(window.db, 'materiales', existe.id), {
          unidad: r.unidad,
          costo:  r.costo,
          updatedAt: new Date().toISOString(),
        });
        actualizados++;
      } else {
        await window.fbAddDoc(window.fbCollection(window.db, 'materiales'), {
          nombre: r.nombre,
          unidad: r.unidad,
          costo:  r.costo,
          createdAt: new Date().toISOString(),
        });
        creados++;
      }
    } catch(e) { errores++; }
  }

  const res = document.getElementById('csv-result');
  res.style.display = 'block';
  res.style.background = errores === 0 ? 'rgba(232,200,0,0.08)' : 'rgba(255,87,87,0.08)';
  res.style.border = errores === 0 ? '1px solid rgba(232,200,0,0.3)' : '1px solid rgba(255,87,87,0.3)';
  res.style.color = errores === 0 ? 'var(--accent)' : 'var(--danger)';
  res.innerHTML = `‚úì Importaci√≥n completada ‚Äî <strong>${creados} creados</strong>, <strong>${actualizados} actualizados</strong>${errores > 0 ? `, <strong>${errores} errores</strong>` : ''}`;

  btn.textContent = '‚úì Listo';
  setTimeout(() => closeCsvModal(), 1500);
}
function fmtN(n) {
  if (isNaN(n) || n === undefined) return '0';
  return Math.round(n).toLocaleString('es-AR');
}
function fmtDec(n) {
  if (isNaN(n) || n === undefined) return '0,00';
  return parseFloat(n).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function toast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show ' + (type || '');
  setTimeout(() => t.classList.remove('show'), 3000);
}

function toggleTheme() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') === 'dark';
  html.setAttribute('data-theme', isDark ? 'light' : 'dark');
  const btn = document.getElementById('theme-btn');
  if (btn) btn.textContent = isDark ? 'üåô Oscuro' : '‚òÄÔ∏è Claro';
  localStorage.setItem('piola-theme', isDark ? 'light' : 'dark');
}
const savedTheme = localStorage.getItem('piola-theme');
if (savedTheme) {
  document.documentElement.setAttribute('data-theme', savedTheme);
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('theme-btn');
    if (btn) btn.textContent = savedTheme === 'light' ? 'üåô Oscuro' : '‚òÄÔ∏è Claro';
  });
}

</script>
</body>
</html>
