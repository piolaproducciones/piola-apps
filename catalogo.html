<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cat√°logo ¬∑ Piola</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,700;0,800;1,700;1,800&family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root[data-theme="dark"] {
    --bg:#0c0c0f; --surface:#141418; --surface2:#1c1c22; --surface3:#222228;
    --border:#2a2a38; --text:#e8e8f0; --muted:#6b6b80; --muted2:#4a4a5a;
    --accent:#e8c800; --danger:#ff5757; --warn:#ffaa33;
    --col-cost:#ff8fa3; --col-sale:#e8c800;
    --radius:8px; --font-body:'Syne',sans-serif; --font-mono:'DM Mono',monospace; --font-display:'Barlow Condensed',sans-serif;
  }
  :root[data-theme="light"] {
    --bg:#f0f0f5; --surface:#ffffff; --surface2:#f4f4f8; --surface3:#eaeaf0;
    --border:#dcdce8; --text:#1a1a2e; --muted:#70708a; --muted2:#a0a0b8;
    --accent:#b89a00; --danger:#cc2200; --warn:#cc7700;
    --col-cost:#c0003a; --col-sale:#7a6200;
    --radius:8px; --font-body:'Syne',sans-serif; --font-mono:'DM Mono',monospace; --font-display:'Barlow Condensed',sans-serif;
  }
  * { box-sizing:border-box; margin:0; padding:0; }
  body { background:var(--bg); color:var(--text); font-family:var(--font-body); font-size:13px; min-height:100vh; }

  /* TOPBAR */
  .topbar { background:var(--surface); border-bottom:1px solid var(--border); padding:0 28px; height:54px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
  .logo { font-family:var(--font-display); font-size:22px; color:var(--text); }
  .logo span { color:var(--accent); }
  .logo .role { font-family:var(--font-mono); font-size:10px; color:var(--muted); margin-left:10px; letter-spacing:1px; text-transform:uppercase; }
  .topbar-right { display:flex; align-items:center; gap:12px; }
  #fb-status { font-family:var(--font-mono); font-size:10px; color:var(--muted); }

  /* TOOLBAR */
  .toolbar { background:var(--surface); border-bottom:1px solid var(--border); padding:10px 28px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .search-wrap { position:relative; flex:1; min-width:200px; max-width:320px; }
  .search-wrap input { background:var(--surface2); border:1px solid var(--border); border-radius:6px; color:var(--text); padding:7px 12px 7px 32px; font-family:var(--font-body); font-size:12px; outline:none; width:100%; transition:border-color 0.2s; }
  .search-wrap input:focus { border-color:var(--accent); }
  .search-wrap::before { content:'üîç'; position:absolute; left:10px; top:50%; transform:translateY(-50%); font-size:12px; pointer-events:none; }
  .cat-filters { display:flex; gap:6px; flex-wrap:wrap; flex:1; }
  .cat-btn { background:var(--surface2); border:1px solid var(--border); border-radius:20px; padding:5px 12px; font-family:var(--font-body); font-size:11px; font-weight:600; color:var(--muted); cursor:pointer; transition:all 0.15s; white-space:nowrap; }
  .cat-btn:hover { border-color:var(--accent); color:var(--accent); }
  .cat-btn.active { background:rgba(232,200,0,0.12); border-color:var(--accent); color:var(--accent); }

  /* BTN */
  .btn { padding:8px 16px; border-radius:6px; border:none; cursor:pointer; font-family:var(--font-body); font-size:12px; font-weight:600; transition:all 0.2s; display:inline-flex; align-items:center; gap:6px; }
  .btn-primary { background:var(--accent); color:#0c0c0f; }
  .btn-primary:hover { opacity:0.88; }
  .btn-secondary { background:var(--surface2); color:var(--text); border:1px solid var(--border); }
  .btn-secondary:hover { border-color:var(--accent); color:var(--accent); }
  .btn-sm { padding:5px 10px; font-size:11px; }

  /* MAIN GRID */
  .main { padding:24px 28px; }
  .grid-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
  .grid-header h2 { font-family:var(--font-display); font-size:18px; font-weight:700; }
  .grid-count { font-family:var(--font-mono); font-size:11px; color:var(--muted); }

  .cards-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(220px,1fr)); gap:16px; }

  /* PRODUCT CARD */
  .prod-card {
    background:var(--surface); border:1px solid var(--border); border-radius:10px;
    overflow:hidden; cursor:pointer; transition:all 0.2s;
    display:flex; flex-direction:column;
  }
  .prod-card:hover { border-color:var(--accent); transform:translateY(-2px); box-shadow:0 6px 24px rgba(0,0,0,0.3); }
  .prod-card.sin-stock { opacity:0.5; }
  .prod-card.sin-stock:hover { opacity:0.7; }
  .card-img { width:100%; height:160px; object-fit:cover; background:var(--surface2); display:block; }
  .card-img-placeholder { width:100%; height:160px; background:var(--surface2); display:flex; align-items:center; justify-content:center; font-size:36px; color:var(--muted2); }
  .card-body { padding:12px; flex:1; display:flex; flex-direction:column; gap:6px; }
  .card-code { font-family:var(--font-mono); font-size:10px; color:var(--muted); letter-spacing:0.5px; }
  .card-name { font-size:13px; font-weight:700; line-height:1.3; }
  .card-cat { display:inline-block; background:var(--surface3); border:1px solid var(--border); border-radius:10px; padding:2px 8px; font-size:10px; font-weight:600; color:var(--muted); font-family:var(--font-mono); letter-spacing:0.3px; }
  .card-variants { display:flex; flex-direction:column; gap:3px; margin-top:4px; }
  .variant-row { display:flex; justify-content:space-between; align-items:center; font-size:11px; }
  .variant-name { color:var(--muted); font-size:10px; }
  .variant-price { font-family:var(--font-mono); font-size:11px; color:var(--col-sale); font-weight:500; }
  .variant-stock { font-family:var(--font-mono); font-size:10px; padding:1px 6px; border-radius:8px; }
  .variant-stock.ok { background:rgba(87,255,143,0.1); color:#57ff8f; border:1px solid rgba(87,255,143,0.2); }
  .variant-stock.low { background:rgba(255,170,51,0.1); color:var(--warn); border:1px solid rgba(255,170,51,0.2); }
  .variant-stock.out { background:rgba(255,87,87,0.1); color:var(--danger); border:1px solid rgba(255,87,87,0.2); }
  .card-actions { padding:10px 12px; border-top:1px solid var(--border); display:flex; gap:6px; justify-content:flex-end; }

  /* EMPTY / LOADING */
  .empty-state { padding:60px; text-align:center; color:var(--muted); }
  .empty-state .icon { font-size:40px; margin-bottom:12px; }
  .loading { display:flex; align-items:center; gap:10px; color:var(--muted); font-size:12px; padding:40px; justify-content:center; }
  .spinner { width:16px; height:16px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.8s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }

  /* MODAL */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:200; display:flex; align-items:center; justify-content:center; padding:20px; }
  .modal-overlay.hidden { display:none; }
  .modal-box { background:var(--surface); border:1px solid var(--border); border-radius:12px; width:680px; max-width:95vw; max-height:90vh; overflow-y:auto; }
  .modal-header { padding:16px 24px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:var(--surface2); position:sticky; top:0; z-index:10; }
  .modal-title { font-family:var(--font-display); font-size:18px; font-weight:700; }
  .modal-close { background:none; border:none; color:var(--muted); font-size:22px; cursor:pointer; line-height:1; padding:4px 8px; border-radius:4px; transition:all 0.15s; }
  .modal-close:hover { color:var(--danger); background:rgba(255,87,87,0.1); }
  .modal-body { padding:24px; display:flex; flex-direction:column; gap:20px; }
  .modal-footer { padding:16px 24px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; background:var(--surface2); position:sticky; bottom:0; }

  /* FORM */
  .form-row { display:grid; gap:14px; }
  .form-row.cols2 { grid-template-columns:1fr 1fr; }
  .form-row.cols3 { grid-template-columns:1fr 1fr 1fr; }
  .form-group { display:flex; flex-direction:column; gap:5px; }
  .form-group label { font-size:10px; font-weight:700; letter-spacing:0.8px; text-transform:uppercase; color:var(--muted); }
  .form-control { background:var(--surface2); border:1px solid var(--border); border-radius:6px; color:var(--text); padding:8px 12px; font-family:var(--font-body); font-size:13px; outline:none; transition:border-color 0.2s; width:100%; }
  .form-control:focus { border-color:var(--accent); }
  select.form-control option { background:var(--surface2); }
  textarea.form-control { resize:vertical; min-height:72px; }

  /* VARIANT EDITOR */
  .variant-editor { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:14px; display:flex; flex-direction:column; gap:10px; }
  .variant-editor-header { display:flex; justify-content:space-between; align-items:center; }
  .variant-label { font-size:10px; font-weight:700; letter-spacing:0.8px; text-transform:uppercase; color:var(--accent); }
  .variant-fields { display:grid; grid-template-columns:2fr 1fr 1fr; gap:10px; }

  /* PHOTO UPLOAD */
  .photo-upload { border:2px dashed var(--border); border-radius:8px; padding:20px; text-align:center; cursor:pointer; transition:all 0.2s; position:relative; overflow:hidden; }
  .photo-upload:hover { border-color:var(--accent); }
  .photo-upload input { position:absolute; inset:0; opacity:0; cursor:pointer; }
  .photo-upload img { width:100%; max-height:160px; object-fit:contain; border-radius:6px; display:block; }
  .photo-upload .ph-text { color:var(--muted); font-size:12px; }
  .photo-upload .ph-icon { font-size:28px; margin-bottom:6px; }

  /* DETAIL MODAL */
  .detail-img { width:100%; max-height:300px; object-fit:contain; background:var(--surface2); border-radius:8px; display:block; }
  .detail-img-placeholder { width:100%; height:200px; background:var(--surface2); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:48px; color:var(--muted2); }
  .detail-variants { display:flex; flex-direction:column; gap:8px; }
  .detail-variant-row { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:12px 16px; display:grid; grid-template-columns:2fr 1fr 1fr; align-items:center; gap:12px; }
  .detail-variant-name { font-size:13px; font-weight:600; }
  .detail-variant-price { font-family:var(--font-mono); font-size:15px; color:var(--col-sale); font-weight:500; }
  .detail-variant-stock { text-align:right; }
  .stock-badge { display:inline-block; font-family:var(--font-mono); font-size:11px; padding:3px 10px; border-radius:10px; font-weight:700; }

  /* STOCK EDIT */
  .stock-input { background:var(--surface3); border:1px solid var(--border); border-radius:4px; color:var(--text); padding:4px 8px; font-family:var(--font-mono); font-size:12px; width:80px; outline:none; text-align:center; }
  .stock-input:focus { border-color:var(--accent); }

  /* CAT MANAGER */
  .cat-list { display:flex; flex-direction:column; gap:6px; }
  .cat-item { background:var(--surface2); border:1px solid var(--border); border-radius:6px; padding:8px 12px; display:flex; justify-content:space-between; align-items:center; font-size:12px; }

  /* TOAST */
  .toast-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:500; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.2s; }
  .toast-overlay.show { opacity:1; pointer-events:all; }
  .toast-box { background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius); padding:24px 28px; min-width:280px; max-width:400px; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,0.4); display:flex; flex-direction:column; gap:14px; }
  .toast-box.success { border-color:rgba(232,200,0,0.5); }
  .toast-box.error   { border-color:rgba(255,87,87,0.5); }
  .toast-msg { font-size:14px; line-height:1.5; }
  .toast-close { background:var(--accent); color:#0c0c0f; border:none; border-radius:6px; padding:8px 24px; font-family:var(--font-body); font-size:13px; font-weight:700; cursor:pointer; align-self:center; }
  .toast-close:hover { opacity:0.85; }

  /* THEME */
  /* TABS */
  .main-tabs { background:var(--surface); border-bottom:1px solid var(--border); padding:0 28px; display:flex; gap:2px; }
  .main-tab { padding:11px 20px; font-size:12px; font-weight:600; letter-spacing:0.8px; text-transform:uppercase; color:var(--muted); cursor:pointer; border-bottom:2px solid transparent; transition:all 0.2s; white-space:nowrap; }
  .main-tab:hover { color:var(--text); }
  .main-tab.active { color:var(--accent); border-bottom-color:var(--accent); }
  .view-section { display:none; }
  .view-section.active { display:block; }

  /* MOVIMIENTOS */
  .mov-layout { display:grid; grid-template-columns:360px 1fr; gap:20px; padding:24px 28px; align-items:start; }
  .mov-form-panel { background:var(--surface); border:1px solid var(--border); border-radius:10px; overflow:hidden; position:sticky; top:70px; }
  .mov-form-header { background:var(--surface2); padding:14px 18px; border-bottom:1px solid var(--border); font-size:11px; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--muted); }
  .mov-form-body { padding:18px; display:flex; flex-direction:column; gap:14px; }
  .mov-history-panel { background:var(--surface); border:1px solid var(--border); border-radius:10px; overflow:hidden; }
  .mov-history-header { background:var(--surface2); padding:14px 18px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
  .mov-history-title { font-size:11px; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--muted); }
  .mov-row { display:grid; grid-template-columns:90px 1fr 1fr 70px 1fr; gap:10px; padding:12px 18px; border-bottom:1px solid rgba(42,42,56,0.5); align-items:center; font-size:12px; transition:background 0.15s; }
  .mov-row:hover { background:rgba(255,255,255,0.02); }
  .mov-row-header { background:var(--surface2); font-size:9px; font-weight:700; letter-spacing:0.8px; text-transform:uppercase; color:var(--muted); }
  .mov-row-header:hover { background:var(--surface2); }
  .mov-tipo { display:inline-flex; align-items:center; gap:4px; font-family:var(--font-mono); font-size:10px; padding:2px 8px; border-radius:10px; font-weight:700; white-space:nowrap; }
  .mov-entrada { background:rgba(87,255,143,0.1); color:#57ff8f; border:1px solid rgba(87,255,143,0.25); }
  .mov-salida  { background:rgba(255,87,87,0.1);  color:var(--danger); border:1px solid rgba(255,87,87,0.25); }
  .mov-qty { font-family:var(--font-mono); font-size:13px; font-weight:700; text-align:center; }
  .mov-qty.entrada { color:#57ff8f; }
  .mov-qty.salida  { color:var(--danger); }
  .mov-obs { font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .mov-filters { display:flex; gap:8px; padding:10px 18px; border-bottom:1px solid var(--border); background:var(--surface2); flex-wrap:wrap; }
  .mov-filter-input { background:var(--surface3); border:1px solid var(--border); border-radius:6px; color:var(--text); padding:5px 10px; font-family:var(--font-body); font-size:11px; outline:none; transition:border-color 0.2s; }
  .mov-filter-input:focus { border-color:var(--accent); }

  @media(max-width:800px) { .mov-layout { grid-template-columns:1fr; } }

  .theme-btn { background:var(--surface2); border:1px solid var(--border); color:var(--muted); border-radius:6px; padding:6px 12px; font-family:var(--font-body); font-size:11px; font-weight:600; cursor:pointer; transition:all 0.2s; }
  .theme-btn:hover { border-color:var(--accent); color:var(--accent); }

  @media(max-width:600px) {
    .cards-grid { grid-template-columns:repeat(auto-fill, minmax(160px,1fr)); }
    .main { padding:16px; }
    .toolbar { padding:10px 16px; }
  }
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="logo">
    <a href="index.html" style="text-decoration:none; color:inherit;">Piola <span>¬∑</span></a>
    <span class="role">Cat√°logo</span>
  </div>
  <div class="topbar-right">
    <span id="topbar-catalogo-btns" style="display:inline-flex; gap:8px; align-items:center;">
      <button class="btn btn-secondary btn-sm" onclick="openCatManager()">‚öô Categor√≠as</button>
      <button class="btn btn-secondary btn-sm" onclick="openBulkModal()">‚¨Ü Carga masiva</button>
      <button class="btn btn-primary btn-sm" onclick="openProductForm()">+ Nuevo producto</button>
    </span>
    <button class="theme-btn" onclick="toggleTheme()" id="theme-btn">‚òÄÔ∏è Claro</button>
    <span id="fb-status">üü° conectando...</span>
  </div>
</div>

<!-- MAIN TABS -->
<div class="main-tabs">
  <div class="main-tab active" onclick="switchTab('catalogo', this)">üì¶ Cat√°logo</div>
  <div class="main-tab" onclick="switchTab('movimientos', this)">üìã Movimientos</div>
</div>

<!-- TOOLBAR (catalogo only) -->
<div class="toolbar">
  <div class="search-wrap">
    <input type="text" id="search-input" placeholder="Buscar por nombre o c√≥digo..." oninput="renderGrid()">
  </div>
  <div class="cat-filters" id="cat-filters">
    <button class="cat-btn active" data-cat="" onclick="selectCat(this)">Todos</button>
  </div>
</div>

<!-- MAIN -->
<div class="view-section active" id="section-catalogo">
  <div class="main">
    <div class="grid-header">
      <h2 id="grid-title">Todos los productos</h2>
      <span class="grid-count" id="grid-count">‚Äî</span>
    </div>
    <div id="cat-loading" class="loading"><div class="spinner"></div> Cargando cat√°logo...</div>
    <div class="cards-grid" id="cards-grid"></div>
    <div id="cat-empty" class="empty-state" style="display:none;">
      <div class="icon">üì¶</div>
      No hay productos en esta categor√≠a todav√≠a.
    </div>
  </div>
</div>

<!-- MOVIMIENTOS -->
<div class="view-section" id="section-movimientos">
  <div class="mov-layout">

    <!-- FORM -->
    <div class="mov-form-panel">
      <div class="mov-form-header">Registrar movimiento</div>
      <div class="mov-form-body">

        <div class="form-group">
          <label>Fecha</label>
          <input type="date" class="form-control" id="mov-fecha">
        </div>

        <div class="form-group">
          <label>Tipo de movimiento</label>
          <select class="form-control" id="mov-tipo" onchange="updateMovTipoStyle()">
            <optgroup label="‚Üë Entradas">
              <option value="Producci√≥n nueva">‚Üë Producci√≥n nueva</option>
              <option value="Devoluci√≥n cliente">‚Üë Devoluci√≥n cliente</option>
              <option value="Retorno">‚Üë Retorno</option>
              <option value="Ajuste positivo">‚Üë Ajuste positivo</option>
            </optgroup>
            <optgroup label="‚Üì Salidas">
              <option value="Venta">‚Üì Venta</option>
              <option value="Muestra">‚Üì Muestra</option>
              <option value="Merma / da√±o">‚Üì Merma / da√±o</option>
              <option value="Ajuste negativo">‚Üì Ajuste negativo</option>
            </optgroup>
          </select>
        </div>

        <div class="form-group">
          <label>Producto</label>
          <select class="form-control" id="mov-producto" onchange="updateMovVariantes()">
            <option value="">‚Äî Seleccion√° un producto ‚Äî</option>
          </select>
        </div>

        <div class="form-group">
          <label>Variante</label>
          <select class="form-control" id="mov-variante">
            <option value="">‚Äî Primero eleg√≠ producto ‚Äî</option>
          </select>
        </div>

        <div class="form-group">
          <label>Cantidad</label>
          <input type="number" class="form-control" id="mov-cantidad" min="1" value="1" placeholder="0">
        </div>

        <div class="form-group">
          <label>Campa√±a / Cliente</label>
          <input type="text" class="form-control" id="mov-campana" placeholder="Ej: Campa√±a verano 2025, Cliente XYZ...">
        </div>

        <div class="form-group">
          <label>Observaciones</label>
          <textarea class="form-control" id="mov-obs" placeholder="Notas adicionales..." style="min-height:60px;"></textarea>
        </div>

        <button class="btn btn-primary" style="width:100%;" onclick="saveMovimiento()">‚úì Registrar movimiento</button>
      </div>
    </div>

    <!-- HISTORY -->
    <div class="mov-history-panel">
      <div class="mov-history-header">
        <span class="mov-history-title">Historial de movimientos</span>
        <span id="mov-count" style="font-family:var(--font-mono); font-size:11px; color:var(--muted);">‚Äî</span>
      </div>
      <div class="mov-filters">
        <input type="text" class="mov-filter-input" id="mov-filter-prod" placeholder="Filtrar por producto..." oninput="renderMovimientos()" style="flex:1; min-width:150px;">
        <select class="mov-filter-input" id="mov-filter-tipo" onchange="renderMovimientos()">
          <option value="">Todos los tipos</option>
          <option value="entrada">Solo entradas</option>
          <option value="salida">Solo salidas</option>
        </select>
        <input type="month" class="mov-filter-input" id="mov-filter-mes" onchange="renderMovimientos()">
      </div>
      <div class="mov-row mov-row-header">
        <div>Fecha</div>
        <div>Producto ¬∑ Variante</div>
        <div>Tipo</div>
        <div style="text-align:center;">Cant.</div>
        <div>Campa√±a / Obs.</div>
      </div>
      <div id="mov-tbody"></div>
      <div id="mov-empty" class="empty-state" style="display:none; padding:30px;">
        <div class="icon">üìã</div>
        Sin movimientos registrados todav√≠a.
      </div>
      <div id="mov-loading" class="loading"><div class="spinner"></div> Cargando...</div>
    </div>

  </div>
</div>

<!-- ===== MODAL: PRODUCT FORM ===== -->
<div class="modal-overlay hidden" id="modal-form">
  <div class="modal-box">
    <div class="modal-header">
      <span class="modal-title" id="form-title">Nuevo producto</span>
      <button class="modal-close" onclick="closeProductForm()">√ó</button>
    </div>
    <div class="modal-body">

      <!-- Foto -->
      <div class="form-group">
        <label>Foto del producto</label>
        <div class="photo-upload" id="photo-drop">
          <input type="file" id="photo-input" accept="image/*" onchange="handlePhotoSelect(this)">
          <div id="photo-preview-wrap">
            <div class="ph-icon">üì∑</div>
            <div class="ph-text">Hac√© click para subir una foto</div>
          </div>
        </div>
      </div>

      <!-- C√≥digo, Nombre, Categor√≠a -->
      <div class="form-row cols3">
        <div class="form-group">
          <label>C√≥digo</label>
          <input type="text" class="form-control" id="f-codigo" placeholder="PP001">
        </div>
        <div class="form-group" style="grid-column:span 2;">
          <label>Nombre del producto</label>
          <input type="text" class="form-control" id="f-nombre" placeholder="Ej: Bolsa de tela con cierre">
        </div>
      </div>

      <div class="form-row cols2">
        <div class="form-group">
          <label>Categor√≠a</label>
          <select class="form-control" id="f-categoria"></select>
        </div>
        <div class="form-group">
          <label>Fecha</label>
          <input type="date" class="form-control" id="f-fecha">
        </div>
      </div>

      <!-- Variantes -->
      <div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <label style="font-size:10px; font-weight:700; letter-spacing:0.8px; text-transform:uppercase; color:var(--muted);">Variantes (costos y stock)</label>
          <button class="btn btn-secondary btn-sm" onclick="addVariantRow()" id="btn-add-variant">+ Agregar variante</button>
        </div>
        <div id="variants-container" style="display:flex; flex-direction:column; gap:8px;"></div>
      </div>

      <!-- Ficha t√©cnica y Observaciones -->
      <div class="form-row cols2">
        <div class="form-group">
          <label>Ficha t√©cnica</label>
          <textarea class="form-control" id="f-ficha" placeholder="Medidas, materiales, especificaciones..."></textarea>
        </div>
        <div class="form-group">
          <label>Observaciones</label>
          <textarea class="form-control" id="f-obs" placeholder="Notas internas, condiciones especiales..."></textarea>
        </div>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeProductForm()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveProduct()" id="btn-save-product">üíæ Guardar producto</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: PRODUCT DETAIL ===== -->
<div class="modal-overlay hidden" id="modal-detail">
  <div class="modal-box">
    <div class="modal-header">
      <div>
        <div style="font-family:var(--font-mono); font-size:10px; color:var(--muted); margin-bottom:2px;" id="d-codigo"></div>
        <span class="modal-title" id="d-nombre"></span>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn btn-secondary btn-sm" onclick="editCurrentProduct()">‚úèÔ∏è Editar</button>
        <button class="modal-close" onclick="closeDetail()">√ó</button>
      </div>
    </div>
    <div class="modal-body">
      <div id="d-img-wrap"></div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <span id="d-cat" class="card-cat"></span>
        <span style="font-family:var(--font-mono); font-size:10px; color:var(--muted);" id="d-fecha"></span>
      </div>
      <div>
        <div style="font-size:10px; font-weight:700; letter-spacing:0.8px; text-transform:uppercase; color:var(--muted); margin-bottom:10px;">Variantes y stock</div>
        <div class="detail-variants" id="d-variants"></div>
      </div>
      <div id="d-ficha-wrap" style="display:none;">
        <div style="font-size:10px; font-weight:700; letter-spacing:0.8px; text-transform:uppercase; color:var(--muted); margin-bottom:6px;">Ficha t√©cnica</div>
        <div id="d-ficha" style="font-size:12px; color:var(--text); line-height:1.6; white-space:pre-line;"></div>
      </div>
      <div id="d-obs-wrap" style="display:none;">
        <div style="font-size:10px; font-weight:700; letter-spacing:0.8px; text-transform:uppercase; color:var(--muted); margin-bottom:6px;">Observaciones</div>
        <div id="d-obs" style="font-size:12px; color:var(--muted); line-height:1.6; white-space:pre-line;"></div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; padding-top:8px; border-top:1px solid var(--border);">
        <button class="btn btn-secondary btn-sm" style="color:var(--danger); border-color:rgba(255,87,87,0.3);" onclick="deleteCurrentProduct()">üóë Eliminar</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODAL: CATEGORY MANAGER ===== -->
<div class="modal-overlay hidden" id="modal-cats">
  <div class="modal-box" style="max-width:420px;">
    <div class="modal-header">
      <span class="modal-title">Gesti√≥n de Categor√≠as</span>
      <button class="modal-close" onclick="closeCatManager()">√ó</button>
    </div>
    <div class="modal-body">
      <div style="display:flex; gap:8px;">
        <input type="text" class="form-control" id="new-cat-input" placeholder="Nueva categor√≠a..." onkeydown="if(event.key==='Enter') addCategory()">
        <button class="btn btn-primary" onclick="addCategory()">+ Agregar</button>
      </div>
      <div class="cat-list" id="cat-list"></div>
    </div>
  </div>
</div>


<!-- ===== MODAL: CARGA MASIVA ===== -->
<div class="modal-overlay hidden" id="modal-bulk">
  <div class="modal-box" style="max-width:620px;">
    <div class="modal-header">
      <span class="modal-title">‚¨Ü Carga masiva</span>
      <button class="modal-close" onclick="closeBulkModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div style="font-size:12px; color:var(--muted); line-height:1.8; background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:14px;">
        <strong style="color:var(--text);">Formato por columnas (Excel / Google Sheets):</strong> una fila por variante, con estas columnas:<br>
        <code style="font-family:var(--font-mono); font-size:11px; color:var(--accent);">codigo ¬∑ nombre ¬∑ categoria ¬∑ variante_nombre ¬∑ variante_costo ¬∑ variante_stock ¬∑ ficha ¬∑ observaciones</code><br><br>
        ‚Ä¢ Si un producto tiene varias variantes, repet√≠ el c√≥digo y nombre en cada fila.<br>
        ‚Ä¢ Si el c√≥digo ya existe, <strong style="color:var(--accent);">el producto se actualiza</strong> con los nuevos datos.<br>
        ‚Ä¢ Pod√©s copiar y pegar directo desde Excel o Google Sheets.
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn btn-secondary btn-sm" onclick="downloadTemplate()">‚¨á Descargar plantilla Excel</button>
        <span style="font-size:11px; color:var(--muted);">o peg√° las columnas directamente abajo</span>
      </div>
      <div class="form-group">
        <label>Archivo (CSV o TSV ‚Äî exportado desde Excel/Sheets)</label>
        <input type="file" class="form-control" id="bulk-file-input" accept=".csv,.tsv,.txt" onchange="parseBulkFile(this)">
      </div>
      <div class="form-group">
        <label>O peg√° directamente desde Excel / Google Sheets</label>
        <textarea class="form-control" id="bulk-csv-text" rows="6" placeholder="Copi√° las celdas de tu planilla y peg√° ac√° (Tab entre columnas, Enter entre filas)"></textarea>
      </div>
      <div id="bulk-preview" style="display:none;">
        <div style="font-size:10px; font-weight:700; letter-spacing:0.8px; text-transform:uppercase; color:var(--muted); margin-bottom:8px;">Vista previa</div>
        <div id="bulk-preview-content" style="background:var(--surface2); border:1px solid var(--border); border-radius:6px; padding:12px; font-family:var(--font-mono); font-size:11px; max-height:160px; overflow-y:auto;"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeBulkModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="executeBulkImport()" id="btn-bulk-import" disabled>‚¨Ü Importar productos</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast-overlay" id="toast-overlay" onclick="closeToast()">
  <div class="toast-box" id="toast-box" onclick="event.stopPropagation()">
    <div class="toast-msg" id="toast-msg"></div>
    <button class="toast-close" onclick="closeToast()">Aceptar</button>
  </div>
</div>

<!-- FIREBASE MODULE -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, collection, doc, getDocs, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, setDoc, getDoc, limit } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
// Storage no usado ‚Äî fotos en base64 en Firestore

const firebaseConfig = {
  apiKey: "AIzaSyAQNT8-8Q5v7Tfn9MIy530RSHdZj6Am390",
  authDomain: "piola-cotizador.firebaseapp.com",
  projectId: "piola-cotizador",
  storageBucket: "piola-cotizador.firebasestorage.app",
  messagingSenderId: "881054830595",
  appId: "1:881054830595:web:3d138a4952bba717d63e36"
};

const app  = initializeApp(firebaseConfig);
const db   = getFirestore(app);
window._db  = db;
window._fbCollection = collection;
window._fbDoc = doc;
window._fbAddDoc = addDoc;
window._fbUpdateDoc = updateDoc;
window._fbDeleteDoc = deleteDoc;
window._fbSetDoc = setDoc;
window._fbGetDoc = getDoc;
window._fbOnSnapshot = onSnapshot;
window._fbQuery = query;
window._fbOrderBy = orderBy;

function tryInit() {
  if (typeof initCatalog === 'function') initCatalog();
  else setTimeout(tryInit, 50);
}
window.addEventListener('load', tryInit);
</script>

<script>
// ============================================================
// STATE
// ============================================================
let catalogDB  = {};   // { id: product }
let movimientosDB = {}; // { id: movimiento }
let categorias = [];   // array of strings
let activeCat  = '';
let editingId  = null;
let detailId   = null;
let pendingPhotoFile = null;
let pendingPhotoBase64 = null;

const DEFAULT_CATS = ['Bags','Marroquiner√≠a','Accesorios','Bazar','Oficina','Indumentaria','Lonas / Toallas','Cajas','Tecnolog√≠a','Bebidas'];

// ============================================================
// INIT
// ============================================================
function initCatalog() {
  const fbStatus = document.getElementById('fb-status');

  // Load categories from Firebase config
  window._fbOnSnapshot(
    window._fbDoc(window._db, 'config', 'categorias'),
    snap => {
      if (snap.exists() && snap.data().list) {
        categorias = snap.data().list;
      } else {
        categorias = [...DEFAULT_CATS];
        saveCategorias();
      }
      renderCatFilters();
      renderCatSelect();
    }
  );

  // Load movimientos
  window._fbOnSnapshot(
    window._fbQuery(window._fbCollection(window._db, 'movimientos'), window._fbOrderBy('fecha', 'desc'), window._fbOrderBy('createdAt', 'desc')),
    snap => {
      movimientosDB = {};
      snap.forEach(d => movimientosDB[d.id] = { id: d.id, ...d.data() });
      renderMovimientos();
    }
  );

  // Load products
  window._fbOnSnapshot(
    window._fbQuery(window._fbCollection(window._db, 'catalogo'), window._fbOrderBy('nombre')),
    snap => {
      catalogDB = {};
      snap.forEach(d => catalogDB[d.id] = { id: d.id, ...d.data() });
      renderGrid();
      fbStatus.textContent = 'üü¢ conectado';
      fbStatus.style.color = 'var(--accent)';
      document.getElementById('cat-loading').style.display = 'none';
    },
    err => {
      fbStatus.textContent = 'üî¥ error';
      fbStatus.style.color = 'var(--danger)';
      console.error(err);
    }
  );
}

// ============================================================
// RENDER GRID
// ============================================================
function renderGrid() {
  const search = (document.getElementById('search-input')?.value || '').toLowerCase();
  const grid   = document.getElementById('cards-grid');
  const empty  = document.getElementById('cat-empty');
  const count  = document.getElementById('grid-count');

  let products = Object.values(catalogDB);

  if (activeCat) products = products.filter(p => p.categoria === activeCat);
  if (search)    products = products.filter(p =>
    (p.nombre||'').toLowerCase().includes(search) ||
    (p.codigo||'').toLowerCase().includes(search)
  );

  count.textContent = products.length + ' producto' + (products.length !== 1 ? 's' : '');

  if (products.length === 0) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  grid.innerHTML = products.map(p => {
    const variants = p.variantes || [];
    const totalStock = variants.reduce((s, v) => s + (parseInt(v.stock) || 0), 0);
    const sinStock = totalStock === 0;

    const variantsHtml = variants.map(v => {
      const st = parseInt(v.stock) || 0;
      const cls = st === 0 ? 'out' : st <= 5 ? 'low' : 'ok';
      const lbl = st === 0 ? 'Sin stock' : st + ' u.';
      return `<div class="variant-row">
        <span class="variant-name">${v.nombre || 'Variante'}</span>
        <span class="variant-price">${v.costo ? '$' + fmtN(v.costo) : '‚Äî'}</span>
        <span class="variant-stock ${cls}">${lbl}</span>
      </div>`;
    }).join('');

    const imgHtml = p.fotoUrl
      ? `<img class="card-img" src="${p.fotoUrl}" alt="${p.nombre}" loading="lazy">`
      : `<div class="card-img-placeholder">üì¶</div>`;

    return `<div class="prod-card${sinStock ? ' sin-stock' : ''}" onclick="openDetail('${p.id}')">
      ${imgHtml}
      <div class="card-body">
        <div class="card-code">${p.codigo || ''}</div>
        <div class="card-name">${p.nombre || '‚Äî'}</div>
        <span class="card-cat">${p.categoria || '‚Äî'}</span>
        <div class="card-variants">${variantsHtml}</div>
      </div>
    </div>`;
  }).join('');
}

// ============================================================
// CATEGORY FILTERS
// ============================================================
function renderCatFilters() {
  const wrap = document.getElementById('cat-filters');
  wrap.innerHTML = `<button class="cat-btn${activeCat === '' ? ' active' : ''}" data-cat="" onclick="selectCat(this)">Todos</button>`;
  categorias.forEach(cat => {
    const active = activeCat === cat ? ' active' : '';
    wrap.innerHTML += `<button class="cat-btn${active}" data-cat="${cat}" onclick="selectCat(this)">${cat}</button>`;
  });
}

function selectCat(btn) {
  document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  activeCat = btn.dataset.cat;
  document.getElementById('grid-title').textContent = activeCat || 'Todos los productos';
  renderGrid();
}

function renderCatSelect() {
  const sel = document.getElementById('f-categoria');
  if (!sel) return;
  sel.innerHTML = categorias.map(c => `<option value="${c}">${c}</option>`).join('');
}

// ============================================================
// CATEGORY MANAGER
// ============================================================
function openCatManager() {
  renderCatManagerList();
  document.getElementById('modal-cats').classList.remove('hidden');
}
function closeCatManager() {
  document.getElementById('modal-cats').classList.add('hidden');
}
function renderCatManagerList() {
  document.getElementById('cat-list').innerHTML = categorias.map((cat, i) => `
    <div class="cat-item">
      <span>${cat}</span>
      <button class="btn btn-secondary btn-sm" style="color:var(--danger); border-color:rgba(255,87,87,0.3);" onclick="removeCategory(${i})">√ó</button>
    </div>
  `).join('') || '<div style="color:var(--muted); font-size:12px; padding:8px;">Sin categor√≠as</div>';
}
async function addCategory() {
  const input = document.getElementById('new-cat-input');
  const val = input.value.trim();
  if (!val) return;
  if (categorias.includes(val)) { toast('Ya existe esa categor√≠a', 'error'); return; }
  categorias.push(val);
  await saveCategorias();
  input.value = '';
  renderCatManagerList();
  renderCatFilters();
  renderCatSelect();
}
async function removeCategory(idx) {
  const cat = categorias[idx];
  const inUse = Object.values(catalogDB).some(p => p.categoria === cat);
  if (inUse) { toast(`La categor√≠a "${cat}" tiene productos asignados. Reasignalos antes de eliminarla.`, 'error'); return; }
  if (!confirm(`¬øEliminar la categor√≠a "${cat}"?`)) return;
  categorias.splice(idx, 1);
  await saveCategorias();
  renderCatManagerList();
  renderCatFilters();
  renderCatSelect();
}
async function saveCategorias() {
  await window._fbSetDoc(window._fbDoc(window._db, 'config', 'categorias'), { list: categorias });
}

// ============================================================
// PRODUCT FORM
// ============================================================
function openProductForm(id = null) {
  editingId = id;
  pendingPhotoFile = null;
  pendingPhotoBase64 = null;

  document.getElementById('form-title').textContent = id ? 'Editar producto' : 'Nuevo producto';
  document.getElementById('variants-container').innerHTML = '';

  if (id) {
    const p = catalogDB[id];
    document.getElementById('f-codigo').value  = p.codigo || '';
    document.getElementById('f-nombre').value  = p.nombre || '';
    document.getElementById('f-ficha').value   = p.ficha || '';
    document.getElementById('f-obs').value     = p.obs || '';
    document.getElementById('f-fecha').value   = p.fecha || '';
    document.getElementById('f-categoria').value = p.categoria || categorias[0];
    // Photo preview
    if (p.fotoUrl) {
      document.getElementById('photo-preview-wrap').innerHTML = `<img src="${p.fotoUrl}" style="width:100%; max-height:140px; object-fit:contain; border-radius:6px;">`;
    } else {
      resetPhotoPreview();
    }
    // Variants
    (p.variantes || [{ nombre:'', costo:'', stock:0 }]).forEach(v => addVariantRow(v));
  } else {
    document.getElementById('f-codigo').value  = '';
    document.getElementById('f-nombre').value  = '';
    document.getElementById('f-ficha').value   = '';
    document.getElementById('f-obs').value     = '';
    document.getElementById('f-fecha').value   = new Date().toISOString().split('T')[0];
    document.getElementById('f-categoria').value = categorias[0] || '';
    resetPhotoPreview();
    addVariantRow();
  }

  document.getElementById('modal-form').classList.remove('hidden');
  setTimeout(() => document.getElementById('f-nombre').focus(), 100);
}

function closeProductForm() {
  document.getElementById('modal-form').classList.add('hidden');
  editingId = null;
}

function resetPhotoPreview() {
  document.getElementById('photo-preview-wrap').innerHTML = `
    <div class="ph-icon">üì∑</div>
    <div class="ph-text">Hac√© click para subir una foto</div>`;
}

function handlePhotoSelect(input) {
  const file = input.files[0];
  if (!file) return;
  pendingPhotoFile = file;
  const reader = new FileReader();
  reader.onload = e => {
    // Resize to max 800px wide to keep size manageable
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const MAX = 800;
      let w = img.width, h = img.height;
      if (w > MAX) { h = Math.round(h * MAX / w); w = MAX; }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      pendingPhotoBase64 = canvas.toDataURL('image/jpeg', 0.82);
      document.getElementById('photo-preview-wrap').innerHTML =
        `<img src="${pendingPhotoBase64}" style="width:100%; max-height:140px; object-fit:contain; border-radius:6px;">`;
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// ============================================================
// VARIANT ROWS
// ============================================================
let variantCount = 0;
function addVariantRow(data = {}) {
  const container = document.getElementById('variants-container');
  if (container.children.length >= 3) { toast('M√°ximo 3 variantes por producto', 'error'); return; }
  variantCount++;
  const id = 'vr-' + variantCount;
  const div = document.createElement('div');
  div.className = 'variant-editor';
  div.id = id;
  div.innerHTML = `
    <div class="variant-editor-header">
      <span class="variant-label">Variante ${container.children.length + 1}</span>
      <button class="btn btn-secondary btn-sm" style="color:var(--danger);" onclick="removeVariantRow('${id}')">√ó Quitar</button>
    </div>
    <div class="variant-fields">
      <div class="form-group">
        <label>Nombre de la variante</label>
        <input type="text" class="form-control vr-nombre" placeholder="Ej: Lona, Cordura, Ripstop..." value="${data.nombre || ''}">
      </div>
      <div class="form-group">
        <label>Costo $</label>
        <input type="number" class="form-control vr-costo" placeholder="0" min="0" value="${data.costo || ''}">
      </div>
      <div class="form-group">
        <label>Stock</label>
        <input type="number" class="form-control vr-stock" placeholder="0" min="0" value="${data.stock || 0}">
      </div>
    </div>`;
  container.appendChild(div);
  updateVariantLabels();
}

function removeVariantRow(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
  updateVariantLabels();
}

function updateVariantLabels() {
  const rows = document.querySelectorAll('#variants-container .variant-editor');
  rows.forEach((row, i) => {
    row.querySelector('.variant-label').textContent = 'Variante ' + (i + 1);
  });
  const btn = document.getElementById('btn-add-variant');
  if (btn) btn.style.display = rows.length >= 3 ? 'none' : 'inline-flex';
}

function getVariantsFromForm() {
  const rows = document.querySelectorAll('#variants-container .variant-editor');
  return Array.from(rows).map(row => ({
    nombre: row.querySelector('.vr-nombre').value.trim(),
    costo:  parseFloat(row.querySelector('.vr-costo').value) || 0,
    stock:  parseInt(row.querySelector('.vr-stock').value) || 0,
  })).filter(v => v.nombre || v.costo > 0);
}

// ============================================================
// SAVE PRODUCT
// ============================================================
async function saveProduct() {
  const nombre    = document.getElementById('f-nombre').value.trim();
  const codigo    = document.getElementById('f-codigo').value.trim();
  const categoria = document.getElementById('f-categoria').value;
  const ficha     = document.getElementById('f-ficha').value.trim();
  const obs       = document.getElementById('f-obs').value.trim();
  const fecha     = document.getElementById('f-fecha').value;
  const variantes = getVariantsFromForm();

  if (!nombre) { toast('El nombre del producto es obligatorio', 'error'); return; }
  if (variantes.length === 0) { toast('Agreg√° al menos una variante', 'error'); return; }

  const btn = document.getElementById('btn-save-product');
  btn.disabled = true;
  btn.textContent = '‚è≥ Guardando...';

  try {
    // Usar base64 si hay foto nueva, sino mantener la existente
    let fotoUrl = editingId ? (catalogDB[editingId]?.fotoUrl || '') : '';
    if (pendingPhotoBase64) {
      fotoUrl = pendingPhotoBase64;
    }

    const data = { nombre, codigo, categoria, ficha, obs, fecha, variantes, fotoUrl, updatedAt: new Date().toISOString() };

    if (editingId) {
      await window._fbUpdateDoc(window._fbDoc(window._db, 'catalogo', editingId), data);
      toast('‚úì Producto actualizado', 'success');
    } else {
      data.createdAt = new Date().toISOString();
      await window._fbAddDoc(window._fbCollection(window._db, 'catalogo'), data);
      toast('‚úì Producto agregado al cat√°logo', 'success');
    }
    closeProductForm();
  } catch(e) {
    toast('Error al guardar: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'üíæ Guardar producto';
  }
}

// ============================================================
// DETAIL MODAL
// ============================================================
function openDetail(id) {
  const p = catalogDB[id];
  if (!p) return;
  detailId = id;

  document.getElementById('d-codigo').textContent = p.codigo || '';
  document.getElementById('d-nombre').textContent = p.nombre || '‚Äî';
  document.getElementById('d-cat').textContent    = p.categoria || '‚Äî';
  document.getElementById('d-fecha').textContent  = p.fecha ? 'Cargado: ' + p.fecha : '';

  // Image
  const imgWrap = document.getElementById('d-img-wrap');
  imgWrap.innerHTML = p.fotoUrl
    ? `<img class="detail-img" src="${p.fotoUrl}" alt="${p.nombre}">`
    : `<div class="detail-img-placeholder">üì¶</div>`;

  // Variants
  const varHtml = (p.variantes || []).map((v, vi) => {
    const st  = parseInt(v.stock) || 0;
    const cls = st === 0 ? 'out' : st <= 5 ? 'low' : 'ok';
    const lbl = st === 0 ? 'Sin stock' : st + ' u.';
    const colors = { ok:'rgba(87,255,143,0.1)', low:'rgba(255,170,51,0.1)', out:'rgba(255,87,87,0.1)' };
    const textColors = { ok:'#57ff8f', low:'var(--warn)', out:'var(--danger)' };
    return `<div class="detail-variant-row" style="grid-template-columns:2fr 1fr auto auto;">
      <div class="detail-variant-name">${v.nombre || 'Variante'}</div>
      <div class="detail-variant-price">${v.costo ? '$' + fmtN(v.costo) : '‚Äî'}</div>
      <div style="display:flex; align-items:center; gap:6px;">
        <button onclick="adjustStock('${p.id}',${vi},-1)" style="background:rgba(255,87,87,0.12); border:1px solid rgba(255,87,87,0.3); color:var(--danger); border-radius:4px; width:26px; height:26px; font-size:15px; cursor:pointer; display:flex; align-items:center; justify-content:center; line-height:1;">‚àí</button>
        <span id="stock-val-${vi}" style="font-family:var(--font-mono); font-size:13px; min-width:32px; text-align:center;">${st}</span>
        <button onclick="adjustStock('${p.id}',${vi},+1)" style="background:rgba(87,255,143,0.08); border:1px solid rgba(87,255,143,0.25); color:#57ff8f; border-radius:4px; width:26px; height:26px; font-size:15px; cursor:pointer; display:flex; align-items:center; justify-content:center; line-height:1;">+</button>
      </div>
      <div>
        <span class="stock-badge" style="background:${colors[cls]}; color:${textColors[cls]}; border:1px solid ${textColors[cls]}33;" id="stock-badge-${vi}">${lbl}</span>
      </div>
    </div>`;
  }).join('');
  document.getElementById('d-variants').innerHTML = varHtml;

  // Ficha y obs
  const fichaWrap = document.getElementById('d-ficha-wrap');
  const obsWrap   = document.getElementById('d-obs-wrap');
  if (p.ficha) { fichaWrap.style.display='block'; document.getElementById('d-ficha').textContent=p.ficha; }
  else fichaWrap.style.display='none';
  if (p.obs) { obsWrap.style.display='block'; document.getElementById('d-obs').textContent=p.obs; }
  else obsWrap.style.display='none';

  document.getElementById('modal-detail').classList.remove('hidden');
}

async function adjustStock(productId, variantIdx, delta) {
  const p = catalogDB[productId];
  if (!p) return;
  const variantes = JSON.parse(JSON.stringify(p.variantes || []));
  const v = variantes[variantIdx];
  if (!v) return;
  const newStock = Math.max(0, (parseInt(v.stock) || 0) + delta);
  variantes[variantIdx].stock = newStock;
  // Update local display immediately
  const valEl   = document.getElementById('stock-val-' + variantIdx);
  const badgeEl = document.getElementById('stock-badge-' + variantIdx);
  if (valEl) valEl.textContent = newStock;
  if (badgeEl) {
    const cls = newStock === 0 ? 'out' : newStock <= 5 ? 'low' : 'ok';
    const lbl = newStock === 0 ? 'Sin stock' : newStock + ' u.';
    const colors = { ok:'rgba(87,255,143,0.1)', low:'rgba(255,170,51,0.1)', out:'rgba(255,87,87,0.1)' };
    const textColors = { ok:'#57ff8f', low:'var(--warn)', out:'var(--danger)' };
    badgeEl.style.background = colors[cls];
    badgeEl.style.color = textColors[cls];
    badgeEl.style.border = '1px solid ' + textColors[cls] + '33';
    badgeEl.textContent = lbl;
  }
  // Save to Firebase
  try {
    await window._fbUpdateDoc(window._fbDoc(window._db, 'catalogo', productId), { variantes });
  } catch(e) {
    toast('Error al actualizar stock: ' + e.message, 'error');
  }
}

function closeDetail() {
  document.getElementById('modal-detail').classList.add('hidden');
  detailId = null;
}

function editCurrentProduct() {
  if (!detailId) return;
  const idToEdit = detailId;
  closeDetail();
  openProductForm(idToEdit);
}

async function deleteCurrentProduct() {
  if (!detailId) return;
  const p = catalogDB[detailId];
  if (!confirm(`¬øEliminar "${p.nombre}"? Esta acci√≥n no se puede deshacer.`)) return;
  try {
    // Delete photo from storage if exists
    if (p.fotoUrl) {
      try {
        const photoRef = window._fbRef(window._storage, p.fotoUrl);
        await window._fbDeleteObject(photoRef);
      } catch(e) { /* foto ya no existe, ok */ }
    }
    await window._fbDeleteDoc(window._fbDoc(window._db, 'catalogo', detailId));
    closeDetail();
    toast('Producto eliminado', 'success');
  } catch(e) {
    toast('Error al eliminar: ' + e.message, 'error');
  }
}


// ============================================================
// TAB SWITCHING
// ============================================================
function switchTab(tab, el) {
  document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('section-' + tab).classList.add('active');
  document.getElementById('toolbar-catalogo').style.display = tab === 'catalogo' ? 'flex' : 'none';
  document.getElementById('topbar-catalogo-btns').style.display = tab === 'catalogo' ? 'inline-flex' : 'none';
  if (tab === 'movimientos') {
    populateMovProductos();
    document.getElementById('mov-fecha').value = new Date().toISOString().split('T')[0];
  }
}

// ============================================================
// MOVIMIENTOS ‚Äî FORM
// ============================================================
const TIPOS_ENTRADA = ['Producci√≥n nueva','Devoluci√≥n cliente','Retorno','Ajuste positivo'];

function updateMovTipoStyle() { /* visual only, logic handled by TIPOS_ENTRADA */ }

function populateMovProductos() {
  const sel = document.getElementById('mov-producto');
  const current = sel.value;
  const prods = Object.values(catalogDB).sort((a,b) => (a.nombre||'').localeCompare(b.nombre||''));
  sel.innerHTML = '<option value="">‚Äî Seleccion√° un producto ‚Äî</option>' +
    prods.map(p => `<option value="${p.id}" ${p.id===current?'selected':''}>${p.codigo ? '['+p.codigo+'] ' : ''}${p.nombre}</option>`).join('');
  updateMovVariantes();
}

function updateMovVariantes() {
  const prodId = document.getElementById('mov-producto').value;
  const sel = document.getElementById('mov-variante');
  if (!prodId) { sel.innerHTML = '<option value="">‚Äî Primero eleg√≠ producto ‚Äî</option>'; return; }
  const p = catalogDB[prodId];
  if (!p) return;
  const vars = p.variantes || [];
  if (vars.length === 1) {
    sel.innerHTML = `<option value="0">${vars[0].nombre || 'Variante 1'} (${vars[0].stock || 0} en stock)</option>`;
  } else {
    sel.innerHTML = vars.map((v, i) =>
      `<option value="${i}">${v.nombre || 'Variante '+(i+1)} (${v.stock || 0} en stock)</option>`
    ).join('');
  }
}

async function saveMovimiento() {
  const fecha    = document.getElementById('mov-fecha').value;
  const tipo     = document.getElementById('mov-tipo').value;
  const prodId   = document.getElementById('mov-producto').value;
  const varIdx   = parseInt(document.getElementById('mov-variante').value);
  const cantidad = parseInt(document.getElementById('mov-cantidad').value) || 0;
  const campana  = document.getElementById('mov-campana').value.trim();
  const obs      = document.getElementById('mov-obs').value.trim();

  if (!fecha)   { toast('Seleccion√° una fecha', 'error'); return; }
  if (!prodId)  { toast('Seleccion√° un producto', 'error'); return; }
  if (isNaN(varIdx)) { toast('Seleccion√° una variante', 'error'); return; }
  if (cantidad < 1) { toast('La cantidad debe ser mayor a 0', 'error'); return; }

  const p = catalogDB[prodId];
  if (!p) { toast('Producto no encontrado', 'error'); return; }
  const variantes = JSON.parse(JSON.stringify(p.variantes || []));
  const v = variantes[varIdx];
  if (!v) { toast('Variante no encontrada', 'error'); return; }

  const esEntrada = TIPOS_ENTRADA.includes(tipo);
  const currentStock = parseInt(v.stock) || 0;

  // Validate salida
  if (!esEntrada && cantidad > currentStock) {
    toast(`Stock insuficiente. Solo hay ${currentStock} unidades de "${v.nombre}".`, 'error');
    return;
  }

  const newStock = esEntrada ? currentStock + cantidad : currentStock - cantidad;
  variantes[varIdx].stock = newStock;

  try {
    // Save movimiento
    await window._fbAddDoc(window._fbCollection(window._db, 'movimientos'), {
      fecha, tipo, esEntrada,
      productoId: prodId,
      productoNombre: p.nombre,
      productoCodigo: p.codigo || '',
      varianteIdx: varIdx,
      varianteNombre: v.nombre || 'Variante ' + (varIdx + 1),
      cantidad,
      campana, obs,
      stockAntes: currentStock,
      stockDespues: newStock,
      createdAt: new Date().toISOString()
    });

    // Update stock in product
    await window._fbUpdateDoc(window._fbDoc(window._db, 'catalogo', prodId), { variantes });

    // Reset form
    document.getElementById('mov-cantidad').value = 1;
    document.getElementById('mov-campana').value = '';
    document.getElementById('mov-obs').value = '';
    updateMovVariantes();

    toast(`‚úì Movimiento registrado. Stock de "${v.nombre}": ${currentStock} ‚Üí ${newStock}`, 'success');
  } catch(e) {
    toast('Error al registrar: ' + e.message, 'error');
  }
}

// ============================================================
// MOVIMIENTOS ‚Äî HISTORY
// ============================================================
function renderMovimientos() {
  const tbody   = document.getElementById('mov-tbody');
  const empty   = document.getElementById('mov-empty');
  const loading = document.getElementById('mov-loading');
  const count   = document.getElementById('mov-count');
  const filtProd = (document.getElementById('mov-filter-prod')?.value || '').toLowerCase();
  const filtTipo = document.getElementById('mov-filter-tipo')?.value || '';
  const filtMes  = document.getElementById('mov-filter-mes')?.value || '';

  loading.style.display = 'none';

  let movs = Object.values(movimientosDB).sort((a,b) => {
    if (b.fecha !== a.fecha) return b.fecha.localeCompare(a.fecha);
    return (b.createdAt||'').localeCompare(a.createdAt||'');
  });

  if (filtProd) movs = movs.filter(m =>
    (m.productoNombre||'').toLowerCase().includes(filtProd) ||
    (m.productoCodigo||'').toLowerCase().includes(filtProd)
  );
  if (filtTipo === 'entrada') movs = movs.filter(m => m.esEntrada);
  if (filtTipo === 'salida')  movs = movs.filter(m => !m.esEntrada);
  if (filtMes) movs = movs.filter(m => (m.fecha||'').startsWith(filtMes));

  count.textContent = movs.length + ' movimiento' + (movs.length !== 1 ? 's' : '');

  if (movs.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  tbody.innerHTML = movs.map(m => {
    const cls     = m.esEntrada ? 'entrada' : 'salida';
    const sign    = m.esEntrada ? '+' : '‚àí';
    const tipoCls = m.esEntrada ? 'mov-entrada' : 'mov-salida';
    const prodLabel = (m.productoCodigo ? '['+m.productoCodigo+'] ' : '') + (m.productoNombre||'‚Äî');
    const obs = [m.campana, m.obs].filter(Boolean).join(' ¬∑ ') || '‚Äî';
    const fechaFmt = m.fecha ? m.fecha.split('-').reverse().join('/') : '‚Äî';
    return `<div class="mov-row">
      <div style="font-family:var(--font-mono); font-size:11px; color:var(--muted);">${fechaFmt}</div>
      <div>
        <div style="font-size:12px; font-weight:600;">${prodLabel}</div>
        <div style="font-size:10px; color:var(--muted); margin-top:1px;">${m.varianteNombre||''}</div>
      </div>
      <div><span class="mov-tipo ${tipoCls}">${m.tipo}</span></div>
      <div class="mov-qty ${cls}">${sign}${m.cantidad}</div>
      <div class="mov-obs" title="${obs}">${obs}</div>
    </div>`;
  }).join('');
}

// ============================================================
// BULK IMPORT
// ============================================================
let bulkParsed = [];

function openBulkModal() {
  bulkParsed = [];
  document.getElementById('bulk-file-input').value = '';
  document.getElementById('bulk-csv-text').value = '';
  document.getElementById('bulk-preview').style.display = 'none';
  document.getElementById('btn-bulk-import').disabled = true;
  document.getElementById('modal-bulk').classList.remove('hidden');
}
function closeBulkModal() {
  document.getElementById('modal-bulk').classList.add('hidden');
}

function downloadTemplate() {
  const sep = '\t';
  const header = ['codigo','nombre','categoria','variante_nombre','variante_costo','variante_stock','ficha','observaciones'].join(sep);
  const ex1 = ['PP001','Bolsa de tela','Bags','Lona','15000','10','Medida 40x35cm',''].join(sep);
  const ex2 = ['PP001','Bolsa de tela','Bags','Cordura','18000','5','',''].join(sep);
  const ex3 = ['PP002','Antifaz','Accesorios','Standard','5000','20','','En dep√≥sito principal'].join(sep);
  const blob = new Blob([header + '\n' + ex1 + '\n' + ex2 + '\n' + ex3], { type:'text/tab-separated-values' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'plantilla_catalogo.tsv';
  a.click();
}

function parseBulkFile(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById('bulk-csv-text').value = e.target.result;
    parseBulkCSV(e.target.result);
  };
  reader.readAsText(file, 'UTF-8');
}

document.addEventListener('DOMContentLoaded', () => {
  const ta = document.getElementById('bulk-csv-text');
  if (ta) ta.addEventListener('input', () => parseBulkCSV(ta.value));
});

function parseBulkCSV(raw) {
  const lines = raw.trim().split('\n').map(l => l.trimEnd()).filter(l => l);
  if (lines.length < 1) { bulkParsed = []; showBulkPreview(); return; }

  // Auto-detect separator: tab (from Excel/Sheets) or comma
  const sep = lines[0].includes('\t') ? '\t' : ',';

  // Skip header row if first col looks like a header
  const firstCol = lines[0].split(sep)[0].trim().toLowerCase();
  const start = (firstCol === 'codigo' || firstCol === 'c√≥digo') ? 1 : 0;
  const rows = lines.slice(start);
  if (rows.length === 0) { bulkParsed = []; showBulkPreview(); return; }

  // Group rows by codigo (primary key for upsert)
  const map = {};
  rows.forEach(line => {
    const cols = line.split(sep).map(s => s.trim());
    const [codigo, nombre, categoria, varNombre, varCosto, varStock, ficha, obs] = cols;
    if (!nombre) return;
    const key = codigo || nombre; // use codigo as key if present
    if (!map[key]) {
      map[key] = { codigo: codigo||'', nombre, categoria: categoria||categorias[0]||'', ficha: ficha||'', obs: obs||'', variantes: [], _key: key };
    }
    if (varNombre || varCosto) {
      map[key].variantes.push({ nombre: varNombre||'Variante', costo: parseFloat((varCosto||'0').replace(/[.$]/g,'').replace(',','.')) ||0, stock: parseInt(varStock)||0 });
    }
    // Update ficha/obs if provided in later rows
    if (ficha) map[key].ficha = ficha;
    if (obs)   map[key].obs   = obs;
  });

  bulkParsed = Object.values(map);
  showBulkPreview();
}

function showBulkPreview() {
  const preview = document.getElementById('bulk-preview');
  const content = document.getElementById('bulk-preview-content');
  const btn     = document.getElementById('btn-bulk-import');
  if (bulkParsed.length === 0) {
    preview.style.display = 'none';
    btn.disabled = true;
    return;
  }
  preview.style.display = 'block';
  btn.disabled = false;
  btn.textContent = `‚¨Ü Importar ${bulkParsed.length} producto${bulkParsed.length !== 1 ? 's' : ''}`;
  // Check which ones already exist (by codigo)
  const existingCodigos = {};
  Object.values(catalogDB).forEach(p => { if(p.codigo) existingCodigos[p.codigo] = p.id; });

  content.innerHTML = bulkParsed.map(p => {
    const isUpdate = p.codigo && existingCodigos[p.codigo];
    const tag = isUpdate
      ? `<span style="background:rgba(232,200,0,0.15); color:var(--accent); border:1px solid rgba(232,200,0,0.3); border-radius:4px; padding:1px 6px; font-size:10px; margin-left:6px;">ACTUALIZAR</span>`
      : `<span style="background:rgba(87,255,143,0.1); color:#57ff8f; border:1px solid rgba(87,255,143,0.25); border-radius:4px; padding:1px 6px; font-size:10px; margin-left:6px;">NUEVO</span>`;
    return `<div style="margin-bottom:6px; color:var(--text);">
      <strong>${p.codigo ? '['+p.codigo+'] ' : ''}${p.nombre}</strong>${tag}
      <span style="color:var(--muted);"> ¬∑ ${p.categoria}</span>
      ${p.variantes.map(v => `<span style="color:var(--accent); margin-left:8px;">${v.nombre} $${fmtN(v.costo)} (${v.stock}u)</span>`).join('')}
    </div>`;
  }).join('');
}

async function executeBulkImport() {
  if (bulkParsed.length === 0) return;
  const btn = document.getElementById('btn-bulk-import');
  btn.disabled = true;
  btn.textContent = '‚è≥ Importando...';

  // Build lookup: codigo ‚Üí firebaseId
  const existingCodigos = {};
  Object.values(catalogDB).forEach(p => { if(p.codigo) existingCodigos[p.codigo] = p.id; });

  let created = 0, updated = 0, err = 0;
  for (const p of bulkParsed) {
    try {
      const { _key, ...data } = p;
      data.updatedAt = new Date().toISOString();
      const existingId = p.codigo ? existingCodigos[p.codigo] : null;
      if (existingId) {
        // Update ‚Äî preserve foto
        const existing = catalogDB[existingId];
        data.fotoUrl = existing.fotoUrl || '';
        data.createdAt = existing.createdAt || data.updatedAt;
        await window._fbUpdateDoc(window._fbDoc(window._db, 'catalogo', existingId), data);
        updated++;
      } else {
        data.fotoUrl = '';
        data.createdAt = data.updatedAt;
        await window._fbAddDoc(window._fbCollection(window._db, 'catalogo'), data);
        created++;
      }
    } catch(e) { err++; console.error(e); }
  }
  closeBulkModal();
  const msg = [
    created > 0 ? `${created} creado${created!==1?'s':''}` : '',
    updated > 0 ? `${updated} actualizado${updated!==1?'s':''}` : '',
    err > 0     ? `${err} error${err!==1?'es':''}` : ''
  ].filter(Boolean).join(', ');
  toast(`‚úì ${msg}`, err > 0 ? 'error' : 'success');
}

// ============================================================
// UTILS
// ============================================================
function fmtN(n) {
  if (isNaN(n) || n === null || n === undefined) return '0';
  return Math.round(n).toLocaleString('es-AR');
}

function toast(msg, type) {
  document.getElementById('toast-msg').textContent = msg;
  document.getElementById('toast-box').className = 'toast-box ' + (type || '');
  document.getElementById('toast-overlay').classList.add('show');
}
function closeToast() {
  document.getElementById('toast-overlay').classList.remove('show');
}

function toggleTheme() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') === 'dark';
  html.setAttribute('data-theme', isDark ? 'light' : 'dark');
  document.getElementById('theme-btn').textContent = isDark ? 'üåô Oscuro' : '‚òÄÔ∏è Claro';
  localStorage.setItem('piola-theme', isDark ? 'light' : 'dark');
}
const savedTheme = localStorage.getItem('piola-theme');
if (savedTheme) {
  document.documentElement.setAttribute('data-theme', savedTheme);
  document.getElementById('theme-btn').textContent = savedTheme === 'light' ? 'üåô Oscuro' : '‚òÄÔ∏è Claro';
}
</script>
</body>
</html>
