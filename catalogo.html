<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cat√°logo ¬∑ Piola</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,700;0,800;1,700;1,800&family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root[data-theme="dark"] {
    --bg:#0c0c0f; --surface:#141418; --surface2:#1c1c22; --surface3:#222228;
    --border:#2a2a38; --text:#e8e8f0; --muted:#6b6b80; --muted2:#4a4a5a;
    --accent:#e8c800; --danger:#ff5757; --warn:#ffaa33;
    --col-cost:#ff8fa3; --col-sale:#e8c800;
    --radius:8px; --font-body:'Syne',sans-serif; --font-mono:'DM Mono',monospace; --font-display:'Barlow Condensed',sans-serif;
  }
  :root[data-theme="light"] {
    --bg:#f0f0f5; --surface:#ffffff; --surface2:#f4f4f8; --surface3:#eaeaf0;
    --border:#dcdce8; --text:#1a1a2e; --muted:#70708a; --muted2:#a0a0b8;
    --accent:#b89a00; --danger:#cc2200; --warn:#cc7700;
    --col-cost:#c0003a; --col-sale:#7a6200;
    --radius:8px; --font-body:'Syne',sans-serif; --font-mono:'DM Mono',monospace; --font-display:'Barlow Condensed',sans-serif;
  }
  * { box-sizing:border-box; margin:0; padding:0; }
  body { background:var(--bg); color:var(--text); font-family:var(--font-body); font-size:13px; min-height:100vh; }

  /* TOPBAR */
  .topbar { background:var(--surface); border-bottom:1px solid var(--border); padding:0 28px; height:54px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
  .logo { font-family:var(--font-display); font-size:22px; color:var(--text); }
  .logo span { color:var(--accent); }
  .logo .role { font-family:var(--font-mono); font-size:10px; color:var(--muted); margin-left:10px; letter-spacing:1px; text-transform:uppercase; }
  .topbar-right { display:flex; align-items:center; gap:12px; }
  #fb-status { font-family:var(--font-mono); font-size:10px; color:var(--muted); }

  /* TOOLBAR */
  .toolbar { background:var(--surface); border-bottom:1px solid var(--border); padding:10px 28px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .search-wrap { position:relative; flex:1; min-width:200px; max-width:320px; }
  .search-wrap input { background:var(--surface2); border:1px solid var(--border); border-radius:6px; color:var(--text); padding:7px 12px 7px 32px; font-family:var(--font-body); font-size:12px; outline:none; width:100%; transition:border-color 0.2s; }
  .search-wrap input:focus { border-color:var(--accent); }
  .search-wrap::before { content:'üîç'; position:absolute; left:10px; top:50%; transform:translateY(-50%); font-size:12px; pointer-events:none; }
  .cat-filters { display:flex; gap:6px; flex-wrap:wrap; flex:1; }
  .cat-btn { background:var(--surface2); border:1px solid var(--border); border-radius:20px; padding:5px 12px; font-family:var(--font-body); font-size:11px; font-weight:600; color:var(--muted); cursor:pointer; transition:all 0.15s; white-space:nowrap; }
  .cat-btn:hover { border-color:var(--accent); color:var(--accent); }
  .cat-btn.active { background:rgba(232,200,0,0.12); border-color:var(--accent); color:var(--accent); }

  /* BTN */
  .btn { padding:8px 16px; border-radius:6px; border:none; cursor:pointer; font-family:var(--font-body); font-size:12px; font-weight:600; transition:all 0.2s; display:inline-flex; align-items:center; gap:6px; }
  .btn-primary { background:var(--accent); color:#0c0c0f; }
  .btn-primary:hover { opacity:0.88; }
  .btn-secondary { background:var(--surface2); color:var(--text); border:1px solid var(--border); }
  .btn-secondary:hover { border-color:var(--accent); color:var(--accent); }
  .btn-sm { padding:5px 10px; font-size:11px; }

  /* MAIN GRID */
  .main { padding:24px 28px; }
  .grid-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
  .grid-header h2 { font-family:var(--font-display); font-size:18px; font-weight:700; }
  .grid-count { font-family:var(--font-mono); font-size:11px; color:var(--muted); }

  .cards-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(220px,1fr)); gap:16px; }

  /* PRODUCT CARD */
  .prod-card {
    background:var(--surface); border:1px solid var(--border); border-radius:10px;
    overflow:hidden; cursor:pointer; transition:all 0.2s;
    display:flex; flex-direction:column;
  }
  .prod-card:hover { border-color:var(--accent); transform:translateY(-2px); box-shadow:0 6px 24px rgba(0,0,0,0.3); }
  .prod-card.sin-stock { opacity:0.5; }
  .prod-card.sin-stock:hover { opacity:0.7; }
  .card-img { width:100%; height:160px; object-fit:cover; background:var(--surface2); display:block; }
  .card-img-placeholder { width:100%; height:160px; background:var(--surface2); display:flex; align-items:center; justify-content:center; font-size:36px; color:var(--muted2); }
  .card-body { padding:12px; flex:1; display:flex; flex-direction:column; gap:6px; }
  .card-code { font-family:var(--font-mono); font-size:10px; color:var(--muted); letter-spacing:0.5px; }
  .card-name { font-size:13px; font-weight:700; line-height:1.3; }
  .card-cat { display:inline-block; background:var(--surface3); border:1px solid var(--border); border-radius:10px; padding:2px 8px; font-size:10px; font-weight:600; color:var(--muted); font-family:var(--font-mono); letter-spacing:0.3px; }
  .card-variants { display:flex; flex-direction:column; gap:3px; margin-top:4px; }
  .variant-row { display:flex; justify-content:space-between; align-items:center; font-size:11px; }
  .variant-name { color:var(--muted); font-size:10px; }
  .variant-price { font-family:var(--font-mono); font-size:11px; color:var(--col-sale); font-weight:500; }
  .variant-stock { font-family:var(--font-mono); font-size:10px; padding:1px 6px; border-radius:8px; }
  .variant-stock.ok { background:rgba(87,255,143,0.1); color:#57ff8f; border:1px solid rgba(87,255,143,0.2); }
  .variant-stock.low { background:rgba(255,170,51,0.1); color:var(--warn); border:1px solid rgba(255,170,51,0.2); }
  .variant-stock.out { background:rgba(255,87,87,0.1); color:var(--danger); border:1px solid rgba(255,87,87,0.2); }
  .card-actions { padding:10px 12px; border-top:1px solid var(--border); display:flex; gap:6px; justify-content:flex-end; }

  /* EMPTY / LOADING */
  .empty-state { padding:60px; text-align:center; color:var(--muted); }
  .empty-state .icon { font-size:40px; margin-bottom:12px; }
  .loading { display:flex; align-items:center; gap:10px; color:var(--muted); font-size:12px; padding:40px; justify-content:center; }
  .spinner { width:16px; height:16px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.8s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }

  /* MODAL */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:200; display:flex; align-items:center; justify-content:center; padding:20px; }
  .modal-overlay.hidden { display:none; }
  .modal-box { background:var(--surface); border:1px solid var(--border); border-radius:12px; width:680px; max-width:95vw; max-height:90vh; overflow-y:auto; }
  .modal-header { padding:16px 24px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:var(--surface2); position:sticky; top:0; z-index:10; }
  .modal-title { font-family:var(--font-display); font-size:18px; font-weight:700; }
  .modal-close { background:none; border:none; color:var(--muted); font-size:22px; cursor:pointer; line-height:1; padding:4px 8px; border-radius:4px; transition:all 0.15s; }
  .modal-close:hover { color:var(--danger); background:rgba(255,87,87,0.1); }
  .modal-body { padding:24px; display:flex; flex-direction:column; gap:20px; }
  .modal-footer { padding:16px 24px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; background:var(--surface2); position:sticky; bottom:0; }

  /* FORM */
  .form-row { display:grid; gap:14px; }
  .form-row.cols2 { grid-template-columns:1fr 1fr; }
  .form-row.cols3 { grid-template-columns:1fr 1fr 1fr; }
  .form-group { display:flex; flex-direction:column; gap:5px; }
  .form-group label { font-size:10px; font-weight:700; letter-spacing:0.8px; text-transform:uppercase; color:var(--muted); }
  .form-control { background:var(--surface2); border:1px solid var(--border); border-radius:6px; color:var(--text); padding:8px 12px; font-family:var(--font-body); font-size:13px; outline:none; transition:border-color 0.2s; width:100%; }
  .form-control:focus { border-color:var(--accent); }
  select.form-control option { background:var(--surface2); }
  textarea.form-control { resize:vertical; min-height:72px; }

  /* VARIANT EDITOR */
  .variant-editor { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:14px; display:flex; flex-direction:column; gap:10px; }
  .variant-editor-header { display:flex; justify-content:space-between; align-items:center; }
  .variant-label { font-size:10px; font-weight:700; letter-spacing:0.8px; text-transform:uppercase; color:var(--accent); }
  .variant-fields { display:grid; grid-template-columns:2fr 1fr 1fr; gap:10px; }

  /* PHOTO UPLOAD */
  .photo-upload { border:2px dashed var(--border); border-radius:8px; padding:20px; text-align:center; cursor:pointer; transition:all 0.2s; position:relative; overflow:hidden; }
  .photo-upload:hover { border-color:var(--accent); }
  .photo-upload input { position:absolute; inset:0; opacity:0; cursor:pointer; }
  .photo-upload img { width:100%; max-height:160px; object-fit:contain; border-radius:6px; display:block; }
  .photo-upload .ph-text { color:var(--muted); font-size:12px; }
  .photo-upload .ph-icon { font-size:28px; margin-bottom:6px; }

  /* DETAIL MODAL */
  .detail-img { width:100%; max-height:300px; object-fit:contain; background:var(--surface2); border-radius:8px; display:block; }
  .detail-img-placeholder { width:100%; height:200px; background:var(--surface2); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:48px; color:var(--muted2); }
  .detail-variants { display:flex; flex-direction:column; gap:8px; }
  .detail-variant-row { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:12px 16px; display:grid; grid-template-columns:2fr 1fr 1fr; align-items:center; gap:12px; }
  .detail-variant-name { font-size:13px; font-weight:600; }
  .detail-variant-price { font-family:var(--font-mono); font-size:15px; color:var(--col-sale); font-weight:500; }
  .detail-variant-stock { text-align:right; }
  .stock-badge { display:inline-block; font-family:var(--font-mono); font-size:11px; padding:3px 10px; border-radius:10px; font-weight:700; }

  /* STOCK EDIT */
  .stock-input { background:var(--surface3); border:1px solid var(--border); border-radius:4px; color:var(--text); padding:4px 8px; font-family:var(--font-mono); font-size:12px; width:80px; outline:none; text-align:center; }
  .stock-input:focus { border-color:var(--accent); }

  /* CAT MANAGER */
  .cat-list { display:flex; flex-direction:column; gap:6px; }
  .cat-item { background:var(--surface2); border:1px solid var(--border); border-radius:6px; padding:8px 12px; display:flex; justify-content:space-between; align-items:center; font-size:12px; }

  /* TOAST */
  .toast-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:500; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.2s; }
  .toast-overlay.show { opacity:1; pointer-events:all; }
  .toast-box { background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius); padding:24px 28px; min-width:280px; max-width:400px; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,0.4); display:flex; flex-direction:column; gap:14px; }
  .toast-box.success { border-color:rgba(232,200,0,0.5); }
  .toast-box.error   { border-color:rgba(255,87,87,0.5); }
  .toast-msg { font-size:14px; line-height:1.5; }
  .toast-close { background:var(--accent); color:#0c0c0f; border:none; border-radius:6px; padding:8px 24px; font-family:var(--font-body); font-size:13px; font-weight:700; cursor:pointer; align-self:center; }
  .toast-close:hover { opacity:0.85; }

  /* THEME */
  .theme-btn { background:var(--surface2); border:1px solid var(--border); color:var(--muted); border-radius:6px; padding:6px 12px; font-family:var(--font-body); font-size:11px; font-weight:600; cursor:pointer; transition:all 0.2s; }
  .theme-btn:hover { border-color:var(--accent); color:var(--accent); }

  @media(max-width:600px) {
    .cards-grid { grid-template-columns:repeat(auto-fill, minmax(160px,1fr)); }
    .main { padding:16px; }
    .toolbar { padding:10px 16px; }
  }
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="logo">
    <a href="index.html" style="text-decoration:none; color:inherit;">Piola <span>¬∑</span></a>
    <span class="role">Cat√°logo</span>
  </div>
  <div class="topbar-right">
    <span id="fb-status">üü° conectando...</span>
    <button class="btn btn-secondary btn-sm" onclick="openCatManager()">‚öô Categor√≠as</button>
    <button class="btn btn-primary btn-sm" onclick="openProductForm()">+ Nuevo producto</button>
    <button class="theme-btn" onclick="toggleTheme()" id="theme-btn">‚òÄÔ∏è Claro</button>
  </div>
</div>

<!-- TOOLBAR -->
<div class="toolbar">
  <div class="search-wrap">
    <input type="text" id="search-input" placeholder="Buscar por nombre o c√≥digo..." oninput="renderGrid()">
  </div>
  <div class="cat-filters" id="cat-filters">
    <button class="cat-btn active" data-cat="" onclick="selectCat(this)">Todos</button>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <div class="grid-header">
    <h2 id="grid-title">Todos los productos</h2>
    <span class="grid-count" id="grid-count">‚Äî</span>
  </div>
  <div id="cat-loading" class="loading"><div class="spinner"></div> Cargando cat√°logo...</div>
  <div class="cards-grid" id="cards-grid"></div>
  <div id="cat-empty" class="empty-state" style="display:none;">
    <div class="icon">üì¶</div>
    No hay productos en esta categor√≠a todav√≠a.
  </div>
</div>

<!-- ===== MODAL: PRODUCT FORM ===== -->
<div class="modal-overlay hidden" id="modal-form">
  <div class="modal-box">
    <div class="modal-header">
      <span class="modal-title" id="form-title">Nuevo producto</span>
      <button class="modal-close" onclick="closeProductForm()">√ó</button>
    </div>
    <div class="modal-body">

      <!-- Foto -->
      <div class="form-group">
        <label>Foto del producto</label>
        <div class="photo-upload" id="photo-drop">
          <input type="file" id="photo-input" accept="image/*" onchange="handlePhotoSelect(this)">
          <div id="photo-preview-wrap">
            <div class="ph-icon">üì∑</div>
            <div class="ph-text">Hac√© click para subir una foto</div>
          </div>
        </div>
      </div>

      <!-- C√≥digo, Nombre, Categor√≠a -->
      <div class="form-row cols3">
        <div class="form-group">
          <label>C√≥digo</label>
          <input type="text" class="form-control" id="f-codigo" placeholder="PP001">
        </div>
        <div class="form-group" style="grid-column:span 2;">
          <label>Nombre del producto</label>
          <input type="text" class="form-control" id="f-nombre" placeholder="Ej: Bolsa de tela con cierre">
        </div>
      </div>

      <div class="form-row cols2">
        <div class="form-group">
          <label>Categor√≠a</label>
          <select class="form-control" id="f-categoria"></select>
        </div>
        <div class="form-group">
          <label>Fecha</label>
          <input type="date" class="form-control" id="f-fecha">
        </div>
      </div>

      <!-- Variantes -->
      <div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <label style="font-size:10px; font-weight:700; letter-spacing:0.8px; text-transform:uppercase; color:var(--muted);">Variantes (costos y stock)</label>
          <button class="btn btn-secondary btn-sm" onclick="addVariantRow()" id="btn-add-variant">+ Agregar variante</button>
        </div>
        <div id="variants-container" style="display:flex; flex-direction:column; gap:8px;"></div>
      </div>

      <!-- Ficha t√©cnica y Observaciones -->
      <div class="form-row cols2">
        <div class="form-group">
          <label>Ficha t√©cnica</label>
          <textarea class="form-control" id="f-ficha" placeholder="Medidas, materiales, especificaciones..."></textarea>
        </div>
        <div class="form-group">
          <label>Observaciones</label>
          <textarea class="form-control" id="f-obs" placeholder="Notas internas, condiciones especiales..."></textarea>
        </div>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeProductForm()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveProduct()" id="btn-save-product">üíæ Guardar producto</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: PRODUCT DETAIL ===== -->
<div class="modal-overlay hidden" id="modal-detail">
  <div class="modal-box">
    <div class="modal-header">
      <div>
        <div style="font-family:var(--font-mono); font-size:10px; color:var(--muted); margin-bottom:2px;" id="d-codigo"></div>
        <span class="modal-title" id="d-nombre"></span>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn btn-secondary btn-sm" onclick="editCurrentProduct()">‚úèÔ∏è Editar</button>
        <button class="modal-close" onclick="closeDetail()">√ó</button>
      </div>
    </div>
    <div class="modal-body">
      <div id="d-img-wrap"></div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <span id="d-cat" class="card-cat"></span>
        <span style="font-family:var(--font-mono); font-size:10px; color:var(--muted);" id="d-fecha"></span>
      </div>
      <div>
        <div style="font-size:10px; font-weight:700; letter-spacing:0.8px; text-transform:uppercase; color:var(--muted); margin-bottom:10px;">Variantes y stock</div>
        <div class="detail-variants" id="d-variants"></div>
      </div>
      <div id="d-ficha-wrap" style="display:none;">
        <div style="font-size:10px; font-weight:700; letter-spacing:0.8px; text-transform:uppercase; color:var(--muted); margin-bottom:6px;">Ficha t√©cnica</div>
        <div id="d-ficha" style="font-size:12px; color:var(--text); line-height:1.6; white-space:pre-line;"></div>
      </div>
      <div id="d-obs-wrap" style="display:none;">
        <div style="font-size:10px; font-weight:700; letter-spacing:0.8px; text-transform:uppercase; color:var(--muted); margin-bottom:6px;">Observaciones</div>
        <div id="d-obs" style="font-size:12px; color:var(--muted); line-height:1.6; white-space:pre-line;"></div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; padding-top:8px; border-top:1px solid var(--border);">
        <button class="btn btn-secondary btn-sm" style="color:var(--danger); border-color:rgba(255,87,87,0.3);" onclick="deleteCurrentProduct()">üóë Eliminar</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODAL: CATEGORY MANAGER ===== -->
<div class="modal-overlay hidden" id="modal-cats">
  <div class="modal-box" style="max-width:420px;">
    <div class="modal-header">
      <span class="modal-title">Gesti√≥n de Categor√≠as</span>
      <button class="modal-close" onclick="closeCatManager()">√ó</button>
    </div>
    <div class="modal-body">
      <div style="display:flex; gap:8px;">
        <input type="text" class="form-control" id="new-cat-input" placeholder="Nueva categor√≠a..." onkeydown="if(event.key==='Enter') addCategory()">
        <button class="btn btn-primary" onclick="addCategory()">+ Agregar</button>
      </div>
      <div class="cat-list" id="cat-list"></div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast-overlay" id="toast-overlay" onclick="closeToast()">
  <div class="toast-box" id="toast-box" onclick="event.stopPropagation()">
    <div class="toast-msg" id="toast-msg"></div>
    <button class="toast-close" onclick="closeToast()">Aceptar</button>
  </div>
</div>

<!-- FIREBASE MODULE -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, collection, doc, getDocs, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js';

const firebaseConfig = {
  apiKey: "AIzaSyAQNT8-8Q5v7Tfn9MIy530RSHdZj6Am390",
  authDomain: "piola-cotizador.firebaseapp.com",
  projectId: "piola-cotizador",
  storageBucket: "piola-cotizador.firebasestorage.app",
  messagingSenderId: "881054830595",
  appId: "1:881054830595:web:3d138a4952bba717d63e36"
};

const app  = initializeApp(firebaseConfig);
const db   = getFirestore(app);
const storage = getStorage(app);

window._db  = db;
window._storage = storage;
window._fbRef = ref;
window._fbUploadBytes = uploadBytes;
window._fbGetDownloadURL = getDownloadURL;
window._fbDeleteObject = deleteObject;
window._fbCollection = collection;
window._fbDoc = doc;
window._fbAddDoc = addDoc;
window._fbUpdateDoc = updateDoc;
window._fbDeleteDoc = deleteDoc;
window._fbSetDoc = setDoc;
window._fbGetDoc = getDoc;
window._fbOnSnapshot = onSnapshot;
window._fbQuery = query;
window._fbOrderBy = orderBy;

function tryInit() {
  if (typeof initCatalog === 'function') initCatalog();
  else setTimeout(tryInit, 50);
}
window.addEventListener('load', tryInit);
</script>

<script>
// ============================================================
// STATE
// ============================================================
let catalogDB  = {};   // { id: product }
let categorias = [];   // array of strings
let activeCat  = '';
let editingId  = null;
let detailId   = null;
let pendingPhotoFile = null;
let pendingPhotoBase64 = null;

const DEFAULT_CATS = ['Bags','Marroquiner√≠a','Accesorios','Bazar','Oficina','Indumentaria','Lonas / Toallas','Cajas','Tecnolog√≠a','Bebidas'];

// ============================================================
// INIT
// ============================================================
function initCatalog() {
  const fbStatus = document.getElementById('fb-status');

  // Load categories from Firebase config
  window._fbOnSnapshot(
    window._fbDoc(window._db, 'config', 'categorias'),
    snap => {
      if (snap.exists() && snap.data().list) {
        categorias = snap.data().list;
      } else {
        categorias = [...DEFAULT_CATS];
        saveCategorias();
      }
      renderCatFilters();
      renderCatSelect();
    }
  );

  // Load products
  window._fbOnSnapshot(
    window._fbQuery(window._fbCollection(window._db, 'catalogo'), window._fbOrderBy('nombre')),
    snap => {
      catalogDB = {};
      snap.forEach(d => catalogDB[d.id] = { id: d.id, ...d.data() });
      renderGrid();
      fbStatus.textContent = 'üü¢ conectado';
      fbStatus.style.color = 'var(--accent)';
      document.getElementById('cat-loading').style.display = 'none';
    },
    err => {
      fbStatus.textContent = 'üî¥ error';
      fbStatus.style.color = 'var(--danger)';
      console.error(err);
    }
  );
}

// ============================================================
// RENDER GRID
// ============================================================
function renderGrid() {
  const search = (document.getElementById('search-input')?.value || '').toLowerCase();
  const grid   = document.getElementById('cards-grid');
  const empty  = document.getElementById('cat-empty');
  const count  = document.getElementById('grid-count');

  let products = Object.values(catalogDB);

  if (activeCat) products = products.filter(p => p.categoria === activeCat);
  if (search)    products = products.filter(p =>
    (p.nombre||'').toLowerCase().includes(search) ||
    (p.codigo||'').toLowerCase().includes(search)
  );

  count.textContent = products.length + ' producto' + (products.length !== 1 ? 's' : '');

  if (products.length === 0) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  grid.innerHTML = products.map(p => {
    const variants = p.variantes || [];
    const totalStock = variants.reduce((s, v) => s + (parseInt(v.stock) || 0), 0);
    const sinStock = totalStock === 0;

    const variantsHtml = variants.map(v => {
      const st = parseInt(v.stock) || 0;
      const cls = st === 0 ? 'out' : st <= 5 ? 'low' : 'ok';
      const lbl = st === 0 ? 'Sin stock' : st + ' u.';
      return `<div class="variant-row">
        <span class="variant-name">${v.nombre || 'Variante'}</span>
        <span class="variant-price">${v.costo ? '$' + fmtN(v.costo) : '‚Äî'}</span>
        <span class="variant-stock ${cls}">${lbl}</span>
      </div>`;
    }).join('');

    const imgHtml = p.fotoUrl
      ? `<img class="card-img" src="${p.fotoUrl}" alt="${p.nombre}" loading="lazy">`
      : `<div class="card-img-placeholder">üì¶</div>`;

    return `<div class="prod-card${sinStock ? ' sin-stock' : ''}" onclick="openDetail('${p.id}')">
      ${imgHtml}
      <div class="card-body">
        <div class="card-code">${p.codigo || ''}</div>
        <div class="card-name">${p.nombre || '‚Äî'}</div>
        <span class="card-cat">${p.categoria || '‚Äî'}</span>
        <div class="card-variants">${variantsHtml}</div>
      </div>
    </div>`;
  }).join('');
}

// ============================================================
// CATEGORY FILTERS
// ============================================================
function renderCatFilters() {
  const wrap = document.getElementById('cat-filters');
  wrap.innerHTML = `<button class="cat-btn${activeCat === '' ? ' active' : ''}" data-cat="" onclick="selectCat(this)">Todos</button>`;
  categorias.forEach(cat => {
    const active = activeCat === cat ? ' active' : '';
    wrap.innerHTML += `<button class="cat-btn${active}" data-cat="${cat}" onclick="selectCat(this)">${cat}</button>`;
  });
}

function selectCat(btn) {
  document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  activeCat = btn.dataset.cat;
  document.getElementById('grid-title').textContent = activeCat || 'Todos los productos';
  renderGrid();
}

function renderCatSelect() {
  const sel = document.getElementById('f-categoria');
  if (!sel) return;
  sel.innerHTML = categorias.map(c => `<option value="${c}">${c}</option>`).join('');
}

// ============================================================
// CATEGORY MANAGER
// ============================================================
function openCatManager() {
  renderCatManagerList();
  document.getElementById('modal-cats').classList.remove('hidden');
}
function closeCatManager() {
  document.getElementById('modal-cats').classList.add('hidden');
}
function renderCatManagerList() {
  document.getElementById('cat-list').innerHTML = categorias.map((cat, i) => `
    <div class="cat-item">
      <span>${cat}</span>
      <button class="btn btn-secondary btn-sm" style="color:var(--danger); border-color:rgba(255,87,87,0.3);" onclick="removeCategory(${i})">√ó</button>
    </div>
  `).join('') || '<div style="color:var(--muted); font-size:12px; padding:8px;">Sin categor√≠as</div>';
}
async function addCategory() {
  const input = document.getElementById('new-cat-input');
  const val = input.value.trim();
  if (!val) return;
  if (categorias.includes(val)) { toast('Ya existe esa categor√≠a', 'error'); return; }
  categorias.push(val);
  await saveCategorias();
  input.value = '';
  renderCatManagerList();
  renderCatFilters();
  renderCatSelect();
}
async function removeCategory(idx) {
  const cat = categorias[idx];
  const inUse = Object.values(catalogDB).some(p => p.categoria === cat);
  if (inUse) { toast(`La categor√≠a "${cat}" tiene productos asignados. Reasignalos antes de eliminarla.`, 'error'); return; }
  if (!confirm(`¬øEliminar la categor√≠a "${cat}"?`)) return;
  categorias.splice(idx, 1);
  await saveCategorias();
  renderCatManagerList();
  renderCatFilters();
  renderCatSelect();
}
async function saveCategorias() {
  await window._fbSetDoc(window._fbDoc(window._db, 'config', 'categorias'), { list: categorias });
}

// ============================================================
// PRODUCT FORM
// ============================================================
function openProductForm(id = null) {
  editingId = id;
  pendingPhotoFile = null;
  pendingPhotoBase64 = null;

  document.getElementById('form-title').textContent = id ? 'Editar producto' : 'Nuevo producto';
  document.getElementById('variants-container').innerHTML = '';

  if (id) {
    const p = catalogDB[id];
    document.getElementById('f-codigo').value  = p.codigo || '';
    document.getElementById('f-nombre').value  = p.nombre || '';
    document.getElementById('f-ficha').value   = p.ficha || '';
    document.getElementById('f-obs').value     = p.obs || '';
    document.getElementById('f-fecha').value   = p.fecha || '';
    document.getElementById('f-categoria').value = p.categoria || categorias[0];
    // Photo preview
    if (p.fotoUrl) {
      document.getElementById('photo-preview-wrap').innerHTML = `<img src="${p.fotoUrl}" style="width:100%; max-height:140px; object-fit:contain; border-radius:6px;">`;
    } else {
      resetPhotoPreview();
    }
    // Variants
    (p.variantes || [{ nombre:'', costo:'', stock:0 }]).forEach(v => addVariantRow(v));
  } else {
    document.getElementById('f-codigo').value  = '';
    document.getElementById('f-nombre').value  = '';
    document.getElementById('f-ficha').value   = '';
    document.getElementById('f-obs').value     = '';
    document.getElementById('f-fecha').value   = new Date().toISOString().split('T')[0];
    document.getElementById('f-categoria').value = categorias[0] || '';
    resetPhotoPreview();
    addVariantRow();
  }

  document.getElementById('modal-form').classList.remove('hidden');
  setTimeout(() => document.getElementById('f-nombre').focus(), 100);
}

function closeProductForm() {
  document.getElementById('modal-form').classList.add('hidden');
  editingId = null;
}

function resetPhotoPreview() {
  document.getElementById('photo-preview-wrap').innerHTML = `
    <div class="ph-icon">üì∑</div>
    <div class="ph-text">Hac√© click para subir una foto</div>`;
}

function handlePhotoSelect(input) {
  const file = input.files[0];
  if (!file) return;
  pendingPhotoFile = file;
  const reader = new FileReader();
  reader.onload = e => {
    pendingPhotoBase64 = e.target.result;
    document.getElementById('photo-preview-wrap').innerHTML =
      `<img src="${e.target.result}" style="width:100%; max-height:140px; object-fit:contain; border-radius:6px;">`;
  };
  reader.readAsDataURL(file);
}

// ============================================================
// VARIANT ROWS
// ============================================================
let variantCount = 0;
function addVariantRow(data = {}) {
  const container = document.getElementById('variants-container');
  if (container.children.length >= 3) { toast('M√°ximo 3 variantes por producto', 'error'); return; }
  variantCount++;
  const id = 'vr-' + variantCount;
  const div = document.createElement('div');
  div.className = 'variant-editor';
  div.id = id;
  div.innerHTML = `
    <div class="variant-editor-header">
      <span class="variant-label">Variante ${container.children.length + 1}</span>
      <button class="btn btn-secondary btn-sm" style="color:var(--danger);" onclick="removeVariantRow('${id}')">√ó Quitar</button>
    </div>
    <div class="variant-fields">
      <div class="form-group">
        <label>Nombre de la variante</label>
        <input type="text" class="form-control vr-nombre" placeholder="Ej: Lona, Cordura, Ripstop..." value="${data.nombre || ''}">
      </div>
      <div class="form-group">
        <label>Costo $</label>
        <input type="number" class="form-control vr-costo" placeholder="0" min="0" value="${data.costo || ''}">
      </div>
      <div class="form-group">
        <label>Stock</label>
        <input type="number" class="form-control vr-stock" placeholder="0" min="0" value="${data.stock || 0}">
      </div>
    </div>`;
  container.appendChild(div);
  updateVariantLabels();
}

function removeVariantRow(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
  updateVariantLabels();
}

function updateVariantLabels() {
  const rows = document.querySelectorAll('#variants-container .variant-editor');
  rows.forEach((row, i) => {
    row.querySelector('.variant-label').textContent = 'Variante ' + (i + 1);
  });
  const btn = document.getElementById('btn-add-variant');
  if (btn) btn.style.display = rows.length >= 3 ? 'none' : 'inline-flex';
}

function getVariantsFromForm() {
  const rows = document.querySelectorAll('#variants-container .variant-editor');
  return Array.from(rows).map(row => ({
    nombre: row.querySelector('.vr-nombre').value.trim(),
    costo:  parseFloat(row.querySelector('.vr-costo').value) || 0,
    stock:  parseInt(row.querySelector('.vr-stock').value) || 0,
  })).filter(v => v.nombre || v.costo > 0);
}

// ============================================================
// SAVE PRODUCT
// ============================================================
async function saveProduct() {
  const nombre    = document.getElementById('f-nombre').value.trim();
  const codigo    = document.getElementById('f-codigo').value.trim();
  const categoria = document.getElementById('f-categoria').value;
  const ficha     = document.getElementById('f-ficha').value.trim();
  const obs       = document.getElementById('f-obs').value.trim();
  const fecha     = document.getElementById('f-fecha').value;
  const variantes = getVariantsFromForm();

  if (!nombre) { toast('El nombre del producto es obligatorio', 'error'); return; }
  if (variantes.length === 0) { toast('Agreg√° al menos una variante', 'error'); return; }

  const btn = document.getElementById('btn-save-product');
  btn.disabled = true;
  btn.textContent = '‚è≥ Guardando...';

  try {
    let fotoUrl = editingId ? (catalogDB[editingId]?.fotoUrl || '') : '';

    // Upload photo if new one selected
    if (pendingPhotoFile) {
      const storageRef = window._fbRef(window._storage, `catalogo/${Date.now()}_${pendingPhotoFile.name}`);
      const snap = await window._fbUploadBytes(storageRef, pendingPhotoFile);
      fotoUrl = await window._fbGetDownloadURL(snap.ref);
    }

    const data = { nombre, codigo, categoria, ficha, obs, fecha, variantes, fotoUrl, updatedAt: new Date().toISOString() };

    if (editingId) {
      await window._fbUpdateDoc(window._fbDoc(window._db, 'catalogo', editingId), data);
      toast('‚úì Producto actualizado', 'success');
    } else {
      data.createdAt = new Date().toISOString();
      await window._fbAddDoc(window._fbCollection(window._db, 'catalogo'), data);
      toast('‚úì Producto agregado al cat√°logo', 'success');
    }
    closeProductForm();
  } catch(e) {
    toast('Error al guardar: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'üíæ Guardar producto';
  }
}

// ============================================================
// DETAIL MODAL
// ============================================================
function openDetail(id) {
  const p = catalogDB[id];
  if (!p) return;
  detailId = id;

  document.getElementById('d-codigo').textContent = p.codigo || '';
  document.getElementById('d-nombre').textContent = p.nombre || '‚Äî';
  document.getElementById('d-cat').textContent    = p.categoria || '‚Äî';
  document.getElementById('d-fecha').textContent  = p.fecha ? 'Cargado: ' + p.fecha : '';

  // Image
  const imgWrap = document.getElementById('d-img-wrap');
  imgWrap.innerHTML = p.fotoUrl
    ? `<img class="detail-img" src="${p.fotoUrl}" alt="${p.nombre}">`
    : `<div class="detail-img-placeholder">üì¶</div>`;

  // Variants
  const varHtml = (p.variantes || []).map(v => {
    const st  = parseInt(v.stock) || 0;
    const cls = st === 0 ? 'out' : st <= 5 ? 'low' : 'ok';
    const lbl = st === 0 ? 'Sin stock' : st + ' unidades';
    const colors = { ok:'rgba(87,255,143,0.1)', low:'rgba(255,170,51,0.1)', out:'rgba(255,87,87,0.1)' };
    const textColors = { ok:'#57ff8f', low:'var(--warn)', out:'var(--danger)' };
    return `<div class="detail-variant-row">
      <div class="detail-variant-name">${v.nombre || 'Variante'}</div>
      <div class="detail-variant-price">${v.costo ? '$' + fmtN(v.costo) : '‚Äî'}</div>
      <div class="detail-variant-stock">
        <span class="stock-badge" style="background:${colors[cls]}; color:${textColors[cls]}; border:1px solid ${textColors[cls]}33;">${lbl}</span>
      </div>
    </div>`;
  }).join('');
  document.getElementById('d-variants').innerHTML = varHtml;

  // Ficha y obs
  const fichaWrap = document.getElementById('d-ficha-wrap');
  const obsWrap   = document.getElementById('d-obs-wrap');
  if (p.ficha) { fichaWrap.style.display='block'; document.getElementById('d-ficha').textContent=p.ficha; }
  else fichaWrap.style.display='none';
  if (p.obs) { obsWrap.style.display='block'; document.getElementById('d-obs').textContent=p.obs; }
  else obsWrap.style.display='none';

  document.getElementById('modal-detail').classList.remove('hidden');
}

function closeDetail() {
  document.getElementById('modal-detail').classList.add('hidden');
  detailId = null;
}

function editCurrentProduct() {
  if (!detailId) return;
  closeDetail();
  openProductForm(detailId);
}

async function deleteCurrentProduct() {
  if (!detailId) return;
  const p = catalogDB[detailId];
  if (!confirm(`¬øEliminar "${p.nombre}"? Esta acci√≥n no se puede deshacer.`)) return;
  try {
    // Delete photo from storage if exists
    if (p.fotoUrl) {
      try {
        const photoRef = window._fbRef(window._storage, p.fotoUrl);
        await window._fbDeleteObject(photoRef);
      } catch(e) { /* foto ya no existe, ok */ }
    }
    await window._fbDeleteDoc(window._fbDoc(window._db, 'catalogo', detailId));
    closeDetail();
    toast('Producto eliminado', 'success');
  } catch(e) {
    toast('Error al eliminar: ' + e.message, 'error');
  }
}

// ============================================================
// UTILS
// ============================================================
function fmtN(n) {
  if (isNaN(n) || n === null || n === undefined) return '0';
  return Math.round(n).toLocaleString('es-AR');
}

function toast(msg, type) {
  document.getElementById('toast-msg').textContent = msg;
  document.getElementById('toast-box').className = 'toast-box ' + (type || '');
  document.getElementById('toast-overlay').classList.add('show');
}
function closeToast() {
  document.getElementById('toast-overlay').classList.remove('show');
}

function toggleTheme() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') === 'dark';
  html.setAttribute('data-theme', isDark ? 'light' : 'dark');
  document.getElementById('theme-btn').textContent = isDark ? 'üåô Oscuro' : '‚òÄÔ∏è Claro';
  localStorage.setItem('piola-theme', isDark ? 'light' : 'dark');
}
const savedTheme = localStorage.getItem('piola-theme');
if (savedTheme) {
  document.documentElement.setAttribute('data-theme', savedTheme);
  document.getElementById('theme-btn').textContent = savedTheme === 'light' ? 'üåô Oscuro' : '‚òÄÔ∏è Claro';
}
</script>
</body>
</html>
