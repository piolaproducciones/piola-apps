<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Log√≠stica ¬∑ Piola</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,700;0,800;1,700;1,800&family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root[data-theme="dark"] {
    --bg:#0c0c0f; --surface:#141418; --surface2:#1c1c22; --surface3:#222228;
    --border:#2a2a38; --text:#e8e8f0; --muted:#6b6b80; --muted2:#4a4a5a;
    --accent:#e8c800; --danger:#ff5757; --warn:#ffaa33;
    --radius:8px; --font-body:'Syne',sans-serif; --font-mono:'DM Mono',monospace; --font-display:'Barlow Condensed',sans-serif;
  }
  :root[data-theme="light"] {
    --bg:#f0f0f5; --surface:#ffffff; --surface2:#f4f4f8; --surface3:#eaeaf0;
    --border:#dcdce8; --text:#1a1a2e; --muted:#70708a; --muted2:#a0a0b8;
    --accent:#b89a00; --danger:#cc2200; --warn:#cc7700;
    --radius:8px; --font-body:'Syne',sans-serif; --font-mono:'DM Mono',monospace; --font-display:'Barlow Condensed',sans-serif;
  }
  * { box-sizing:border-box; margin:0; padding:0; }
  body { background:var(--bg); color:var(--text); font-family:var(--font-body); font-size:13px; min-height:100vh; }

  /* TOPBAR */
  .topbar { background:var(--surface); border-bottom:1px solid var(--border); padding:0 28px; height:54px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
  .logo { font-family:var(--font-display); font-size:22px; }
  .logo a { text-decoration:none; color:inherit; }
  .logo span { color:var(--accent); }
  .logo .role { font-family:var(--font-mono); font-size:10px; color:var(--muted); margin-left:10px; letter-spacing:1px; text-transform:uppercase; }
  .topbar-right { display:flex; align-items:center; gap:10px; }
  .theme-btn { background:var(--surface2); border:1px solid var(--border); color:var(--muted); border-radius:6px; padding:6px 12px; font-family:var(--font-body); font-size:11px; font-weight:600; cursor:pointer; transition:all 0.2s; }
  .theme-btn:hover { border-color:var(--accent); color:var(--accent); }

  /* TABS */
  .main-tabs { background:var(--surface); border-bottom:1px solid var(--border); padding:0 28px; display:flex; gap:2px; }
  .main-tab { padding:11px 20px; font-size:12px; font-weight:600; letter-spacing:0.8px; text-transform:uppercase; color:var(--muted); cursor:pointer; border-bottom:2px solid transparent; transition:all 0.2s; white-space:nowrap; }
  .main-tab:hover { color:var(--text); }
  .main-tab.active { color:var(--accent); border-bottom-color:var(--accent); }
  .view-section { display:none; }
  .view-section.active { display:block; }

  /* BTN */
  .btn { padding:8px 16px; border-radius:6px; border:none; cursor:pointer; font-family:var(--font-body); font-size:12px; font-weight:600; transition:all 0.2s; display:inline-flex; align-items:center; gap:6px; }
  .btn-primary { background:var(--accent); color:#0c0c0f; }
  .btn-primary:hover { opacity:0.88; }
  .btn-secondary { background:var(--surface2); color:var(--text); border:1px solid var(--border); }
  .btn-secondary:hover { border-color:var(--accent); color:var(--accent); }
  .btn-sm { padding:5px 10px; font-size:11px; }
  .btn-danger { background:rgba(255,87,87,0.12); color:var(--danger); border:1px solid rgba(255,87,87,0.25); }

  /* FORM */
  .form-group { display:flex; flex-direction:column; gap:5px; }
  .form-group label { font-size:10px; font-weight:700; letter-spacing:0.8px; text-transform:uppercase; color:var(--muted); }
  .form-control { background:var(--surface2); border:1px solid var(--border); border-radius:6px; color:var(--text); padding:8px 12px; font-family:var(--font-body); font-size:13px; outline:none; transition:border-color 0.2s; width:100%; }
  .form-control:focus { border-color:var(--accent); }
  select.form-control option { background:var(--surface2); }
  textarea.form-control { resize:vertical; min-height:56px; }

  /* TOOLBAR */
  .toolbar { background:var(--surface); border-bottom:1px solid var(--border); padding:10px 28px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .search-wrap { position:relative; flex:1; min-width:180px; max-width:280px; }
  .search-wrap input { background:var(--surface2); border:1px solid var(--border); border-radius:6px; color:var(--text); padding:7px 12px 7px 32px; font-family:var(--font-body); font-size:12px; outline:none; width:100%; transition:border-color 0.2s; }
  .search-wrap input:focus { border-color:var(--accent); }
  .search-wrap::before { content:'üîç'; position:absolute; left:10px; top:50%; transform:translateY(-50%); font-size:12px; pointer-events:none; }

  /* TABLE */
  .table-wrap { overflow-x:auto; }
  table { width:100%; border-collapse:collapse; font-size:12px; }
  thead th { padding:8px 10px; text-align:left; font-size:9px; font-weight:700; letter-spacing:0.8px; text-transform:uppercase; color:var(--muted); border-bottom:1px solid var(--border); background:var(--surface2); white-space:nowrap; position:sticky; top:0; }
  tbody tr { border-bottom:1px solid rgba(42,42,56,0.4); transition:background 0.15s; }
  tbody tr:hover { background:rgba(255,255,255,0.02); }
  td { padding:8px 10px; vertical-align:middle; font-size:12px; }
  td.mono { font-family:var(--font-mono); }
  .urg-btn { display:inline-flex; align-items:center; justify-content:center; border:none; border-radius:5px; padding:3px 9px; font-size:11px; font-weight:800; font-family:var(--font-mono); cursor:pointer; transition:all 0.15s; letter-spacing:0.5px; min-width:38px; }
  .urg-btn.no  { background:rgba(255,255,255,0.04); color:var(--muted2); border:1px solid var(--border); }
  .urg-btn.si  { background:rgba(255,60,60,0.18); color:#ff4444; border:1px solid rgba(255,60,60,0.5); box-shadow:0 0 8px rgba(255,60,60,0.25); animation:urgpulse 1.8s ease-in-out infinite; }
  @keyframes urgpulse { 0%,100%{box-shadow:0 0 6px rgba(255,60,60,0.2);} 50%{box-shadow:0 0 14px rgba(255,60,60,0.55);} }
  .completada-row { opacity:0.45; }
  .completada-row td { text-decoration:line-through; }

  /* DIRECTORIO */
  .dir-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:12px; padding:20px 28px; }
  .dir-card { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:14px 16px; display:flex; flex-direction:column; gap:4px; transition:border-color 0.15s; }
  .dir-card:hover { border-color:var(--muted2); }
  .dir-card .dc-nombre { font-weight:700; font-size:13px; }
  .dir-card .dc-dir { font-size:12px; color:var(--muted); }
  .dir-card .dc-loc { font-size:11px; color:var(--muted2); font-family:var(--font-mono); }
  .dir-card .dc-meta { display:flex; gap:10px; margin-top:4px; flex-wrap:wrap; }
  .dir-card .dc-tag { font-size:10px; color:var(--muted); font-family:var(--font-mono); }
  .dir-card .dc-actions { display:flex; gap:6px; margin-top:8px; }
  .dir-search { flex:1; min-width:180px; max-width:320px; }

  /* MAIN LAYOUT */
  .main { padding:20px 28px; }
  .section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:10px; }
  .section-title { font-family:var(--font-display); font-size:18px; font-weight:700; }
  .count-badge { font-family:var(--font-mono); font-size:11px; color:var(--muted); }

  /* DIA VIEW */
  .dia-controls { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  .dia-date-input { background:var(--surface2); border:1px solid var(--border); border-radius:6px; color:var(--text); padding:7px 12px; font-family:var(--font-mono); font-size:13px; outline:none; transition:border-color 0.2s; }
  .dia-date-input:focus { border-color:var(--accent); }

  /* MODAL */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:200; display:flex; align-items:center; justify-content:center; padding:20px; }
  .modal-overlay.hidden { display:none; }
  .modal-box { background:var(--surface); border:1px solid var(--border); border-radius:12px; width:680px; max-width:95vw; max-height:90vh; overflow-y:auto; }
  .modal-header { padding:16px 24px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:var(--surface2); position:sticky; top:0; z-index:10; }
  .modal-title { font-family:var(--font-display); font-size:18px; font-weight:700; }
  .modal-close { background:none; border:none; color:var(--muted); font-size:22px; cursor:pointer; padding:4px 8px; border-radius:4px; transition:all 0.15s; }
  .modal-close:hover { color:var(--danger); }
  .modal-body { padding:24px; display:flex; flex-direction:column; gap:16px; }
  .modal-footer { padding:16px 24px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; background:var(--surface2); position:sticky; bottom:0; }
  .form-row { display:grid; gap:12px; }
  .form-row.cols2 { grid-template-columns:1fr 1fr; }
  .form-row.cols3 { grid-template-columns:1fr 1fr 1fr; }

  /* AUTOCOMPLETE */
  .autocomplete-wrap { position:relative; }
  .autocomplete-list { position:absolute; top:100%; left:0; right:0; background:var(--surface2); border:1px solid var(--accent); border-radius:6px; z-index:300; max-height:200px; overflow-y:auto; box-shadow:0 8px 24px rgba(0,0,0,0.4); }
  .autocomplete-item { padding:8px 12px; cursor:pointer; font-size:12px; border-bottom:1px solid var(--border); transition:background 0.1s; }
  .autocomplete-item:hover { background:var(--surface3); }
  .autocomplete-item .ac-nombre { font-weight:700; }
  .autocomplete-item .ac-sub { color:var(--muted); font-size:11px; }

  /* PRINT */
  @media print {
    .topbar, .main-tabs, .toolbar, .no-print { display:none !important; }
    body { background:white; color:black; font-size:11px; }
    .print-header { display:block !important; }
    table { font-size:10px; }
    thead th { background:#f0f0f0 !important; color:#333 !important; border:1px solid #ccc !important; }
    td { border:1px solid #ddd !important; padding:5px 8px !important; }
    tbody tr { border:none !important; }
    .urgente-badge { background:#ffeeee !important; color:#cc0000 !important; border:1px solid #cc0000 !important; -webkit-print-color-adjust:exact; }
  }
  .print-header { display:none; font-family:Arial,sans-serif; margin-bottom:16px; }
  .print-header h2 { font-size:16px; margin-bottom:4px; }
  .print-header p { font-size:12px; color:#666; }

  /* TOAST */
  .toast-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:500; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.2s; }
  .toast-overlay.show { opacity:1; pointer-events:all; }
  .toast-box { background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius); padding:24px 28px; min-width:280px; max-width:380px; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,0.4); display:flex; flex-direction:column; gap:14px; }
  .toast-box.success { border-color:rgba(232,200,0,0.5); }
  .toast-box.error   { border-color:rgba(255,87,87,0.5); }
  .toast-msg { font-size:14px; line-height:1.5; }
  .toast-close { background:var(--accent); color:#0c0c0f; border:none; border-radius:6px; padding:8px 24px; font-family:var(--font-body); font-size:13px; font-weight:700; cursor:pointer; align-self:center; }

  /* EMPTY / LOADING */
  .empty-state { padding:50px; text-align:center; color:var(--muted); }
  .loading { display:flex; align-items:center; gap:10px; color:var(--muted); font-size:12px; padding:30px; justify-content:center; }
  .spinner { width:16px; height:16px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.8s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="logo">
    <a href="index.html">Piola <span>¬∑</span></a>
    <span class="role">Log√≠stica</span>
  </div>
  <div class="topbar-right">
    <span id="fb-status" style="font-family:var(--font-mono); font-size:10px; color:var(--muted);">üü° conectando...</span>
    <button class="theme-btn" onclick="toggleTheme()" id="theme-btn">‚òÄÔ∏è Claro</button>
  </div>
</div>

<!-- TABS -->
<div class="main-tabs">
  <div class="main-tab active" onclick="switchTab('rutas', this)">üìã Rutas</div>
  <div class="main-tab" onclick="switchTab('dia', this)">üóì D√≠a</div>
  <div class="main-tab" onclick="switchTab('directorio', this)">üìí Directorio</div>
</div>

<!-- TOOLBAR rutas -->
<div class="toolbar" id="toolbar-rutas">
  <div class="search-wrap">
    <input type="text" id="search-rutas" placeholder="Buscar por marca, campa√±a, localidad..." oninput="renderRutas()">
  </div>
  <input type="date" id="filter-fecha-desde" class="dia-date-input" onchange="renderRutas()" title="Desde">
  <input type="date" id="filter-fecha-hasta" class="dia-date-input" onchange="renderRutas()" title="Hasta">
  <select id="filter-urgente" class="form-control" style="width:auto; padding:7px 12px;" onchange="renderRutas()">
    <option value="">Todas</option>
    <option value="1">Solo urgentes</option>
  </select>
  <button class="btn btn-primary btn-sm no-print" onclick="openForm()">+ Nueva parada</button>
</div>

<!-- ===== SECCI√ìN RUTAS ===== -->
<div class="view-section active" id="section-rutas">
  <div class="main">
    <div class="section-header">
      <span class="section-title">Todas las rutas</span>
      <span class="count-badge" id="rutas-count">‚Äî</span>
    </div>
    <div id="rutas-loading" class="loading"><div class="spinner"></div> Cargando rutas...</div>
    <div class="table-wrap">
      <table id="tabla-rutas" style="display:none;">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Marca / Proveedor</th>
            <th>Direcci√≥n</th>
            <th>Localidad</th>
            <th>Horario</th>
            <th>Contacto</th>
            <th>Cel</th>
            <th>Pedido</th>
            <th>Campa√±a</th>
            <th>Bultos</th>
            <th>Urg.</th>
            <th class="no-print"></th>
          </tr>
        </thead>
        <tbody id="rutas-tbody"></tbody>
      </table>
    </div>
    <div id="rutas-empty" class="empty-state" style="display:none;">Sin rutas para los filtros seleccionados.</div>
  </div>
</div>

<!-- ===== SECCI√ìN D√çA ===== -->
<div class="view-section" id="section-dia">
  <div class="main">
    <div class="print-header" id="print-header">
      <h2>Piola ¬∑ Hoja de Ruta</h2>
      <p id="print-fecha-label"></p>
    </div>
    <div class="section-header no-print">
      <div class="dia-controls">
        <span class="section-title">Ruta del d√≠a</span>
        <input type="date" id="dia-fecha" class="dia-date-input" onchange="renderDia()">
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn btn-secondary btn-sm no-print" onclick="openForm(document.getElementById('dia-fecha').value)">+ Agregar parada</button>
        <button class="btn btn-primary btn-sm no-print" onclick="window.print()">üñ® Imprimir</button>
      </div>
    </div>
    <div id="dia-loading" class="loading" style="display:none;"><div class="spinner"></div></div>
    <div class="table-wrap">
      <table id="tabla-dia" style="display:none;">
        <thead>
          <tr>
            <th>#</th>
            <th>Marca / Proveedor</th>
            <th>Direcci√≥n</th>
            <th>Localidad</th>
            <th>Horario</th>
            <th>Contacto</th>
            <th>Cel</th>
            <th>Pedido</th>
            <th>Campa√±a</th>
            <th>Bultos</th>
            <th>Urg.</th>
            <th class="no-print">‚úì</th>
          </tr>
        </thead>
        <tbody id="dia-tbody"></tbody>
      </table>
    </div>
    <div id="dia-empty" class="empty-state" style="display:none;">
      Sin paradas para este d√≠a. Pod√©s agregar una con el bot√≥n de arriba.
    </div>
  </div>
</div>

<!-- ===== SECCI√ìN DIRECTORIO ===== -->
<div class="view-section" id="section-directorio">
  <div class="toolbar" id="toolbar-directorio" style="display:none;">
    <div class="search-wrap dir-search">
      <input type="text" id="search-dir" placeholder="Buscar proveedor, localidad..." oninput="renderDirectorio()">
    </div>
    <button class="btn btn-primary btn-sm no-print" onclick="openFormDir()">+ Nuevo proveedor</button>
  </div>
  <div id="dir-loading" class="loading"><div class="spinner"></div> Cargando directorio...</div>
  <div id="dir-grid" class="dir-grid" style="display:none;"></div>
  <div id="dir-empty" class="empty-state" style="display:none;">Sin proveedores. Agreg√° el primero con el bot√≥n de arriba.</div>
</div>

<!-- MODAL DIRECTORIO -->
<div class="modal-overlay hidden" id="modal-dir">
  <div class="modal-box">
    <div class="modal-header">
      <span class="modal-title" id="dir-form-title">Nuevo proveedor</span>
      <button class="modal-close" onclick="closeFormDir()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Nombre / Marca</label>
        <input type="text" class="form-control" id="df-nombre" placeholder="Nombre del proveedor">
      </div>
      <div class="form-row cols2">
        <div class="form-group">
          <label>Direcci√≥n</label>
          <input type="text" class="form-control" id="df-direccion" placeholder="Calle y n√∫mero">
        </div>
        <div class="form-group">
          <label>Localidad</label>
          <input type="text" class="form-control" id="df-localidad" placeholder="Ciudad / Localidad">
        </div>
      </div>
      <div class="form-row cols3">
        <div class="form-group">
          <label>Horario</label>
          <input type="text" class="form-control" id="df-horario" placeholder="Ej: 9 a 18 hs">
        </div>
        <div class="form-group">
          <label>Contacto</label>
          <input type="text" class="form-control" id="df-contacto" placeholder="Nombre">
        </div>
        <div class="form-group">
          <label>Celular</label>
          <input type="text" class="form-control" id="df-cel" placeholder="11 XXXX-XXXX">
        </div>
      </div>
      <div class="form-group">
        <label>Notas</label>
        <textarea class="form-control" id="df-notas" placeholder="Info adicional..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeFormDir()">Cancelar</button>
      <button class="btn btn-primary" id="btn-save-dir" onclick="saveProveedor()">üíæ Guardar proveedor</button>
    </div>
  </div>
</div>

<!-- ===== MODAL FORM ===== -->
<div class="modal-overlay hidden" id="modal-form">
  <div class="modal-box">
    <div class="modal-header">
      <span class="modal-title" id="form-title">Nueva parada</span>
      <button class="modal-close" onclick="closeForm()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-row cols2">
        <div class="form-group">
          <label>Fecha</label>
          <input type="date" class="form-control" id="f-fecha">
        </div>
        <div class="form-group">
          <label>Urgente</label>
          <select class="form-control" id="f-urgente">
            <option value="0">No</option>
            <option value="1">S√≠ ‚Äî URGENTE</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Marca / Proveedor</label>
        <div class="autocomplete-wrap">
          <input type="text" class="form-control" id="f-marca" placeholder="Escrib√≠ para buscar en el directorio..." autocomplete="off" oninput="acSearch(this.value)" onblur="setTimeout(()=>acHide(),200)">
          <div class="autocomplete-list" id="ac-list" style="display:none;"></div>
        </div>
      </div>

      <div class="form-row cols2">
        <div class="form-group">
          <label>Direcci√≥n</label>
          <input type="text" class="form-control" id="f-direccion" placeholder="Calle y n√∫mero">
        </div>
        <div class="form-group">
          <label>Localidad</label>
          <input type="text" class="form-control" id="f-localidad" placeholder="Ciudad / Localidad">
        </div>
      </div>

      <div class="form-row cols3">
        <div class="form-group">
          <label>Horario</label>
          <input type="text" class="form-control" id="f-horario" placeholder="Ej: 9 a 17 hs">
        </div>
        <div class="form-group">
          <label>Contacto</label>
          <input type="text" class="form-control" id="f-contacto" placeholder="Nombre">
        </div>
        <div class="form-group">
          <label>Celular</label>
          <input type="text" class="form-control" id="f-cel" placeholder="11 XXXX-XXXX">
        </div>
      </div>

      <div class="form-row cols2">
        <div class="form-group">
          <label>Pedido / Instrucciones</label>
          <textarea class="form-control" id="f-pedido" placeholder="Qu√© hay que hacer en esta parada..."></textarea>
        </div>
        <div class="form-group">
          <label>Campa√±a</label>
          <input type="text" class="form-control" id="f-campana" placeholder="Nombre de la campa√±a">
        </div>
      </div>

      <div class="form-group">
        <label>Bultos</label>
        <input type="text" class="form-control" id="f-bultos" placeholder="Ej: 2 cajas, 1 bolsa...">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeForm()">Cancelar</button>
      <button class="btn btn-primary" id="btn-save" onclick="saveParada()">üíæ Guardar parada</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast-overlay" id="toast-overlay" onclick="closeToast()">
  <div class="toast-box" id="toast-box" onclick="event.stopPropagation()">
    <div class="toast-msg" id="toast-msg"></div>
    <button class="toast-close" onclick="closeToast()">Aceptar</button>
  </div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyAQNT8-8Q5v7Tfn9MIy530RSHdZj6Am390",
  authDomain: "piola-cotizador.firebaseapp.com",
  projectId: "piola-cotizador",
  storageBucket: "piola-cotizador.firebasestorage.app",
  messagingSenderId: "881054830595",
  appId: "1:881054830595:web:3d138a4952bba717d63e36"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

window._db          = db;
window._fbCollection= collection;
window._fbDoc       = doc;
window._fbAddDoc    = addDoc;
window._fbUpdateDoc = updateDoc;
window._fbDeleteDoc = deleteDoc;
window._fbOnSnapshot= onSnapshot;
window._fbQuery     = query;
window._fbOrderBy   = orderBy;

window.addEventListener('load', () => {
  window._fbOnSnapshot(
    window._fbCollection(window._db, 'rutas'),
    snap => {
      rutasDB = {};
      snap.forEach(d => rutasDB[d.id] = { id: d.id, ...d.data() });
      renderRutas();
      renderDia();
      document.getElementById('fb-status').textContent = 'üü¢ conectado';
      document.getElementById('fb-status').style.color = 'var(--accent)';
      document.getElementById('rutas-loading').style.display = 'none';
      document.getElementById('tabla-rutas').style.display = 'table';
    },
    err => {
      document.getElementById('fb-status').textContent = 'üî¥ error';
      console.error(err);
    }
  );

  window._fbOnSnapshot(
    window._fbCollection(window._db, 'directorio'),
    snap => {
      dirDB = {};
      snap.forEach(d => dirDB[d.id] = { id: d.id, ...d.data() });
      document.getElementById('dir-loading').style.display = 'none';
      document.getElementById('dir-grid').style.display = 'grid';
      if (document.getElementById('section-directorio').classList.contains('active')) {
        renderDirectorio();
      }
    },
    err => console.error('directorio error:', err)
  );
});
</script>

<script>
// ============================================================
// DATA
// ============================================================
const PROVEEDORES_DIR = [{"nombre": "Adrian taller norte", "direccion": "Sarmiento 787, esquina Juncal", "localidad": "Tigre", "horario": "", "contacto": "Adrian", "cel": "11 6800-3337"}, {"nombre": "Agroplastic", "direccion": "Sebasti√°n Gaboto 4762", "localidad": "Munro", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Alejandro Cadirola", "direccion": "Av Caama√±o 125 (Liquidambar)", "localidad": "Pilar", "horario": "", "contacto": "Alejandro", "cel": "11 3761-8750"}, {"nombre": "Alicia magui", "direccion": "Bella vista 5772 entre duran y vespuccio bella vista", "localidad": "Bella vista", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Alplast", "direccion": "Av. Nicol√°s Avellaneda 3112", "localidad": "Virreyes", "horario": "9 a 18 hs.", "contacto": "", "cel": "11 3400-7049"}, {"nombre": "Andromaco", "direccion": "Huergo 1145", "localidad": "Puerto Madero (CABA)", "horario": "8 a 17", "contacto": "Matias Vidal", "cel": "11 6002-7896"}, {"nombre": "Apparel & Co", "direccion": "Diego Palma 1045", "localidad": "San Isidro", "horario": "9 a 18 hs.", "contacto": "Silvana", "cel": "11 5475-1011"}, {"nombre": "Ariel Secchiari vinos", "direccion": "Isla nueva 250 Parque industrial Talar Nave 2", "localidad": "Talar", "horario": "", "contacto": "Ariel Secchiari", "cel": ""}, {"nombre": "Ariel taller caseros", "direccion": "Juan de garay 5024", "localidad": "Caseros", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Arifernic", "direccion": "FRANCISCO BEIRO 3346 OLIVOS", "localidad": "OLIVOS", "horario": "", "contacto": "", "cel": "11 4412-4231"}, {"nombre": "Becka Sublimados", "direccion": "Hipolito Bouchard 1885", "localidad": "Castelar", "horario": "", "contacto": "Alejo", "cel": "11 6804-5599"}, {"nombre": "Betty", "direccion": "Alsina 101", "localidad": "San Fernando", "horario": "", "contacto": "Betty", "cel": "11 3765-8850"}, {"nombre": "Betty Cordoba", "direccion": "Sargento D√≠az 2050 timbre 3", "localidad": "Virreyes", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Blear", "direccion": "Simbr√≥n 3531", "localidad": "CABA", "horario": "10 a 16 hs.", "contacto": "Diego", "cel": "11 6568-2648"}, {"nombre": "Bondeados Joy", "direccion": "Laalle 2309 (Esq. Pasteur)", "localidad": "Once", "horario": "9:30 a 17hs", "contacto": "Local", "cel": "11 2498-6126"}, {"nombre": "Brugge", "direccion": "Araoz 951", "localidad": "Villa Crespo", "horario": "", "contacto": "Leila", "cel": "11 6983-4636"}, {"nombre": "Carolina Beccar", "direccion": "Padre acevedo 2900 esq Los Patos", "localidad": "Beccar", "horario": "12 a 17 hs.", "contacto": "", "cel": ""}, {"nombre": "Casa Antonio", "direccion": "Av. Boedo 1411", "localidad": "Boedo", "horario": "", "contacto": "", "cel": "11 3871-4599"}, {"nombre": "Casa Fernando", "direccion": "Av Boedo 1416", "localidad": "Boedo", "horario": "", "contacto": "", "cel": "11 4147-7714"}, {"nombre": "Casa Jorge", "direccion": "Larrea 374", "localidad": "CABA", "horario": "", "contacto": "", "cel": "11 5526-2867"}, {"nombre": "Casa Nacho", "direccion": "C√°mpora 2419 entre Alsina y solanet", "localidad": "Merlo", "horario": "Lu a vi de 10 a 13 y 14 a 18.30, Sab de 9 a 13hs", "contacto": "", "cel": ""}, {"nombre": "Casa Panczuch", "direccion": "araoz 690", "localidad": "CABA", "horario": "", "contacto": "", "cel": "11 6353-0253"}, {"nombre": "Casa Tony", "direccion": "Av. Lope de Vega 699", "localidad": "CABA", "horario": "", "contacto": "", "cel": "11 3260-0158"}, {"nombre": "Casa victor", "direccion": "Av. Boedo 1372", "localidad": "Boedo", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Casenave", "direccion": "Bernardino Rivadavia 2870", "localidad": "Munro", "horario": "8 a 17 hs.", "contacto": "Jorge Casenave", "cel": "11 4438-8662"}, {"nombre": "CEL", "direccion": "Arribe√±os 3345", "localidad": "CABA", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Central de Cadetes", "direccion": "Av. de los Constituyentes 3415, Local 3 y 6", "localidad": "Pacheco", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Christian Closas", "direccion": "San Martin 2440", "localidad": "Benavidez", "horario": "", "contacto": "Christian", "cel": "11 6567-9474"}, {"nombre": "Clarisa De Vries", "direccion": "Cramer 3858", "localidad": "CABA", "horario": "", "contacto": "Clarisa", "cel": "11 5869-0011"}, {"nombre": "Comisso", "direccion": "Gral. Juan Lavalle 3581", "localidad": "Villa Martelli", "horario": "9 a 15", "contacto": "Mario o mariana", "cel": "11 5638-9682"}, {"nombre": "Confecci√≥n Total", "direccion": "", "localidad": "", "horario": "", "contacto": "Martin", "cel": "11 4444-1011"}, {"nombre": "Cubritas", "direccion": "Republica 7483", "localidad": "Jose L Suarez", "horario": "", "contacto": "Pablo", "cel": "11 6999-9644"}, {"nombre": "Depo Piola", "direccion": "Zuviria 932", "localidad": "Tigre", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Diego Loiano", "direccion": "Donado 2415 (e/ Blanco Encalada y Moroe)", "localidad": "Villa Urquiza", "horario": "", "contacto": "Diego", "cel": "11 6046-3223"}, {"nombre": "Dorsa SRL", "direccion": "Padre Darb√≥n 3950", "localidad": "Villa Leon", "horario": "", "contacto": "Yanina", "cel": "11 4481-5424"}, {"nombre": "DUE", "direccion": "Montes de Oca 530, 7A", "localidad": "Tigre", "horario": "", "contacto": "Due", "cel": "11 3819-0154"}, {"nombre": "El Kalfa", "direccion": "Lavalle 2674", "localidad": "Once", "horario": "", "contacto": "", "cel": "11 6959-3527"}, {"nombre": "Elementi", "direccion": "Jufr√© 556", "localidad": "CABA", "horario": "", "contacto": "Diego", "cel": "11 5171-4217"}, {"nombre": "Eli Mam√° (Enevoldsen)", "direccion": "Murature 5250", "localidad": "Villa Luro", "horario": "", "contacto": "Eli", "cel": "11 6646-8550"}, {"nombre": "Elida Arcos", "direccion": "Ex Combatiente Juan Sanchez 744", "localidad": "San Fernando", "horario": "", "contacto": "Elida Arcos", "cel": "11 4526-3845"}, {"nombre": "Estructura Central", "direccion": "Av. 12 de Octubre 100 gran canaria", "localidad": "Quilmes", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Exequiel Cache", "direccion": "Gandolfo 1395", "localidad": "San Fernando", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Fabian", "direccion": "Campos 1190 (esq 4 de Febero)", "localidad": "San martin", "horario": "", "contacto": "Fabian", "cel": "11 2790-8424"}, {"nombre": "Fabrica Musters", "direccion": "Capdevilla 6547, (e/ fraternidad e igualdad)", "localidad": "Jos√© Le√≥n Su√°rez", "horario": "", "contacto": "Christian", "cel": "11 6114-6537"}, {"nombre": "Fango Estudio", "direccion": "Jos√© Mar√≠a paz 3970", "localidad": "Olivos", "horario": "", "contacto": "Manu", "cel": "11 6452-0766"}, {"nombre": "Federico ri√±oneras", "direccion": "Direcc ramallo 4671 entre lugones y mariano acha", "localidad": "CABA", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Felicitas molderia", "direccion": "Fray Cayetano Rodriguez 365  (e Thames y Novaro)", "localidad": "Villa Adelina", "horario": "", "contacto": "Felicitas", "cel": ""}, {"nombre": "Formato Grafico", "direccion": "Carlos Berg 3252", "localidad": "Villa Soldati", "horario": "", "contacto": "Pablo", "cel": "11 3091-3933"}, {"nombre": "FRANCISCO BEIRO 3346", "direccion": "Juan de Garay 5024", "localidad": "Caseros", "horario": "", "contacto": "Ariel", "cel": "11 2643-5713"}, {"nombre": "GDT", "direccion": "Casafoust 625", "localidad": "CABA", "horario": "", "contacto": "Roberto", "cel": "11 5633-5607"}, {"nombre": "Georgina caseros", "direccion": "Roque S√°enz Pe√±a 3597", "localidad": "Caseros", "horario": "De 9 a 13 y de 15 a 19", "contacto": "", "cel": ""}, {"nombre": "GlobalRoss", "direccion": "Av. Dr. Ricardo Balb√≠n 2817", "localidad": "Belgrano", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Grafica A4", "direccion": "Casilda 852 entre Rodr√≠guez Pe√±a y Rep√∫blica de Israel", "localidad": "Villa Lynch", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Grafica Mathipe", "direccion": "Jos√© Ingenieros 2512", "localidad": "Beccar", "horario": "08:00‚Äì13:00, 14:00‚Äì18:00", "contacto": "", "cel": ""}, {"nombre": "Happy Mood", "direccion": "Godoy Cruz 1762", "localidad": "CABA", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Improm / Promo Productos", "direccion": "Hait√≠ 1851", "localidad": "Martinez", "horario": "", "contacto": "Ivan", "cel": "11 4070-5979"}, {"nombre": "Ito Ia", "direccion": "Senador Moron 1238", "localidad": "Bella Vista", "horario": "", "contacto": "Lucas", "cel": "11 3701-5628"}, {"nombre": "Javier Giuliani", "direccion": "Alvear 1430", "localidad": "Quilmes", "horario": "", "contacto": "Javier", "cel": "11 5002-0331"}, {"nombre": "Joaco 3D", "direccion": "Av del libertador 18270", "localidad": "Beccar", "horario": "10 a 18 hs.", "contacto": "Joaquin", "cel": "11 3102-8487"}, {"nombre": "Juan Carlos Ferrufino", "direccion": "calle 884 n√∫mero 3974, Quilmes", "localidad": "quilmes", "horario": "", "contacto": "juan carlos", "cel": "11 5847-7465"}, {"nombre": "Julieta Zamparutti", "direccion": "Acceso Norte KM 45 UF 137 barrio los sauces", "localidad": "Pilar", "horario": "", "contacto": "Julieta", "cel": "11 6284-8936"}, {"nombre": "Just Print", "direccion": "Salom 617", "localidad": "Barracas", "horario": "", "contacto": "Diego", "cel": "11 4165-0156"}, {"nombre": "La Mary", "direccion": "Paran√° 5627", "localidad": "Villa Adelina", "horario": "", "contacto": "Japo", "cel": "11 3169-6046"}, {"nombre": "Laser Concept", "direccion": "Julian Segundo Aguero 2064", "localidad": "vicente lopez", "horario": "", "contacto": "Rita", "cel": "1168493999.0"}, {"nombre": "Levys", "direccion": "Acu√±a de figueroa 462 (entre sarmiento y per√≥n)", "localidad": "CABA", "horario": "", "contacto": "", "cel": "11 4079-1693"}, {"nombre": "Little Blue", "direccion": "Colectora Panamericana 1807", "localidad": "Villa Adelina", "horario": "", "contacto": "Depan", "cel": "11 3960-0101"}, {"nombre": "LlaveCorp", "direccion": "Nicasio Oro√±o 2210, Depto 2", "localidad": "CABA", "horario": "9 a 18 hs.", "contacto": "Nahuel", "cel": "11 3181-3153"}, {"nombre": "Lorena", "direccion": "Ohiggins 1571 (e/ Garibaldi y William)", "localidad": "Rincon", "horario": "", "contacto": "Lorena", "cel": "11 6163-8481"}, {"nombre": "Lucas Cortes", "direccion": "Av avellaneda 4677", "localidad": "Virreyes", "horario": "", "contacto": "Lucas", "cel": "11 6488-0106"}, {"nombre": "Maderarte", "direccion": "Holmberg 4359", "localidad": "CABA", "horario": "11hs a 16hs", "contacto": "Santiago", "cel": "11 5462-8261"}, {"nombre": "Mariana Caja", "direccion": "24 de Noviembre 483", "localidad": "CABA", "horario": "", "contacto": "Mariana", "cel": "11 7018-9605"}, {"nombre": "Marrolandia", "direccion": "Av. Warnes 541", "localidad": "CABA", "horario": "", "contacto": "", "cel": "11 2773-0288"}, {"nombre": "Martin Diez", "direccion": "Blvd del Mirador 290 piso 4 of 403, Studios de la Bah√≠a II (1670),", "localidad": "Nordelta, Tigre", "horario": "", "contacto": "Martin Diez", "cel": "11 5842-1334"}, {"nombre": "Material Termico", "direccion": "Cuenca 515 (Timbre ventana)", "localidad": "El Palomar", "horario": "8:30 a 12 / 14 a 17 hs.", "contacto": "Javier", "cel": "11 5756-3718"}, {"nombre": "Megaimport", "direccion": "Cespedes 3881", "localidad": "CABA", "horario": "", "contacto": "Migue/ Maxi", "cel": "11 5426-8772"}, {"nombre": "MVK Pilusos", "direccion": "Rivadavia 4136, Timbre 53", "localidad": "Almagro", "horario": "13 a 19 hs.", "contacto": "Karina / Agustin", "cel": "11 2691-8929"}, {"nombre": "NATALIA MODELISTA", "direccion": "Acevedo 180 5c", "localidad": "Palermo", "horario": "9 a 17", "contacto": "", "cel": ""}, {"nombre": "Nico Corte", "direccion": "Montes de Oca 763 (entre Navarro y Juncal)", "localidad": "Tigre", "horario": "9 a 18h", "contacto": "Nicolas", "cel": "1167872754.0"}, {"nombre": "Nuevas Formas", "direccion": "Estomba 3932", "localidad": "CABA", "horario": "", "contacto": "Valeria", "cel": "11 6156-5954"}, {"nombre": "Oficinas Disney", "direccion": "Chile 1180", "localidad": "La Lonja, Pilar", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Pablo Arce", "direccion": "Av los Quilmes 1440 (Persiana negra)", "localidad": "Bernal", "horario": "", "contacto": "Pablo", "cel": "11 2879-3914"}, {"nombre": "Pablo Bordados", "direccion": "Tte. General Lonardi 1422", "localidad": "Beccar", "horario": "", "contacto": "Pablo", "cel": "11 5618-8180"}, {"nombre": "Patagon", "direccion": "Del gasoducto 1864", "localidad": "Fatima", "horario": "8 a 17 hs.", "contacto": "Edgardo", "cel": "11 6634-6278"}, {"nombre": "Piel Metal", "direccion": "Cabildo 2071", "localidad": "Ciudadela", "horario": "8:30 a 11:30 hs /13 a 16 hs", "contacto": "Fernanda", "cel": "11 2359-0498"}, {"nombre": "Piola House", "direccion": "General Campos 77", "localidad": "Tigre", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Practibolsa (Daniel)", "direccion": "Monroe 5694 (esquina Ceretti)", "localidad": "Villa urquiza", "horario": "", "contacto": "Daniel", "cel": "11 3339-4363"}, {"nombre": "Promo Store", "direccion": "Fray Cayetano Rodriguez 3233", "localidad": "Carapachay", "horario": "", "contacto": "Brenda", "cel": "11 6906-5586"}, {"nombre": "PromoFabrica", "direccion": "Complejo Log√≠stico Construcnor, Manuel Montes de Oca 6430", "localidad": "Carapachay", "horario": "9 a 12 y 13 a 17", "contacto": "", "cel": ""}, {"nombre": "Puro Lienzo", "direccion": "Nogoy√° 3455", "localidad": "Villa del parque", "horario": "", "contacto": "", "cel": "11 6868-9927"}, {"nombre": "Quilmes Nu√±ez", "direccion": "Arribe√±os 3350", "localidad": "Nu√±ez", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Rigolleau", "direccion": "Colectora Este 8784, (Pana ramal Pilar)", "localidad": "PILAR", "horario": "", "contacto": "Juan Poggi", "cel": "11 6005-4321"}, {"nombre": "Routeados", "direccion": "Martin Rodr√≠guez 2430", "localidad": "Victoria", "horario": "9 a 12hs y de 13hs a 18hs", "contacto": "", "cel": ""}, {"nombre": "Russo", "direccion": "Garcia del R√≠o 3330", "localidad": "CABA", "horario": "9 a 18 hs.", "contacto": "Andrea", "cel": "11 5094-2667"}, {"nombre": "Sadasa", "direccion": "Calle 31, 4476 (ex Tandil)", "localidad": "Villa Ballester", "horario": "9 a 12: 30 y de 14 a 17", "contacto": "Cecilia", "cel": "11 4768-2630"}, {"nombre": "Safecolor (Gaston)", "direccion": "Av Guemes 1118", "localidad": "Avellaneda", "horario": "", "contacto": "Gaston", "cel": "11 6368-2333"}, {"nombre": "Saxs", "direccion": "Tomas justo Villegas 426", "localidad": "Lomas del Mirador", "horario": "8 a 13 y 13.30 a 16", "contacto": "", "cel": ""}, {"nombre": "Simjaplast", "direccion": "Av. Amancio Alcorta 1886", "localidad": "CABA", "horario": "", "contacto": "Natalia", "cel": "11 5064-4222"}, {"nombre": "Skyline", "direccion": "Amen√°bar 1314", "localidad": "CABA", "horario": "", "contacto": "Pablo", "cel": "11 6805-7070"}, {"nombre": "SOUL TEXTIL", "direccion": "Saenz pe√±a 1865", "localidad": "San martin", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Spinetta", "direccion": "Curupayti 391", "localidad": "Boulogne", "horario": "9 a 16", "contacto": "Fede Spinetta", "cel": "11 6457-4442"}, {"nombre": "Stock Sur (CDO)", "direccion": "Av. √Ålvarez Jonte 1872", "localidad": "CABA", "horario": "", "contacto": "Facundo", "cel": ""}, {"nombre": "Susana", "direccion": "Zuviria 932", "localidad": "Tigre", "horario": "", "contacto": "Susana", "cel": "11 5011-8964"}, {"nombre": "Susi Mili", "direccion": "Pringles 2144", "localidad": "Talar", "horario": "", "contacto": "Susimili", "cel": "11 3169-5185"}, {"nombre": "Taller Carolina", "direccion": "Padre acevedo 2900", "localidad": "Beccar", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Taller Leonardo", "direccion": "Entre Rios 556", "localidad": "Pacheco", "horario": "", "contacto": "Leonardo", "cel": ""}, {"nombre": "Taller Planchado", "direccion": "Galicia 526  6to B", "localidad": "CABA", "horario": "8 a 12 y 13 a 16hs", "contacto": "", "cel": ""}, {"nombre": "Taller Raul", "direccion": "Yatay 321", "localidad": "Valentin Alsina", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Tecnograbados", "direccion": "Torrent 1225", "localidad": "CABA", "horario": "9hs a 18hs", "contacto": "Celeste", "cel": "11 6221-9565"}, {"nombre": "TEXTIL TUCUMAN", "direccion": "TUCUMAN 2307", "localidad": "CABA", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Tobatel", "direccion": "azcuenaga 556", "localidad": "Once", "horario": "11 a 17", "contacto": "Aron", "cel": "1134572626.0"}, {"nombre": "TopBall", "direccion": "Eduardo S√≠vori 5182.", "localidad": "Munro", "horario": "", "contacto": "", "cel": ""}, {"nombre": "TTH", "direccion": "Conde 475", "localidad": "CABA", "horario": "10 a 17 hs.", "contacto": "Tomas Cacciola", "cel": "11 6647-0109"}, {"nombre": "Victor Corte", "direccion": "Virgilio 820 entre camarones y margari√±os Cervantes", "localidad": "Villa Luro", "horario": "", "contacto": "Victor", "cel": "11 3657-5460"}, {"nombre": "Walter", "direccion": "Santa rita 1173", "localidad": "San Fernando", "horario": "", "contacto": "Walter", "cel": "11 3496-0777"}, {"nombre": "Witpel", "direccion": "2340 entre San Juan y Corrientes", "localidad": "Villa Ballester", "horario": "8 a 18", "contacto": "", "cel": "11 4768-1281"}, {"nombre": "Yoli Ubi", "direccion": "Casilla Yolanda", "localidad": "San Andres", "horario": "", "contacto": "Yolanda", "cel": "11 5838-6506"}, {"nombre": "Zecat", "direccion": "Colectora Panamericana 264", "localidad": "Martinez", "horario": "", "contacto": "Miguel", "cel": "11 3619-7212"}, {"nombre": "Zecat Pacheco", "direccion": "Jose Ingenieros 3198", "localidad": "Pacheco", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Marga", "direccion": "Campos y 4de febrero cooperativa Jos√© Hern√°ndez casa 92", "localidad": "San Andres", "horario": "", "contacto": "Marga", "cel": "11 3014-1796"}, {"nombre": "Fede Anta", "direccion": "Habana 345", "localidad": "Villa Martelli", "horario": "9 a 12:30 / 13:30 a 16", "contacto": "Fede", "cel": "11 5860-9693"}, {"nombre": "ITEXTIL", "direccion": "Av Rivadavia 5446 timbre Planta Baja (frente a Primera Junta)", "localidad": "Caballito", "horario": "10:30hs a 19hs", "contacto": "Itextil", "cel": "11 3157-9989"}, {"nombre": "TEXTILES DEL SUR", "direccion": "Juan franciso segui 3545 piso 4", "localidad": "CABA", "horario": "", "contacto": "", "cel": ""}, {"nombre": "NODANLU", "direccion": "Centenera 3438, San Justo. La Matanza", "localidad": "La matanza", "horario": "", "contacto": "", "cel": ""}, {"nombre": "HYPE", "direccion": "Malvinas Argentinas 4674", "localidad": "Victoria", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Overprint", "direccion": "Av. Int. Francisco Rabanal 1615", "localidad": "Nueva Pompeya", "horario": "", "contacto": "Fernanda", "cel": "54 9 11 5422-7500"}, {"nombre": "DAVID TALLER TEXTIL", "direccion": "arregui 2312 entre caracas y Alfredo bufano", "localidad": "Paternal", "horario": "10 a 16", "contacto": "", "cel": "11 3908-6909"}, {"nombre": "BANIMTEX", "direccion": "Av. Gral. San Mart√≠n 3248", "localidad": "Lomas del Mirador", "horario": "9 a 13. Y 14 a 17", "contacto": "", "cel": ""}, {"nombre": "ARTINTEX", "direccion": "Av. Gaona 4016", "localidad": "CABA", "horario": "", "contacto": "", "cel": ""}, {"nombre": "MALDIVES", "direccion": "Berra 620", "localidad": "Castelar", "horario": "9 a 16hs", "contacto": "Mica", "cel": "11 2344-6836"}, {"nombre": "Formato A4", "direccion": "Emilio lamarca 4359", "localidad": "caba", "horario": "9:30 a 16hs.", "contacto": "", "cel": ""}, {"nombre": "TAPS TEJIDOS", "direccion": "Av Ricardo Balbin 1584", "localidad": "San Martin", "horario": "9 a 17 hs", "contacto": "", "cel": ""}, {"nombre": "Tejidos Del Rincon", "direccion": "Remedios 5199", "localidad": "CABA", "horario": "8 a 13hs", "contacto": "miguel", "cel": "11 4473-4336"}, {"nombre": "TODO AVIOS", "direccion": "Perdriel 3070 esq. Jose ambrini, villa maip√∫", "localidad": "San Martin", "horario": "8.30 a 16.30", "contacto": "Damian", "cel": "11 5183-4395"}, {"nombre": "LAVABIEN", "direccion": "Bacacay 5170 (entre Lope de Vega y Milton) Villa Luro", "localidad": "CABA", "horario": "8.30 a 13 o 14 a 17 hs", "contacto": "Gabriela", "cel": "11 3912-0718"}, {"nombre": "Artigas", "direccion": "Tucum√°n 2375", "localidad": "CABA", "horario": "9 a 13hrs y de 14 a 17hs", "contacto": "", "cel": ""}, {"nombre": "Llaveros Colgantes", "direccion": "Catamarca 24", "localidad": "Bella Vista", "horario": "9 a 16hs", "contacto": "", "cel": ""}, {"nombre": "BARTH", "direccion": "Dr rebizzo 4838", "localidad": "Caseros", "horario": "8 a 17", "contacto": "", "cel": "11 2860-9098"}, {"nombre": "VGO", "direccion": "Jos√© Evaristo Uriburu 544", "localidad": "CABA", "horario": "8:30 a 13 y de 13:30 a 16:30", "contacto": "", "cel": ""}, {"nombre": "GOFRADO", "direccion": "Humboldt 291", "localidad": "Palermo", "horario": "8 a 17hs", "contacto": "", "cel": "11 3607-8619"}, {"nombre": "TEXTIL ROCK", "direccion": "Lavalle 2421", "localidad": "caba", "horario": "9 a 17 45", "contacto": "", "cel": ""}, {"nombre": "Quick Color", "direccion": "Bartolom√© mitre 1353", "localidad": "CABA", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Taller Julieta", "direccion": "Ruperto mazza 837. Entre Uruguay y tte chapa", "localidad": "Tigre", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Quick color florida", "direccion": "Av san Mart√≠n 4128", "localidad": "Florida", "horario": "", "contacto": "", "cel": ""}, {"nombre": "PINLAND", "direccion": "Miguel de Unamuno 55 Quilmes oeste entre Lamadrid¬†y¬†Jujuy Quilmes", "localidad": "", "horario": "", "contacto": "", "cel": ""}, {"nombre": "POLGRAF", "direccion": "Sucre 2521", "localidad": "Beccar", "horario": "9 a 13 y de 14 a 18", "contacto": "Tomi o Diego", "cel": "11 6414-2233"}, {"nombre": "ALLINK", "direccion": "Ram√≥n Carrillo 2035", "localidad": "Rincon", "horario": "9 a 12 30 y 13 30 a 18", "contacto": "", "cel": "11 6584-8028"}, {"nombre": "UPrint", "direccion": "Arias 1691, CABA", "localidad": "CABA", "horario": "11 a 16:30", "contacto": "", "cel": ""}, {"nombre": "VIKLAND", "direccion": "Calle 95 #1060, entre Rodr√≠guez Pe√±a y V√©lez Sarsfield,", "localidad": "Villa Lynch", "horario": "8 30 a 15", "contacto": "", "cel": ""}, {"nombre": "CUSTOMLAND", "direccion": "Av. Sgto Cayetano Beliera 3025, Pilar. Dentro del Parque Empresarial Austral, la empresa de llama Customland, en el Flex III, modula 3 - A", "localidad": "Pilar", "horario": "", "contacto": "Edgard", "cel": "11 2434-0426"}, {"nombre": "RECONTRA RETRO", "direccion": "Av. Fondo de la Legua 2476", "localidad": "Martinez", "horario": "", "contacto": "Gustavo", "cel": "11 2597-0767"}, {"nombre": "CL TEJIDOS", "direccion": "Directorio 2306. Flores", "localidad": "CABA", "horario": "9a17", "contacto": "", "cel": ""}, {"nombre": "Nuevas Historias", "direccion": "Gurruchaga 440 6 A.", "localidad": "Villa Crespo", "horario": "10a18", "contacto": "majo", "cel": "11 3602-6190"}, {"nombre": "Bondeado Argentino", "direccion": "Marcelo Gamboa 6569 Versalles", "localidad": "CABA", "horario": "", "contacto": "", "cel": ""}, {"nombre": "Melina - parana taller textil", "direccion": "Pizarro 1410", "localidad": "Tigre", "horario": "", "contacto": "melina", "cel": "11 2335-8098"}, {"nombre": "Entoallarte", "direccion": "Bacacay 3745 2B Caba", "localidad": "13a18", "horario": "", "contacto": "Rosana", "cel": ""}, {"nombre": "Aldo Lavadero telas", "direccion": "Corbalan 1918", "localidad": "CABA", "horario": "8-13  14 -16", "contacto": "", "cel": "11 4444-1890"}, {"nombre": "Mundo Acrilico", "direccion": "Uruguay 268", "localidad": "CABA", "horario": "", "contacto": "FACUNDO", "cel": "11 5109-3934"}, {"nombre": "JUAN MADERAS", "direccion": "av elcano 2756", "localidad": "caba", "horario": "", "contacto": "", "cel": ""}, {"nombre": "FERITELAS", "direccion": "Lavalle 2476, C1052 Cdad. Aut√≥noma de Buenos Aires", "localidad": "CABA", "horario": "9 30 a 16 30", "contacto": "", "cel": "011 4951-3664"}, {"nombre": "LEO LAVADERO", "direccion": "Salom 377 Entre Alvarado y Australia", "localidad": "caba", "horario": "", "contacto": "Leo", "cel": ""}, {"nombre": "ARDUR", "direccion": "Azcuenaga 175 entre Mitre y Peron", "localidad": "Balvanera - CABA.", "horario": "10a21", "contacto": "", "cel": ""}];
const RUTAS_HISTORICAS = [];

let rutasDB  = {}; // Firebase rutas
let editingId = null;
let completadas = JSON.parse(localStorage.getItem('piola-completadas') || '{}');

// ============================================================
// TAB SWITCHING
// ============================================================
function switchTab(tab, el) {
  document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('section-' + tab).classList.add('active');
  document.getElementById('toolbar-rutas').style.display = tab === 'rutas' ? 'flex' : 'none';
  const dirToolbar = document.getElementById('toolbar-directorio');
  if (dirToolbar) dirToolbar.style.display = tab === 'directorio' ? 'flex' : 'none';
  if (tab === 'dia') {
    if (!document.getElementById('dia-fecha').value) {
      document.getElementById('dia-fecha').value = new Date().toISOString().split('T')[0];
    }
    renderDia();
  }
  if (tab === 'directorio') renderDirectorio();
}

// ============================================================
// RENDER RUTAS (historial + Firebase merged)
// ============================================================
function getAllRutas() {
  // Merge: historicas + Firebase (Firebase takes precedence by id)
  const hist = RUTAS_HISTORICAS.map((r, i) => ({ ...r, _source: 'hist', id: 'h' + i }));
  const fb   = Object.values(rutasDB).map(r => ({ ...r, _source: 'fb' }));
  return [...hist, ...fb].sort((a, b) => (b.fecha || '').localeCompare(a.fecha || ''));
}

function renderRutas() {
  const search  = (document.getElementById('search-rutas')?.value || '').toLowerCase();
  const desde   = document.getElementById('filter-fecha-desde')?.value || '';
  const hasta   = document.getElementById('filter-fecha-hasta')?.value || '';
  const urgente = document.getElementById('filter-urgente')?.value || '';

  let rutas = getAllRutas();

  if (search)  rutas = rutas.filter(r =>
    (r.marca||'').toLowerCase().includes(search) ||
    (r.campana||'').toLowerCase().includes(search) ||
    (r.localidad||'').toLowerCase().includes(search) ||
    (r.pedido||'').toLowerCase().includes(search)
  );
  if (desde)   rutas = rutas.filter(r => (r.fecha||'') >= desde);
  if (hasta)   rutas = rutas.filter(r => (r.fecha||'') <= hasta);
  if (urgente) rutas = rutas.filter(r => r.urgente);

  document.getElementById('rutas-count').textContent = rutas.length + ' parada' + (rutas.length !== 1 ? 's' : '');

  const tbody = document.getElementById('rutas-tbody');
  if (rutas.length === 0) {
    tbody.innerHTML = '';
    document.getElementById('rutas-empty').style.display = 'block';
    return;
  }
  document.getElementById('rutas-empty').style.display = 'none';

  tbody.innerHTML = rutas.map(r => {
    const isUrg = r.urgente;
    const canEdit = r._source === 'fb';
    const urgBtn = canEdit
      ? `<button class="urg-btn ${isUrg ? 'si' : 'no'}" onclick="toggleUrgente('${r.id}', ${!isUrg})" title="${isUrg ? 'Quitar urgencia' : 'Marcar urgente'}">${isUrg ? 'S√ç' : 'NO'}</button>`
      : `<span class="urg-btn ${isUrg ? 'si' : 'no'}" style="cursor:default;">${isUrg ? 'S√ç' : 'NO'}</span>`;
    const actions = canEdit
      ? `<td class="no-print" style="white-space:nowrap;">
           <button class="btn btn-secondary btn-sm" onclick="editParada('${r.id}')">‚úè</button>
           <button class="btn btn-danger btn-sm" style="margin-left:4px;" onclick="deleteParada('${r.id}')">√ó</button>
         </td>`
      : `<td class="no-print"></td>`;
    return `<tr>
      <td class="mono" style="white-space:nowrap;">${fmtFecha(r.fecha)}</td>
      <td style="font-weight:600;">${esc(r.marca)}</td>
      <td>${esc(r.direccion)}</td>
      <td>${esc(r.localidad)}</td>
      <td class="mono" style="white-space:nowrap;">${esc(r.horario)}</td>
      <td>${esc(r.contacto)}</td>
      <td class="mono">${esc(r.cel)}</td>
      <td style="max-width:220px;">${esc(r.pedido)}</td>
      <td>${esc(r.campana)}</td>
      <td class="mono">${esc(r.bultos)}</td>
      <td>${urgBtn}</td>
      ${actions}
    </tr>`;
  }).join('');
}

// ============================================================
// RENDER D√çA
// ============================================================
function renderDia() {
  const fecha = document.getElementById('dia-fecha')?.value;
  if (!fecha) return;

  document.getElementById('print-fecha-label').textContent = 'Ruta del ' + fmtFecha(fecha);

  const hist = RUTAS_HISTORICAS.filter(r => r.fecha === fecha).map((r, i) => ({ ...r, id: 'h' + i, _source: 'hist' }));
  const fb   = Object.values(rutasDB).filter(r => r.fecha === fecha).map(r => ({ ...r, _source: 'fb' }));
  const paradas = [...hist, ...fb];

  const tabla = document.getElementById('tabla-dia');
  const empty = document.getElementById('dia-empty');

  if (paradas.length === 0) {
    tabla.style.display = 'none';
    empty.style.display = 'block';
    return;
  }
  tabla.style.display = 'table';
  empty.style.display = 'none';

  const tbody = document.getElementById('dia-tbody');
  tbody.innerHTML = paradas.map((r, idx) => {
    const isUrg = r.urgente;
    const key  = fecha + '_' + r.id;
    const done = completadas[key];
    const cls  = done ? 'completada-row' : '';
    const canEdit = r._source === 'fb';
    const urgBtn = canEdit
      ? `<button class="urg-btn ${isUrg ? 'si' : 'no'}" onclick="toggleUrgente('${r.id}', ${!isUrg})" title="${isUrg ? 'Quitar urgencia' : 'Marcar urgente'}">${isUrg ? 'S√ç' : 'NO'}</button>`
      : `<span class="urg-btn ${isUrg ? 'si' : 'no'}" style="cursor:default;">${isUrg ? 'S√ç' : 'NO'}</span>`;
    return `<tr class="${cls}">
      <td class="mono no-print">${idx + 1}</td>
      <td style="font-weight:600;">${esc(r.marca)}</td>
      <td>${esc(r.direccion)}</td>
      <td>${esc(r.localidad)}</td>
      <td class="mono" style="white-space:nowrap;">${esc(r.horario)}</td>
      <td>${esc(r.contacto)}</td>
      <td class="mono">${esc(r.cel)}</td>
      <td style="max-width:200px;">${esc(r.pedido)}</td>
      <td>${esc(r.campana)}</td>
      <td class="mono">${esc(r.bultos)}</td>
      <td>${urgBtn}</td>
      <td class="no-print">
        <input type="checkbox" ${done ? 'checked' : ''} onchange="toggleCompletada('${key}', this.checked, this)" title="Marcar como completada" style="width:16px; height:16px; cursor:pointer; accent-color:var(--accent);">
        ${canEdit ? `<button class="btn btn-danger btn-sm" style="margin-left:4px;" onclick="deleteParada('${r.id}')">√ó</button>` : ''}
      </td>
    </tr>`;
  }).join('');
}

function toggleCompletada(key, checked, el) {
  completadas[key] = checked;
  localStorage.setItem('piola-completadas', JSON.stringify(completadas));
  const row = el.closest('tr');
  if (checked) row.classList.add('completada-row');
  else row.classList.remove('completada-row');
}

// ============================================================
// FORM
// ============================================================
function openForm(fecha = null) {
  editingId = null;
  document.getElementById('form-title').textContent = 'Nueva parada';
  document.getElementById('f-fecha').value = fecha || document.getElementById('dia-fecha')?.value || new Date().toISOString().split('T')[0];
  document.getElementById('f-urgente').value = '0';
  document.getElementById('f-marca').value = '';
  document.getElementById('f-direccion').value = '';
  document.getElementById('f-localidad').value = '';
  document.getElementById('f-horario').value = '';
  document.getElementById('f-contacto').value = '';
  document.getElementById('f-cel').value = '';
  document.getElementById('f-pedido').value = '';
  document.getElementById('f-campana').value = '';
  document.getElementById('f-bultos').value = '';
  document.getElementById('modal-form').classList.remove('hidden');
  setTimeout(() => document.getElementById('f-marca').focus(), 100);
}

function editParada(id) {
  const r = rutasDB[id];
  if (!r) return;
  editingId = id;
  document.getElementById('form-title').textContent = 'Editar parada';
  document.getElementById('f-fecha').value = r.fecha || '';
  document.getElementById('f-urgente').value = r.urgente ? '1' : '0';
  document.getElementById('f-marca').value = r.marca || '';
  document.getElementById('f-direccion').value = r.direccion || '';
  document.getElementById('f-localidad').value = r.localidad || '';
  document.getElementById('f-horario').value = r.horario || '';
  document.getElementById('f-contacto').value = r.contacto || '';
  document.getElementById('f-cel').value = r.cel || '';
  document.getElementById('f-pedido').value = r.pedido || '';
  document.getElementById('f-campana').value = r.campana || '';
  document.getElementById('f-bultos').value = r.bultos || '';
  document.getElementById('modal-form').classList.remove('hidden');
}

function closeForm() {
  document.getElementById('modal-form').classList.add('hidden');
  acHide();
}

async function saveParada() {
  const fecha    = document.getElementById('f-fecha').value;
  const marca    = document.getElementById('f-marca').value.trim();
  const direccion= document.getElementById('f-direccion').value.trim();
  const localidad= document.getElementById('f-localidad').value.trim();
  const horario  = document.getElementById('f-horario').value.trim();
  const contacto = document.getElementById('f-contacto').value.trim();
  const cel      = document.getElementById('f-cel').value.trim();
  const pedido   = document.getElementById('f-pedido').value.trim();
  const campana  = document.getElementById('f-campana').value.trim();
  const bultos   = document.getElementById('f-bultos').value.trim();
  const urgente  = document.getElementById('f-urgente').value === '1';

  if (!fecha) { toast('La fecha es obligatoria', 'error'); return; }
  if (!marca) { toast('La marca / proveedor es obligatoria', 'error'); return; }

  const btn = document.getElementById('btn-save');
  btn.disabled = true; btn.textContent = '‚è≥ Guardando...';

  try {
    const data = { fecha, marca, direccion, localidad, horario, contacto, cel, pedido, campana, bultos, urgente, savedAt: new Date().toISOString() };
    if (editingId) {
      await window._fbUpdateDoc(window._fbDoc(window._db, 'rutas', editingId), data);
      toast('‚úì Parada actualizada', 'success');
    } else {
      await window._fbAddDoc(window._fbCollection(window._db, 'rutas'), data);
      toast('‚úì Parada agregada', 'success');
    }
    closeForm();
  } catch(e) {
    toast('Error: ' + e.message, 'error');
  } finally {
    btn.disabled = false; btn.textContent = 'üíæ Guardar parada';
  }
}

async function deleteParada(id) {
  if (!confirm('¬øEliminar esta parada?')) return;
  try {
    await window._fbDeleteDoc(window._fbDoc(window._db, 'rutas', id));
    toast('Parada eliminada', 'success');
  } catch(e) { toast('Error: ' + e.message, 'error'); }
}

async function toggleUrgente(id, value) {
  try {
    await window._fbUpdateDoc(window._fbDoc(window._db, 'rutas', id), { urgente: value });
  } catch(e) { toast('Error: ' + e.message, 'error'); }
}

// ============================================================
// DIRECTORIO
// ============================================================
let dirDB = {}; // Firebase proveedores
let editingDirId = null;

// Combines static PROVEEDORES_DIR + Firebase directorio
function getAllProveedores() {
  const stat = PROVEEDORES_DIR.map((p, i) => ({ ...p, _source: 'static', id: 'p' + i }));
  const fb   = Object.values(dirDB).map(p => ({ ...p, _source: 'fb' }));
  return [...stat, ...fb].sort((a, b) => (a.nombre||'').localeCompare(b.nombre||''));
}

function renderDirectorio() {
  const search = (document.getElementById('search-dir')?.value || '').toLowerCase();
  let provs = getAllProveedores();
  if (search) provs = provs.filter(p =>
    (p.nombre||'').toLowerCase().includes(search) ||
    (p.localidad||'').toLowerCase().includes(search) ||
    (p.direccion||'').toLowerCase().includes(search)
  );

  const grid = document.getElementById('dir-grid');
  const empty = document.getElementById('dir-empty');

  if (provs.length === 0) {
    grid.style.display = 'none';
    empty.style.display = 'block';
    return;
  }
  grid.style.display = 'grid';
  empty.style.display = 'none';

  grid.innerHTML = provs.map(p => {
    const canEdit = p._source === 'fb';
    const actions = canEdit ? `
      <div class="dc-actions">
        <button class="btn btn-secondary btn-sm" onclick="editProveedor('${p.id}')">‚úè Editar</button>
        <button class="btn btn-danger btn-sm" onclick="deleteProveedor('${p.id}')">√ó Eliminar</button>
      </div>` : '';
    const meta = [p.horario, p.contacto, p.cel].filter(Boolean);
    return `<div class="dir-card">
      <div class="dc-nombre">${esc(p.nombre)}</div>
      ${p.direccion ? `<div class="dc-dir">üìç ${esc(p.direccion)}</div>` : ''}
      ${p.localidad ? `<div class="dc-loc">${esc(p.localidad)}</div>` : ''}
      ${meta.length ? `<div class="dc-meta">${meta.map(m => `<span class="dc-tag">${esc(m)}</span>`).join('<span class="dc-tag" style="color:var(--border)">¬∑</span>')}</div>` : ''}
      ${p.notas ? `<div class="dc-tag" style="margin-top:4px; color:var(--muted);">${esc(p.notas)}</div>` : ''}
      ${actions}
    </div>`;
  }).join('');
}

function openFormDir() {
  editingDirId = null;
  document.getElementById('dir-form-title').textContent = 'Nuevo proveedor';
  ['df-nombre','df-direccion','df-localidad','df-horario','df-contacto','df-cel','df-notas'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.getElementById('modal-dir').classList.remove('hidden');
  setTimeout(() => document.getElementById('df-nombre').focus(), 100);
}

function editProveedor(id) {
  const p = dirDB[id];
  if (!p) return;
  editingDirId = id;
  document.getElementById('dir-form-title').textContent = 'Editar proveedor';
  document.getElementById('df-nombre').value    = p.nombre    || '';
  document.getElementById('df-direccion').value = p.direccion || '';
  document.getElementById('df-localidad').value = p.localidad || '';
  document.getElementById('df-horario').value   = p.horario   || '';
  document.getElementById('df-contacto').value  = p.contacto  || '';
  document.getElementById('df-cel').value       = p.cel       || '';
  document.getElementById('df-notas').value     = p.notas     || '';
  document.getElementById('modal-dir').classList.remove('hidden');
}

function closeFormDir() {
  document.getElementById('modal-dir').classList.add('hidden');
}

async function saveProveedor() {
  const nombre = document.getElementById('df-nombre').value.trim();
  if (!nombre) { toast('El nombre es obligatorio', 'error'); return; }

  const data = {
    nombre,
    direccion: document.getElementById('df-direccion').value.trim(),
    localidad: document.getElementById('df-localidad').value.trim(),
    horario:   document.getElementById('df-horario').value.trim(),
    contacto:  document.getElementById('df-contacto').value.trim(),
    cel:       document.getElementById('df-cel').value.trim(),
    notas:     document.getElementById('df-notas').value.trim(),
    savedAt:   new Date().toISOString()
  };

  const btn = document.getElementById('btn-save-dir');
  btn.disabled = true; btn.textContent = '‚è≥ Guardando...';
  try {
    if (editingDirId) {
      await window._fbUpdateDoc(window._fbDoc(window._db, 'directorio', editingDirId), data);
      toast('‚úì Proveedor actualizado', 'success');
    } else {
      await window._fbAddDoc(window._fbCollection(window._db, 'directorio'), data);
      toast('‚úì Proveedor agregado', 'success');
    }
    closeFormDir();
  } catch(e) {
    toast('Error: ' + e.message, 'error');
  } finally {
    btn.disabled = false; btn.textContent = 'üíæ Guardar proveedor';
  }
}

async function deleteProveedor(id) {
  if (!confirm('¬øEliminar este proveedor del directorio?')) return;
  try {
    await window._fbDeleteDoc(window._fbDoc(window._db, 'directorio', id));
    toast('Proveedor eliminado', 'success');
  } catch(e) { toast('Error: ' + e.message, 'error'); }
}

// ============================================================
// AUTOCOMPLETE DIRECTORIO
// ============================================================
function acSearch(val) {
  const list = document.getElementById('ac-list');
  if (!val || val.length < 2) { acHide(); return; }
  const q = val.toLowerCase();
  const allProvs = getAllProveedores();
  const matches = allProvs.filter(p => p.nombre.toLowerCase().includes(q)).slice(0, 8);
  if (matches.length === 0) { acHide(); return; }
  list.innerHTML = matches.map(p => `
    <div class="autocomplete-item" onmousedown="acSelect(${JSON.stringify(p).replace(/"/g, '&quot;')})">
      <div class="ac-nombre">${p.nombre}</div>
      <div class="ac-sub">${[p.direccion, p.localidad].filter(Boolean).join(' ¬∑ ')}</div>
    </div>`).join('');
  list.style.display = 'block';
}

function acSelect(p) {
  document.getElementById('f-marca').value    = p.nombre;
  document.getElementById('f-direccion').value = p.direccion;
  document.getElementById('f-localidad').value = p.localidad;
  document.getElementById('f-horario').value   = p.horario;
  document.getElementById('f-contacto').value  = p.contacto;
  document.getElementById('f-cel').value       = p.cel;
  acHide();
}

function acHide() {
  document.getElementById('ac-list').style.display = 'none';
}

// ============================================================
// UTILS
// ============================================================
function fmtFecha(fecha) {
  if (!fecha) return '‚Äî';
  const [y, m, d] = fecha.split('-');
  return `${d}/${m}/${y}`;
}

function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function toast(msg, type) {
  if (type === 'error') {
    document.getElementById('toast-msg').textContent = msg;
    document.getElementById('toast-box').className = 'toast-box ' + type;
    document.getElementById('toast-overlay').classList.add('show');
  } else {
    let t = document.getElementById('toast-silent');
    if (!t) {
      t = document.createElement('div');
      t.id = 'toast-silent';
      t.style.cssText = 'position:fixed;bottom:24px;right:24px;background:var(--surface2);border:1px solid rgba(232,200,0,0.5);border-radius:8px;padding:12px 18px;font-size:13px;z-index:999;opacity:0;transform:translateY(20px);transition:all 0.3s;pointer-events:none;max-width:320px;color:var(--text);';
      document.body.appendChild(t);
    }
    t.textContent = msg;
    t.style.opacity = '1'; t.style.transform = 'translateY(0)';
    clearTimeout(t._timer);
    t._timer = setTimeout(() => { t.style.opacity='0'; t.style.transform='translateY(20px)'; }, 3000);
  }
}
function closeToast() { document.getElementById('toast-overlay').classList.remove('show'); }

function toggleTheme() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') === 'dark';
  html.setAttribute('data-theme', isDark ? 'light' : 'dark');
  document.getElementById('theme-btn').textContent = isDark ? 'üåô Oscuro' : '‚òÄÔ∏è Claro';
  localStorage.setItem('piola-theme', isDark ? 'light' : 'dark');
}
const savedTheme = localStorage.getItem('piola-theme');
if (savedTheme) {
  document.documentElement.setAttribute('data-theme', savedTheme);
  document.getElementById('theme-btn').textContent = savedTheme === 'light' ? 'üåô Oscuro' : '‚òÄÔ∏è Claro';
}

// Init dia date
window.addEventListener('load', () => {
  document.getElementById('dia-fecha').value = new Date().toISOString().split('T')[0];
  renderDia();
});
</script>
</body>
</html>