<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cotizador Piola</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,700;0,800;1,700;1,800&family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0c0c0f;
    --surface: #141418;
    --surface2: #1c1c22;
    --surface3: #242430;
    --border: #2a2a38;
    --accent: #e8c800;
    --accent2: #57c8ff;
    --danger: #ff5757;
    --warn: #ffb857;
    --text: #e8e8f0;
    --muted: #6b6b80;
    --muted2: #4a4a5a;
    --col-cost: #ff8fa3;
    --col-fin: #57c8ff;
    --col-sale: #e8c800;
    --font-body: 'Syne', sans-serif;
    --font-mono: 'DM Mono', monospace;
    --font-display: 'Barlow Condensed', sans-serif;
  }

  :root[data-theme="light"] {
    --bg: #f0f0f5;
    --surface: #ffffff;
    --surface2: #f4f4f8;
    --surface3: #eaeaf0;
    --border: #dcdce8;
    --accent: #b89a00;
    --accent2: #0077aa;
    --danger: #cc2200;
    --warn: #cc7700;
    --text: #1a1a2e;
    --muted: #70708a;
    --muted2: #a0a0b8;
    --col-cost: #cc3355;
    --col-fin: #0077aa;
    --col-sale: #b89a00;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-body);
    font-size: 13px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* TOPBAR */
  .topbar {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 28px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .logo {
    font-family: var(--font-display);
    font-size: 22px;
    color: var(--text);
    letter-spacing: -0.5px;
  }
  .logo span { color: var(--accent); }
  .topbar-actions { display: flex; gap: 10px; align-items: center; }
  .dolar-badge {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 5px 12px;
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s;
  }
  .dolar-badge:hover { border-color: var(--accent); color: var(--accent); }
  .dolar-badge .val { color: var(--accent); font-weight: 500; margin-left: 4px; }

  /* TABS */
  .tabs {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 28px;
    display: flex;
    gap: 2px;
  }
  .tab {
    padding: 12px 20px;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    color: var(--muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  /* MAIN LAYOUT */
  .main { padding: 24px 28px; max-width: 1600px; margin: 0 auto; }

  /* PANEL */
  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    margin-bottom: 16px;
  }
  .panel-header {
    padding: 14px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--surface2);
  }
  .panel-title {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1.2px;
    text-transform: uppercase;
    color: var(--muted);
  }
  .panel-body { padding: 24px 28px; }

  /* FORM GRID */
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 14px;
  }
  .form-grid.cols-2 { grid-template-columns: 1fr 1fr; }
  .form-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
  .form-group { display: flex; flex-direction: column; gap: 8px; }
  .form-group label {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    color: var(--muted);
  }
  .form-control {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    padding: 8px 12px;
    font-family: var(--font-body);
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
  }
  /* Ocultar steppers en todos los number inputs */
  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  input[type=number] { -moz-appearance: textfield; appearance: textfield; }
  .form-control:focus { border-color: var(--accent); }
  .form-control.readonly {
    background: var(--bg);
    color: var(--muted);
    cursor: not-allowed;
  }
  .form-control.calculated {
    background: rgba(232,200,0,0.05);
    border-color: rgba(232,200,0,0.2);
    color: var(--accent);
    font-family: var(--font-mono);
  }

  /* ID BADGE */
  .id-badge {
    background: linear-gradient(135deg, rgba(232,200,0,0.15), rgba(87,200,255,0.08));
    border: 1px solid rgba(232,200,0,0.3);
    border-radius: 6px;
    padding: 8px 12px;
    font-family: var(--font-mono);
    font-size: 14px;
    font-weight: 500;
    color: var(--accent);
    letter-spacing: 2px;
  }

  /* GLOBAL VARS STRIP */
  .global-vars {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 20px;
    display: flex;
    gap: 20px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }
  .gvar {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
  }
  .gvar-label {
    color: var(--muted);
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.6px;
    text-transform: uppercase;
  }
  .gvar input {
    background: var(--surface3);
    border: 1px solid var(--border);
    border-radius: 5px;
    color: var(--text);
    padding: 5px 10px;
    font-family: var(--font-mono);
    font-size: 12px;
    outline: none;
    width: 120px;
    transition: border-color 0.2s;
  }
  .gvar input:focus { border-color: var(--accent); }
  .sep { width: 1px; height: 28px; background: var(--border); }

  /* ITEMS TABLE */
  .table-wrapper { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 12px; }
  thead tr { background: var(--surface3); }
  thead th {
    padding: 10px 10px;
    text-align: left;
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    color: var(--muted);
    white-space: nowrap;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
  }
  thead th.calc { color: var(--accent); opacity: 0.7; }
  tbody tr { border-bottom: 1px solid rgba(42,42,56,0.5); transition: background 0.15s; }
  tbody tr:hover { background: rgba(255,255,255,0.02); }
  td {
    padding: 6px 6px;
    vertical-align: middle;
  }
  td input, td select {
    background: transparent;
    border: 1px solid transparent;
    border-radius: 4px;
    color: var(--text);
    padding: 4px 6px;
    font-family: var(--font-body);
    font-size: 12px;
    outline: none;
    width: 100%;
    transition: all 0.15s;
  }
  td input:focus, td select:focus {
    background: var(--surface3);
    border-color: var(--accent);
  }
  .badge-borrador  { background: rgba(107,107,128,0.2); color: var(--muted); border: 1px solid rgba(107,107,128,0.3); }
  .badge-enviada   { background: rgba(87,200,255,0.15); color: var(--col-fin); border: 1px solid rgba(87,200,255,0.3); }
  .badge-aprobada  { background: rgba(87,255,143,0.15); color: #57ff8f; border: 1px solid rgba(87,255,143,0.3); }
  .badge-rechazada { background: rgba(255,87,87,0.15);  color: var(--danger); border: 1px solid rgba(255,87,87,0.3); }
  td.calc-cell.warn { color: var(--warn); }
  td.calc-cell.danger { color: var(--danger); }
  td.calc-cell.cost  { color: var(--col-cost); }
  td.calc-cell.fin   { color: var(--col-fin); }
  td.calc-cell.sale  { color: var(--col-sale); font-weight: 700; }
  td select option { background: var(--surface2); }
  .row-num {
    width: 28px;
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--muted2);
    text-align: center;
  }
  .del-btn {
    background: none;
    border: none;
    color: var(--muted2);
    cursor: pointer;
    padding: 4px 6px;
    border-radius: 4px;
    font-size: 14px;
    transition: all 0.2s;
  }
  .del-btn:hover { color: var(--danger); background: rgba(255,87,87,0.1); }

  /* ADD ROW */
  .add-row-btn {
    background: none;
    border: 1px dashed var(--border);
    border-radius: var(--radius);
    color: var(--muted);
    padding: 10px;
    width: 100%;
    cursor: pointer;
    font-family: var(--font-body);
    font-size: 12px;
    transition: all 0.2s;
    margin-top: 8px;
  }
  .add-row-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(232,200,0,0.03); }

  /* SUMMARY CARDS */
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px;
  }
  .sum-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
  }
  .sum-card.highlight {
    border-color: rgba(232,200,0,0.3);
    background: rgba(232,200,0,0.05);
  }
  .sum-card.danger-card {
    border-color: rgba(255,87,87,0.3);
    background: rgba(255,87,87,0.05);
  }
  .sum-label {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 8px;
  }
  .sum-value {
    font-family: var(--font-mono);
    font-size: 18px;
    font-weight: 500;
    color: var(--text);
  }
  .sum-card.highlight .sum-value { color: var(--accent); }
  .sum-card.danger-card .sum-value { color: var(--danger); }
  .sum-sub {
    font-size: 10px;
    color: var(--muted);
    margin-top: 4px;
  }

  /* RENTABILIDAD */
  .rent-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  .deduction-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
  }
  .deduction-row:last-child { border-bottom: none; }
  .deduction-label { color: var(--muted); }
  .deduction-val { font-family: var(--font-mono); color: var(--text); }
  .deduction-val.red { color: var(--danger); }
  .deduction-val.green { color: var(--accent); }
  .ganancia-bar {
    height: 8px;
    background: var(--surface3);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 12px;
  }
  .ganancia-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease;
    background: var(--accent);
  }
  .ganancia-fill.warn { background: var(--warn); }
  .ganancia-fill.bad { background: var(--danger); }

  /* BUTTONS */
  .btn {
    padding: 9px 18px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-family: var(--font-body);
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.5px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .btn-primary {
    background: var(--accent);
    color: var(--bg);
  }
  .btn-primary:hover { background: #d4ff7a; transform: translateY(-1px); }
  .btn-secondary {
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger {
    background: rgba(255,87,87,0.15);
    color: var(--danger);
    border: 1px solid rgba(255,87,87,0.3);
  }

  /* PDF VIEW */
  .pdf-preview {
    background: #fff;
    color: #111;
    border-radius: var(--radius);
    padding: 40px;
    font-family: 'Helvetica Neue', sans-serif;
    max-width: 800px;
    margin: 0 auto;
  }
  .pdf-preview h1 { font-size: 24px; color: #111; margin-bottom: 4px; }
  .pdf-preview .pdf-meta { font-size: 12px; color: #666; margin-bottom: 30px; }
  .pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
  .pdf-table th {
    background: #111;
    color: #fff;
    padding: 10px 12px;
    text-align: left;
    font-size: 11px;
    letter-spacing: 0.8px;
    text-transform: uppercase;
  }
  .pdf-table td { padding: 10px 12px; border-bottom: 1px solid #eee; font-size: 13px; }
  .pdf-table tr:last-child td { border-bottom: none; }
  .pdf-total-row td { font-weight: bold; background: #f5f5f5; }
  .pdf-conditions {
    background: #f9f9f9;
    border-left: 3px solid #111;
    padding: 12px 16px;
    font-size: 12px;
    color: #555;
  }

  /* SECTION */
  .view { display: none; }
  .view.active { display: block; }

  /* BADGE */
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }
  .badge-green { background: rgba(232,200,0,0.15); color: var(--accent); }
  .badge-red { background: rgba(255,87,87,0.15); color: var(--danger); }
  .badge-warn { background: rgba(255,184,87,0.15); color: var(--warn); }

  /* TOAST */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 20px;
    font-size: 13px;
    z-index: 999;
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s;
  }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.success { border-color: rgba(232,200,0,0.4); }

  /* ALERT */
  .alert {
    border-radius: var(--radius);
    padding: 12px 16px;
    font-size: 12px;
    display: flex;
    gap: 10px;
    align-items: flex-start;
    margin-bottom: 12px;
  }
  .alert-warn { background: rgba(255,184,87,0.1); border: 1px solid rgba(255,184,87,0.3); color: var(--warn); }
  .alert-danger { background: rgba(255,87,87,0.1); border: 1px solid rgba(255,87,87,0.3); color: var(--danger); }
  .alert-ok { background: rgba(232,200,0,0.08); border: 1px solid rgba(232,200,0,0.25); color: var(--accent); }

  /* CFT TABLE */
  .cft-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
  .cft-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .cft-item:hover { border-color: var(--accent); }
  .cft-item.selected { background: rgba(232,200,0,0.08); border-color: var(--accent); }
  .cft-plazo { color: var(--muted); font-size: 11px; }
  .cft-rate { font-family: var(--font-mono); color: var(--accent); font-weight: 500; }

  .flex-between { display: flex; justify-content: space-between; align-items: center; }
  .gap-8 { gap: 8px; }
  .flex { display: flex; }
  .mt-12 { margin-top: 12px; }
  .mb-16 { margin-bottom: 16px; }
  hr.sep-line { border: none; border-top: 1px solid var(--border); margin: 16px 0; }

  @media print {
    body { background: #fff; }
    .topbar, .tabs, .global-vars, .panel:not(.pdf-panel) { display: none; }
    .pdf-preview { box-shadow: none; }
  }
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div style="display:flex; align-items:center; gap:12px;">
    <a href="index.html" style="background:var(--surface2); border:1px solid var(--border); color:var(--muted); border-radius:8px; padding:6px 12px; font-size:12px; font-weight:600; text-decoration:none;">‚Üê Inicio</a>
    <div class="logo">Cotizador <span>¬∑</span> Piola</div>
  </div>
  <div class="topbar-actions">
    <div class="dolar-badge" onclick="fetchDolar()" title="Click para actualizar">
      <span style="color:var(--muted); font-size:11px; font-weight:600; margin-right:6px;">D√≥lar:</span>
      üíµ CCL: <span class="val" id="dolar-ccl">‚Äî</span>
      &nbsp;|&nbsp; Oficial: <span class="val" id="dolar-of">‚Äî</span>
      <span style="font-size:9px; color:var(--muted2); margin-left:6px;" id="dolar-time">‚Üª actualizar</span>
    </div>
    <button id="theme-btn" onclick="toggleTheme()" class="btn btn-secondary">‚òÄÔ∏è Claro</button>
    <button class="btn btn-secondary" onclick="nuevaCotizacion()" style="border-color:rgba(232,200,0,0.2); color:var(--muted);">+ Nueva</button>
    <button class="btn btn-secondary" onclick="saveQuote()">üíæ Guardar</button>
    <button class="btn btn-primary" onclick="showView('pdf')">üìÑ Generar PDF</button>
  </div>
</div>

<!-- TABS -->
<div class="tabs">
  <div class="tab active" onclick="showView('editor', this)">‚úèÔ∏è Editor</div>
  <div class="tab" onclick="showView('dashboard', this)">üìä Dashboard</div>
  <div class="tab" onclick="showView('rentabilidad', this)">üí∞ Rentabilidad</div>
  <div class="tab" onclick="showView('cft', this)">üìà CFT</div>
  <div class="tab" onclick="showView('pdf', this)">üñ® Vista Cliente</div>
</div>

<div class="main">

<!-- ===================== EDITOR VIEW ===================== -->
<div class="view active" id="view-editor">

  <!-- CABECERA -->
  <div class="panel mb-16">
    <div class="panel-header" style="padding:12px 16px;">
      <span class="id-badge" id="display-id">COT-0001</span>
    </div>
    <div class="panel-body">
      <div class="form-grid" style="grid-template-columns: repeat(auto-fill, minmax(210px, 1fr)); gap:20px 40px;">
        <div class="form-group">
          <label>Fecha</label>
          <input type="date" class="form-control" id="f-fecha">
        </div>
        <div class="form-group">
          <label>Cliente</label>
          <input type="text" class="form-control" id="f-cliente" placeholder="Nombre del cliente">
        </div>
        <div class="form-group">
          <label>Proyecto</label>
          <input type="text" class="form-control" id="f-proyecto" placeholder="Nombre del proyecto">
        </div>
        <div class="form-group">
          <label>Marca</label>
          <input type="text" class="form-control" id="f-marca" placeholder="Marca">
        </div>
        <div class="form-group">
          <label>Contacto</label>
          <input type="text" class="form-control" id="f-contacto" placeholder="Nombre y apellido">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" class="form-control" id="f-email" placeholder="email@empresa.com">
        </div>
        <div class="form-group">
          <label>Vendedor <span style="color:var(--accent)">*</span></label>
          <input type="text" class="form-control" id="f-vendedor" placeholder="Vendedor responsable" required>
        </div>
        <div class="form-group">
          <label>Entrega</label>
          <input type="date" class="form-control" id="f-entrega">
        </div>
        <div class="form-group">
          <label>Condici√≥n Comercial</label>
          <select class="form-control" id="f-condicion" onchange="recalcAll()">
            <option value="0">Contado (0%)</option>
            <option value="2.88">30 d√≠as (2.88%)</option>
            <option value="5.83">60 d√≠as (5.83%)</option>
            <option value="8.84">90 d√≠as (8.84%)</option>
            <option value="12.18">120 d√≠as (12.18%)</option>
            <option value="15.61">150 d√≠as (15.61%)</option>
            <option value="19.15">180 d√≠as (19.15%)</option>
            <option value="26.56">270 d√≠as (26.56%)</option>
            <option value="35.00">365 d√≠as (35.00%)</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- VARIABLES GLOBALES -->
  <div class="global-vars mb-16">
    <span style="font-size:10px; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--muted)">Variables Globales</span>
    <div class="sep"></div>
    <div class="gvar">
      <span class="gvar-label">D√≥lar CCL</span>
      <input type="number" id="g-dolar-ccl" value="1265" onchange="recalcAll()">
    </div>
    <div class="gvar">
      <span class="gvar-label">D√≥lar Oficial</span>
      <input type="number" id="g-dolar-of" value="1050" onchange="recalcAll()">
    </div>
    <div class="sep"></div>
    <div class="gvar">
      <span class="gvar-label">Log√≠stica Base $</span>
      <input type="number" id="g-logistica" value="20000" onchange="recalcAll()">
    </div>
    <div class="gvar">
      <span class="gvar-label">Dep√≥sito %</span>
      <input type="number" id="g-depo" value="2" step="0.1" onchange="recalcAll()">
    </div>
    <div class="sep"></div>
    <div class="gvar">
      <span class="gvar-label">Comisi√≥n Agencia %</span>
      <input type="number" id="g-comision" value="0" min="0" step="0.5" onchange="recalcAll()">
    </div>
    <div class="sep"></div>
    <div class="gvar">
      <span class="gvar-label">IVA %</span>
      <input type="number" id="g-iva" value="21" step="0.5" onchange="recalcAll()">
    </div>
  </div>

  <!-- TABLA √çTEMS -->
  <div class="panel">
    <div class="panel-header">
      <span class="panel-title">Tabla de √çtems</span>
      <div style="display:flex; gap:8px;">
        <span id="items-count" style="font-size:11px; color:var(--muted); font-family:var(--font-mono)">0 √≠tems</span>
      </div>
    </div>
    <div class="panel-body" style="padding: 0;">
      <div class="table-wrapper">
        <table id="items-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Proveedor</th>
              <th>Descripci√≥n</th>
              <th>Cant. Cliente</th>
              <th title="Unidades extra internas (ocultas al cliente)">Extra ¬±</th>
              <th>Costo Unit.</th>
              <th class="calc" style="color:var(--col-cost)">Dep√≥sito %</th>
              <th>Cant. Log.</th>
              <th class="calc" style="color:var(--col-cost)" title="Costo total incluyendo log√≠stica y dep√≥sito">C.Total</th>
              <th class="calc" style="color:var(--col-sale)">Margen %</th>
              <th class="calc" style="color:var(--col-sale)">Venta Unit.</th>
              <th class="calc" style="color:var(--col-fin)">Financ.</th>
              <th class="calc" style="color:var(--col-fin)">Com.Ag.</th>
              <th class="calc" style="color:var(--col-sale)">Venta Final</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="items-tbody">
          </tbody>
        </table>
      </div>
      <div style="padding: 12px 16px;">
        <button onclick="addRow()" style="background:rgba(232,200,0,0.12); border:1px solid rgba(232,200,0,0.3); color:var(--accent); border-radius:8px; padding:10px 20px; font-family:var(--font-body); font-size:13px; font-weight:700; cursor:pointer; transition:all 0.2s; display:inline-flex; align-items:center; gap:8px;" onmouseover="this.style.background='rgba(232,200,0,0.22)'" onmouseout="this.style.background='rgba(232,200,0,0.12)'">Ôºã Agregar √≠tem</button>
      </div>
    </div>
  </div>

  <!-- TOTALES -->
  <div class="summary-grid mt-12" id="summary-cards">
    <div class="sum-card">
      <div class="sum-label">Costo Total Proveedor</div>
      <div class="sum-value" id="s-costo-total">$0</div>
      <div class="sum-sub">Sin m√°rgenes</div>
    </div>
    <div class="sum-card">
      <div class="sum-label">Venta Total (sin IVA)</div>
      <div class="sum-value" id="s-venta-total">$0</div>
    </div>
    <div class="sum-card highlight">
      <div class="sum-label">Venta Total + IVA</div>
      <div class="sum-value" id="s-venta-iva">$0</div>
    </div>
    <div class="sum-card">
      <div class="sum-label">Margen Bruto $</div>
      <div class="sum-value" id="s-margen-bruto">$0</div>
    </div>
    <div class="sum-card">
      <div class="sum-label">Margen Bruto %</div>
      <div class="sum-value" id="s-margen-pct">0%</div>
    </div>
    <div class="sum-card" id="s-card-costo-pct">
      <div class="sum-label">Costo / Venta</div>
      <div class="sum-value" id="s-costo-pct">0%</div>
      <div class="sum-sub">‚ö† Alerta si &gt; 50%</div>
    </div>
  </div>
</div>

<!-- ===================== DASHBOARD VIEW ===================== -->
<div class="view" id="view-dashboard">
  <div class="panel">
    <div class="panel-header"><span class="panel-title">Dashboard ‚Äî Campa√±a</span></div>
    <div class="panel-body">
      <div class="summary-grid" id="dash-cards" style="margin-bottom:20px;"></div>
      <hr class="sep-line">
      <div id="dash-alert"></div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:16px;">
        <div>
          <div class="panel-title" style="margin-bottom:14px;">Composici√≥n del Precio Final</div>
          <div id="price-breakdown"></div>
        </div>
        <div>
          <div class="panel-title" style="margin-bottom:14px;">√çtems por Costo</div>
          <div id="items-bars"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===================== RENTABILIDAD VIEW ===================== -->
<div class="view" id="view-rentabilidad">
  <div class="panel">
    <div class="panel-header"><span class="panel-title">Calculador de Rentabilidad</span></div>
    <div class="panel-body">
      <div class="rent-grid">
        <div>
          <div id="rent-alerts"></div>
          <div class="deduction-row">
            <span class="deduction-label">Venta Total (sin IVA)</span>
            <span class="deduction-val" id="r-venta">$0</span>
          </div>
          <div class="deduction-row">
            <span class="deduction-label">Costo Proveedor</span>
            <span class="deduction-val red" id="r-costo">$0</span>
          </div>
          <div class="deduction-row">
            <span class="deduction-label">Margen Bruto</span>
            <span class="deduction-val green" id="r-margen-bruto">$0</span>
          </div>
          <hr class="sep-line">
          <div class="deduction-row">
            <span class="deduction-label">‚Äî Costo Equipo (23%)</span>
            <span class="deduction-val red" id="r-equipo">$0</span>
          </div>
          <div class="deduction-row">
            <span class="deduction-label">‚Äî Estructura (7%)</span>
            <span class="deduction-val red" id="r-estructura">$0</span>
          </div>
          <div class="deduction-row">
            <span class="deduction-label">‚Äî IIBB (4%)</span>
            <span class="deduction-val red" id="r-iibb">$0</span>
          </div>
          <div class="deduction-row">
            <span class="deduction-label">‚Äî IIGG (30%)</span>
            <span class="deduction-val red" id="r-iigg">$0</span>
          </div>
          <hr class="sep-line">
          <div class="deduction-row" style="font-size:15px;">
            <span style="color:var(--text); font-weight:700;">Ganancia Neta</span>
            <span class="deduction-val green" id="r-neta" style="font-size:15px;">$0</span>
          </div>
          <div class="deduction-row">
            <span class="deduction-label">Ganancia Neta %</span>
            <span class="deduction-val" id="r-neta-pct">0%</span>
          </div>
          <div class="ganancia-bar"><div class="ganancia-fill" id="r-bar" style="width:0%"></div></div>
          <div style="font-size:10px; color:var(--muted); margin-top:4px;">M√≠nimo requerido: 10%</div>
        </div>
        <div>
          <div class="panel-title" style="margin-bottom:14px;">Configuraci√≥n de Deducciones</div>
          <div class="form-grid cols-2">
            <div class="form-group">
              <label>Costo Equipo %</label>
              <input type="number" class="form-control" id="d-equipo" value="23" onchange="updateRentabilidad()">
            </div>
            <div class="form-group">
              <label>Estructura %</label>
              <input type="number" class="form-control" id="d-estructura" value="7" onchange="updateRentabilidad()">
            </div>
            <div class="form-group">
              <label>IIBB %</label>
              <input type="number" class="form-control" id="d-iibb" value="4" onchange="updateRentabilidad()">
            </div>
            <div class="form-group">
              <label>IIGG %</label>
              <input type="number" class="form-control" id="d-iigg" value="30" onchange="updateRentabilidad()">
            </div>
            <div class="form-group">
              <label>Ganancia M√≠nima (BP) %</label>
              <input type="number" class="form-control" id="d-minima" value="10" onchange="updateRentabilidad()">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===================== CFT VIEW ===================== -->
<div class="view" id="view-cft">
  <div class="panel">
    <div class="panel-header">
      <span class="panel-title">Tabla CFT ‚Äî Costo Financiero Total</span>
      <span style="font-size:11px; color:var(--muted)">Seleccionada en Condici√≥n Comercial</span>
    </div>
    <div class="panel-body">
      <div class="cft-grid" id="cft-grid"></div>
    </div>
  </div>
</div>


<!-- ===================== PDF VIEW ===================== -->
<div class="view" id="view-pdf">
  <div style="display:flex; gap:10px; justify-content:flex-end; margin-bottom:16px;">
    <button class="btn btn-secondary" onclick="showView('editor', document.querySelector('.tab'))">‚Üê Volver</button>
    <button class="btn btn-primary" onclick="window.print()">üñ® Imprimir / Guardar PDF</button>
  </div>
  <div class="pdf-preview" id="pdf-content"></div>
</div>

</div><!-- end main -->

<!-- DATALIST para autocomplete de productos -->
<datalist id="productos-datalist"></datalist>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script type="module">
// ============================================================
// FIREBASE CONFIG
// ============================================================
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, collection, doc, getDocs, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, runTransaction } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyAQNT8-8Q5v7Tfn9MIy530RSHdZj6Am390",
  authDomain: "piola-cotizador.firebaseapp.com",
  projectId: "piola-cotizador",
  storageBucket: "piola-cotizador.firebasestorage.app",
  messagingSenderId: "881054830595",
  appId: "1:881054830595:web:3d138a4952bba717d63e36"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

window._db          = db;
window._fbCollection= collection;
window._fbDoc       = doc;
window._fbGetDocs   = getDocs;
window._fbAddDoc    = addDoc;
window._fbUpdateDoc = updateDoc;
window._fbDeleteDoc = deleteDoc;
window._fbOnSnapshot= onSnapshot;
window._fbQuery     = query;
window._fbOrderBy   = orderBy;
window._fbRunTransaction = runTransaction;

// Iniciar listener de cotizaciones en tiempo real
window.addEventListener('load', () => {
  window._fbOnSnapshot(
    window._fbQuery(window._fbCollection(window._db, 'cotizaciones'), window._fbOrderBy('savedAt', 'desc')),
    snap => {
      window._quotesDB = {};
      snap.forEach(d => window._quotesDB[d.id] = { firebaseId: d.id, ...d.data() });
      if (typeof renderHistorial === 'function') renderHistorial();
      // Detectar si venimos de historial con una cotizaci√≥n para editar
      const editId = localStorage.getItem('piola-edit-id');
      if (editId && window._quotesDB[editId]) {
        localStorage.removeItem('piola-edit-id');
        loadQuote(editId);
      }
    },
    err => console.error('Error cotizaciones:', err)
  );
});
</script>

<script>
// ============================================================
// DATA
// ============================================================
const CFT_TABLE = [
  { plazo: 'Contado', dias: 0, rate: 0 },
  { plazo: '30 d√≠as', dias: 30, rate: 2.88 },
  { plazo: '60 d√≠as', dias: 60, rate: 5.83 },
  { plazo: '90 d√≠as', dias: 90, rate: 8.84 },
  { plazo: '120 d√≠as', dias: 120, rate: 12.18 },
  { plazo: '150 d√≠as', dias: 150, rate: 15.61 },
  { plazo: '180 d√≠as', dias: 180, rate: 19.15 },
  { plazo: '270 d√≠as', dias: 270, rate: 26.56 },
  { plazo: '365 d√≠as', dias: 365, rate: 35.00 },
];

let items = [];
let nextId = 1;
let quoteCounter = parseInt(localStorage.getItem('piola-counter') || '1');
let productosDB = [];
let materialesDB = [];

// ============================================================
// INIT
// ============================================================
window.onload = async () => {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('f-fecha').value = today;
  document.getElementById('display-id').textContent = 'COT-????';
  buildCFTGrid();
  buildDatalist();
  addRow();
  fetchDolar();
  await loadProductosFromFirebase();
};

// ============================================================
// NAVIGATION
// ============================================================
function showView(name, tabEl) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-' + name).classList.add('active');
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  if (tabEl) tabEl.classList.add('active');
  if (name === 'dashboard') updateDashboard();
  if (name === 'rentabilidad') updateRentabilidad();
  if (name === 'pdf') buildPDF();
}

// ============================================================
// D√ìLAR
// ============================================================
async function fetchDolar() {
  const timeEl = document.getElementById('dolar-time');
  timeEl.textContent = '‚Üª cargando...';

  // Cada estrategia intenta una fuente diferente con su propio parser
  const strategies = [

    // 1. dolarapi.com ‚Äî directo (funciona si hay CORS habilitado)
    async () => {
      const r = await fetch('https://dolarapi.com/v1/dolares');
      const d = await r.json();
      return {
        ccl:     d.find(x => x.casa === 'contadoconliqui')?.venta,
        oficial: d.find(x => x.casa === 'oficial')?.venta,
      };
    },

    // 2. dolarapi.com via corsproxy.io
    async () => {
      const url = 'https://dolarapi.com/v1/dolares';
      const r = await fetch('https://corsproxy.io/?' + encodeURIComponent(url));
      const d = await r.json();
      return {
        ccl:     d.find(x => x.casa === 'contadoconliqui')?.venta,
        oficial: d.find(x => x.casa === 'oficial')?.venta,
      };
    },

    // 3. ambito.com API p√∫blica
    async () => {
      const [rCCL, rOf] = await Promise.all([
        fetch('https://mercados.ambito.com//dolar/contado-con-liquidacion/variacion'),
        fetch('https://mercados.ambito.com//dolar/oficial/variacion'),
      ]);
      const [dCCL, dOf] = await Promise.all([rCCL.json(), rOf.json()]);
      const parsePeso = v => parseFloat(String(v).replace(/\./g,'').replace(',','.'));
      return {
        ccl:     parsePeso(dCCL?.venta),
        oficial: parsePeso(dOf?.venta),
      };
    },

    // 4. bluelytics.com.ar ‚Äî p√∫blica sin auth
    async () => {
      const r = await fetch('https://api.bluelytics.com.ar/v2/latest');
      const d = await r.json();
      return {
        ccl:     d?.blue?.value_sell,   // blue como proxy de CCL cuando no hay ccl
        oficial: d?.official?.value_sell,
      };
    },

    // 5. allorigins proxy sobre dolarapi
    async () => {
      const url = 'https://dolarapi.com/v1/dolares';
      const r = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(url));
      const d = await r.json();
      return {
        ccl:     d.find(x => x.casa === 'contadoconliqui')?.venta,
        oficial: d.find(x => x.casa === 'oficial')?.venta,
      };
    },
  ];

  let success = false;
  for (let i = 0; i < strategies.length; i++) {
    try {
      const result = await Promise.race([
        strategies[i](),
        new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 5000))
      ]);
      const ccl = result?.ccl;
      const oficial = result?.oficial;
      if (ccl && ccl > 0) {
        document.getElementById('dolar-ccl').textContent = '$' + fmtN(ccl);
        document.getElementById('g-dolar-ccl').value = ccl;
      }
      if (oficial && oficial > 0) {
        document.getElementById('dolar-of').textContent = '$' + fmtN(oficial);
        document.getElementById('g-dolar-of').value = oficial;
      }
      if ((ccl && ccl > 0) || (oficial && oficial > 0)) {
        timeEl.textContent = '‚úì ' + new Date().toLocaleTimeString('es-AR', {hour:'2-digit',minute:'2-digit'});
        recalcAll();
        toast('Cotizaci√≥n actualizada', 'success');
        success = true;
        break;
      }
    } catch(e) {
      // siguiente estrategia
    }
  }

  if (!success) {
    timeEl.textContent = '‚ö† manual';
    toast('No se pudo obtener cotizaci√≥n autom√°tica. Ingres√° los valores manualmente.', '');
  }
}

// ============================================================
// CFT GRID
// ============================================================
function buildCFTGrid() {
  const sel = parseFloat(document.getElementById('f-condicion').value);
  const grid = document.getElementById('cft-grid');
  grid.innerHTML = CFT_TABLE.map(c => `
    <div class="cft-item ${c.rate === sel ? 'selected' : ''}" onclick="selectCFT(${c.rate})">
      <span class="cft-plazo">${c.plazo}</span>
      <span class="cft-rate">${c.rate === 0 ? '0%' : '+' + c.rate + '%'}</span>
    </div>
  `).join('');
}

function selectCFT(rate) {
  document.getElementById('f-condicion').value = rate;
  recalcAll();
  buildCFTGrid();
}

// ============================================================
// ITEMS TABLE
// ============================================================
function addRow() {
  const id = nextId++;
  items.push({ id, proveedor:'', desc:'', qc:1, extra:0, costoUnit:0, cantLog:0, margen:50 });
  renderTable();
}

function delRow(id) {
  items = items.filter(i => i.id !== id);
  renderTable();
  recalcAll();
}

function renderTable() {
  const tbody = document.getElementById('items-tbody');
  const globals = getGlobals();
  tbody.innerHTML = items.map((item, idx) => {
    const calc = calcItem(item, globals);
    const costoPct = globals.ventaTotal > 0 ? (calc.costoTotalFinal / globals.ventaTotal * 100) : 0;
    return `
    <tr>
      <td class="row-num">${idx+1}</td>
      <td><input type="text" value="${item.proveedor}" placeholder="Proveedor" onchange="updateItem(${item.id},'proveedor',this.value)"></td>
      <td style="min-width:220px;">
        <input type="text" value="${item.desc}" placeholder="Buscar o escribir producto..." list="productos-datalist"
          oninput="updateItemSilent(${item.id},'desc',this.value)"
          onchange="updateItem(${item.id},'desc',this.value); autocompletarProducto(${item.id}, this.value)"
          onblur="autocompletarProducto(${item.id}, this.value)">
      </td>
      <td style="width:70px;"><input type="number" value="${item.qc}" min="1" onchange="updateItem(${item.id},'qc',parseFloat(this.value)||1)"></td>
      <td style="width:60px;" title="Unidades extra internas, no visibles al cliente"><input type="number" value="${item.extra}" min="0" step="1" style="color:var(--warn);" onchange="updateItem(${item.id},'extra',parseFloat(this.value)||0)"></td>
      <td style="min-width:100px;">
        <div style="position:relative;">
          <span style="position:absolute; left:7px; top:50%; transform:translateY(-50%); color:var(--muted); font-family:var(--font-mono); font-size:11px; pointer-events:none;">$</span>
          <input type="number" value="${item.costoUnit}" min="0" step="100" style="padding-left:18px;" onchange="updateItem(${item.id},'costoUnit',parseFloat(this.value)||0)">
        </div>
      </td>
      <td class="calc-cell cost" style="font-family:var(--font-mono); font-size:12px;">$${fmtN(calc.depo)}</td>
      <td style="width:70px;" title="Cantidad de env√≠os de log√≠stica"><input type="number" value="${item.cantLog}" min="0" step="1" onchange="updateItem(${item.id},'cantLog',parseFloat(this.value)||0)"></td>
      <td class="calc-cell cost" title="Costo Total = (Costo + Log√≠stica + Dep√≥sito) √ó Cant.Log.">$${fmtN(calc.costoTotalFinal)}</td>
      <td style="width:70px;">
        <div style="position:relative;">
          <input type="number" value="${item.margen}" min="0" max="99" step="0.5" style="padding-right:18px; color:var(--col-sale); font-family:var(--font-mono);" onchange="updateItem(${item.id},'margen',parseFloat(this.value)||0)">
          <span style="position:absolute; right:7px; top:50%; transform:translateY(-50%); color:var(--col-sale); font-family:var(--font-mono); font-size:11px; pointer-events:none;">%</span>
        </div>
      </td>
      <td class="calc-cell sale">$${fmtN(calc.ventaUnit)}</td>
      <td class="calc-cell fin">$${fmtN(calc.financ)}</td>
      <td class="calc-cell fin">$${fmtN(calc.comAg)}</td>
      <td class="calc-cell sale" style="font-size:13px;">$${fmtN(calc.ventaFinal)}</td>
      <td><button onclick="delRow(${item.id})" style="background:rgba(255,87,87,0.12); border:1px solid rgba(255,87,87,0.25); color:#ff5757; border-radius:6px; width:32px; height:32px; cursor:pointer; font-size:16px; display:flex; align-items:center; justify-content:center; transition:all 0.15s;" onmouseover="this.style.background='rgba(255,87,87,0.25)'" onmouseout="this.style.background='rgba(255,87,87,0.12)'">√ó</button></td>
    </tr>`;
  }).join('');
  document.getElementById('items-count').textContent = items.length + ' √≠tem' + (items.length !== 1 ? 's' : '');
}

function updateItem(id, field, val) {
  const item = items.find(i => i.id === id);
  if (item) { item[field] = val; recalcAll(); }
}

// Actualiza el dato sin rerenderizar (para no perder el foco mientras se escribe)
function updateItemSilent(id, field, val) {
  const item = items.find(i => i.id === id);
  if (item) item[field] = val;
}

// ============================================================
// GLOBALS + CALC
// ============================================================
function getGlobals() {
  return {
    dolarCCL: parseFloat(document.getElementById('g-dolar-ccl').value) || 1265,
    dolarOf: parseFloat(document.getElementById('g-dolar-of').value) || 1050,
    logisticaBase: parseFloat(document.getElementById('g-logistica').value) || 20000,
    depoP: (parseFloat(document.getElementById('g-depo').value) || 0) / 100,
    comisionP: (parseFloat(document.getElementById('g-comision').value) || 0) / 100,
    cft: (parseFloat(document.getElementById('f-condicion').value) || 0) / 100,
    iva: (parseFloat(document.getElementById('g-iva').value) || 0) / 100,
    ventaTotal: 0
  };
}

function calcItem(item, globals) {
  const extra = item.extra || 0;
  const qTotal = item.qc + extra; // cantidad real a producir (incluye extra)

  // Costo base cubre TODA la producci√≥n (cliente + extra)
  const costoTotal = qTotal * item.costoUnit;

  // Log√≠stica = cantidad de env√≠os √ó precio base de log√≠stica
  const cantLog = item.cantLog || 0;
  const logistica = cantLog * globals.logisticaBase;

  // Dep√≥sito = % sobre el costo total
  const depo = costoTotal * globals.depoP;

  // Costo total incluyendo log√≠stica y dep√≥sito
  const costoTotalFinal = costoTotal + logistica + depo;

  // Costo unitario distribuido SOLO sobre la cantidad del cliente
  // (el extra queda absorbido en el precio de venta)
  const costoUnitFinal = item.qc > 0 ? costoTotalFinal / item.qc : 0;

  // Precio de venta unitario aplicando mark-up sobre costo unitario final
  const margenP = (item.margen || 0) / 100;
  const ventaUnit = margenP < 1 ? costoUnitFinal / (1 - margenP) : costoUnitFinal;

  // Financiaci√≥n (CFT) sobre precio de venta unitario
  const financ = ventaUnit * globals.cft;

  // Comisi√≥n agencia sobre (ventaUnit + financ)
  const comAg = (ventaUnit + financ) * globals.comisionP;

  // Venta Final = precio completo √ó cantidad CLIENTE (sin extra)
  const ventaFinal = (ventaUnit + financ + comAg) * item.qc;

  return { costoTotal, logistica, depo, costoUnitFinal, costoTotalFinal, ventaUnit, financ, comAg, ventaFinal, qTotal };
}

// ============================================================
// FIREBASE ‚Äî cargar productos para autocomplete
// ============================================================
async function loadProductosFromFirebase() {
  try {
    const snap = await window._fbGetDocs(window._fbCollection(window._db, 'productos'));
    productosDB = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    buildDatalist();
    console.log(`‚úì ${productosDB.length} productos cargados desde Firebase`);
  } catch(e) {
    console.warn('Firebase no disponible, autocomplete desactivado.', e);
  }
}

// ============================================================
// DATALIST (autocomplete en editor)

// ============================================================
function buildDatalist() {
  const dl = document.getElementById('productos-datalist');
  if (!dl) return;
  dl.innerHTML = productosDB.map(p => `<option value="${p.nombre}">`).join('');
}

function autocompletarProducto(itemId, nombre) {
  const match = productosDB.find(p => p.nombre.toLowerCase() === nombre.toLowerCase());
  if (!match) return;
  const item = items.find(i => i.id === itemId);
  if (!item) return;
  if (match.costoTotal > 0) item.costoUnit = match.costoTotal;
  if (match.proveedor)      item.proveedor = match.proveedor;
  // Guardar receta si el producto tiene componentes (no se muestra, solo se usa en Aprobados)
  if (match.componentes && match.componentes.length > 0) {
    item.receta = match.componentes.map(c => ({
      nombre:   c.nombre,
      cantidad: c.cantidad,
      costoUnit: c.costoUnit,
    }));
  } else {
    item.receta = null;
  }
  recalcAll();
}

// ============================================================
// RECALC
// ============================================================
function recalcAll() {
  buildCFTGrid();
  const globals = getGlobals();
  let totalCosto = 0, totalVenta = 0;
  items.forEach(item => {
    const c = calcItem(item, globals);
    totalCosto += c.costoTotalFinal;
    totalVenta += c.ventaFinal;
  });
  globals.ventaTotal = totalVenta;

  const ventaIVA = totalVenta * (1 + globals.iva);
  const margenBruto = totalVenta - totalCosto;
  const margenPct = totalVenta > 0 ? (margenBruto / totalVenta * 100) : 0;
  const costoPct = totalVenta > 0 ? (totalCosto / totalVenta * 100) : 0;

  document.getElementById('s-costo-total').textContent = '$' + fmtN(totalCosto);
  document.getElementById('s-venta-total').textContent = '$' + fmtN(totalVenta);
  document.getElementById('s-venta-iva').textContent = '$' + fmtN(ventaIVA);
  document.getElementById('s-margen-bruto').textContent = '$' + fmtN(margenBruto);
  document.getElementById('s-margen-pct').textContent = margenPct.toFixed(1) + '%';
  document.getElementById('s-costo-pct').textContent = costoPct.toFixed(1) + '%';

  const cCard = document.getElementById('s-card-costo-pct');
  if (costoPct > 50) {
    cCard.className = 'sum-card danger-card';
  } else {
    cCard.className = 'sum-card';
  }
  renderTable();
  updateDashboard();
  updateRentabilidad();
}

// ============================================================
// DASHBOARD
// ============================================================
function updateDashboard() {
  const globals = getGlobals();
  let totalCosto = 0, totalVenta = 0;
  items.forEach(item => {
    const c = calcItem(item, globals);
    totalCosto += c.costoTotalFinal;
    totalVenta += c.ventaFinal;
  });
  const ventaIVA = totalVenta * (1 + globals.iva);
  const margenPct = totalVenta > 0 ? (totalCosto / totalVenta * 100) : 0;
  const cft = parseFloat(document.getElementById('f-condicion').value);
  const comPct = globals.comisionP * 100;

  document.getElementById('dash-cards').innerHTML = `
    <div class="sum-card"><div class="sum-label">Campa√±a Costo</div><div class="sum-value">$${fmtN(totalCosto)}</div></div>
    <div class="sum-card highlight"><div class="sum-label">Campa√±a Total (sin IVA)</div><div class="sum-value">$${fmtN(totalVenta)}</div></div>
    <div class="sum-card highlight"><div class="sum-label">Campa√±a Total + IVA</div><div class="sum-value">$${fmtN(ventaIVA)}</div></div>
    <div class="sum-card ${margenPct > 50 ? 'danger-card' : ''}">
      <div class="sum-label">Costo / Venta</div>
      <div class="sum-value">${margenPct.toFixed(1)}%</div>
      <div class="sum-sub">${margenPct > 50 ? '‚ö† Supera el l√≠mite 50%' : '‚úì Dentro del rango'}</div>
    </div>
    <div class="sum-card"><div class="sum-label">CFT aplicado</div><div class="sum-value">${cft}%</div></div>
    <div class="sum-card"><div class="sum-label">Comisi√≥n Agencia</div><div class="sum-value">${comPct}%</div></div>
  `;

  const alert = document.getElementById('dash-alert');
  if (margenPct > 50) {
    alert.innerHTML = `<div class="alert alert-danger">‚ö† <strong>Alerta:</strong> El costo del proveedor supera el 50% de la venta total. Revisar m√°rgenes o precios.</div>`;
  } else {
    alert.innerHTML = `<div class="alert alert-ok">‚úì Relaci√≥n Costo/Venta dentro del par√°metro aceptable (&lt; 50%).</div>`;
  }

  // Price breakdown
  const logTotal = items.reduce((a, item) => a + calcItem(item, globals).logistica, 0);
  const depoTotal = items.reduce((a, item) => a + calcItem(item, globals).depo, 0);
  const financTotal = items.reduce((a, item) => a + calcItem(item, globals).financ * item.qc, 0);
  const comTotal = items.reduce((a, item) => a + calcItem(item, globals).comAg * item.qc, 0);
  const margenVal = totalVenta - totalCosto;
  const bars = [
    { label: 'Costo Proveedor', val: totalCosto, color: '#ff5757' },
    { label: 'Log√≠stica', val: logTotal, color: '#ffb857' },
    { label: 'Dep√≥sito', val: depoTotal, color: '#ffd557' },
    { label: 'Margen Utilidad', val: margenVal, color: '#57c8ff' },
    { label: 'Financiaci√≥n (CFT)', val: financTotal, color: '#e8c800' },
    { label: 'Com. Agencia', val: comTotal, color: '#b8a8ff' },
  ];
  const max = totalVenta || 1;
  document.getElementById('price-breakdown').innerHTML = bars.map(b => `
    <div style="margin-bottom:10px;">
      <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:4px;">
        <span style="color:var(--muted)">${b.label}</span>
        <span style="font-family:var(--font-mono); color:${b.color}">$${fmtN(b.val)}</span>
      </div>
      <div style="height:6px; background:var(--surface3); border-radius:3px; overflow:hidden;">
        <div style="height:100%; width:${Math.max(0, b.val/max*100).toFixed(1)}%; background:${b.color}; border-radius:3px; transition:width 0.5s;"></div>
      </div>
    </div>
  `).join('');

  // Items bars
  const maxItem = Math.max(...items.map(i => calcItem(i, globals).ventaFinal), 1);
  document.getElementById('items-bars').innerHTML = items.length === 0
    ? '<div style="color:var(--muted); font-size:12px;">Sin √≠tems cargados.</div>'
    : items.map(i => {
        const c = calcItem(i, globals);
        return `
        <div style="margin-bottom:10px;">
          <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:4px;">
            <span style="color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:180px;">${i.desc || 'Sin descripci√≥n'}</span>
            <span style="font-family:var(--font-mono); color:var(--accent)">$${fmtN(c.ventaFinal)}</span>
          </div>
          <div style="height:6px; background:var(--surface3); border-radius:3px; overflow:hidden;">
            <div style="height:100%; width:${(c.ventaFinal/maxItem*100).toFixed(1)}%; background:var(--accent); border-radius:3px; transition:width 0.5s;"></div>
          </div>
        </div>`;
      }).join('');
}

// ============================================================
// RENTABILIDAD
// ============================================================
function updateRentabilidad() {
  const globals = getGlobals();
  let totalCosto = 0, totalVenta = 0;
  items.forEach(item => {
    const c = calcItem(item, globals);
    totalCosto += c.costoTotalFinal;
    totalVenta += c.ventaFinal;
  });

  const margenBruto = totalVenta - totalCosto;
  const pEquipo = parseFloat(document.getElementById('d-equipo').value) / 100;
  const pEstructura = parseFloat(document.getElementById('d-estructura').value) / 100;
  const pIIBB = parseFloat(document.getElementById('d-iibb').value) / 100;
  const pIIGG = parseFloat(document.getElementById('d-iigg').value) / 100;
  const minima = parseFloat(document.getElementById('d-minima').value);

  const equipo = margenBruto * pEquipo;
  const estructura = margenBruto * pEstructura;
  const iibb = margenBruto * pIIBB;
  const base = margenBruto - equipo - estructura - iibb;
  const iigg = base * pIIGG;
  const neta = base - iigg;
  const netaPct = totalVenta > 0 ? (neta / totalVenta * 100) : 0;

  document.getElementById('r-venta').textContent = '$' + fmtN(totalVenta);
  document.getElementById('r-costo').textContent = '$' + fmtN(totalCosto);
  document.getElementById('r-margen-bruto').textContent = '$' + fmtN(margenBruto);
  document.getElementById('r-equipo').textContent = '-$' + fmtN(equipo);
  document.getElementById('r-estructura').textContent = '-$' + fmtN(estructura);
  document.getElementById('r-iibb').textContent = '-$' + fmtN(iibb);
  document.getElementById('r-iigg').textContent = '-$' + fmtN(iigg);
  document.getElementById('r-neta').textContent = '$' + fmtN(neta);
  document.getElementById('r-neta-pct').textContent = netaPct.toFixed(2) + '%';

  const bar = document.getElementById('r-bar');
  bar.style.width = Math.min(100, Math.max(0, netaPct)).toFixed(1) + '%';
  bar.className = 'ganancia-fill' + (netaPct < minima ? ' bad' : netaPct < minima * 1.5 ? ' warn' : '');

  const alerts = document.getElementById('rent-alerts');
  let alertHTML = '';
  if (neta < 0) alertHTML += `<div class="alert alert-danger">üö® Ganancia neta negativa. Revisar costos y m√°rgenes urgente.</div>`;
  else if (netaPct < minima) alertHTML += `<div class="alert alert-warn">‚ö† Ganancia neta (${netaPct.toFixed(1)}%) por debajo del m√≠nimo requerido (${minima}%).</div>`;
  else alertHTML += `<div class="alert alert-ok">‚úì Rentabilidad dentro de par√°metros. Ganancia neta: ${netaPct.toFixed(1)}%</div>`;
  const costoPct = totalVenta > 0 ? (totalCosto / totalVenta * 100) : 0;
  if (costoPct > 50) alertHTML += `<div class="alert alert-danger">‚ö† Costo proveedor supera el 50% de la venta (${costoPct.toFixed(1)}%).</div>`;
  alerts.innerHTML = alertHTML;
}

// ============================================================
// PDF
// ============================================================
function buildPDF() {
  const globals = getGlobals();
  const cliente = document.getElementById('f-cliente').value || '‚Äî';
  const proyecto = document.getElementById('f-proyecto').value || '‚Äî';
  const fecha = document.getElementById('f-fecha').value || '‚Äî';
  const condicion = document.getElementById('f-condicion').options[document.getElementById('f-condicion').selectedIndex].text;
  const vendedor = document.getElementById('f-vendedor').value || '‚Äî';
  const entrega = document.getElementById('f-entrega').value || '‚Äî';

  let totalSinIVA = 0;
  const rows = items.map((item, idx) => {
    const c = calcItem(item, globals);
    totalSinIVA += c.ventaFinal;
    const unitSinIVA = item.qc > 0 ? c.ventaFinal / item.qc : 0;
    return `<tr>
      <td>${idx+1}</td>
      <td><strong>${item.desc || '‚Äî'}</strong>${item.proveedor ? '<br><span style="font-size:11px;color:#888">'+item.proveedor+'</span>' : ''}</td>
      <td style="text-align:center;">${item.qc}</td>
      <td style="text-align:right; font-family:monospace;">$${fmtN(unitSinIVA)}</td>
      <td style="text-align:right; font-family:monospace; font-weight:bold;">$${fmtN(c.ventaFinal)}</td>
    </tr>`;
  }).join('');

  const iva = totalSinIVA * globals.iva;
  const total = totalSinIVA + iva;

  document.getElementById('pdf-content').innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:2px solid #e8c800; padding-bottom:16px;">
      <div>
        <h1 style="margin:0 0 4px 0;">Propuesta Econ√≥mica</h1>
        <div class="pdf-meta" style="margin:0;">
          <strong>${proyecto}</strong> ‚Äî ${cliente} &nbsp;|&nbsp; Fecha: ${fecha} &nbsp;|&nbsp; Entrega estimada: ${entrega} &nbsp;|&nbsp; Vendedor: ${vendedor}
        </div>
      </div>
      <img src="data:image/png;base64,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" style="height:48px; background:#111; padding:6px 10px; border-radius:6px;" alt="Piola">
    </div>
    <table class="pdf-table">
      <thead>
        <tr><th>#</th><th>Descripci√≥n</th><th style="text-align:center">Cant.</th><th style="text-align:right">P. Unit.</th><th style="text-align:right">P. Total</th></tr>
      </thead>
      <tbody>
        ${rows}
        <tr class="pdf-total-row">
          <td colspan="4" style="text-align:right">Subtotal (sin IVA)</td>
          <td style="text-align:right; font-family:monospace;">$${fmtN(totalSinIVA)}</td>
        </tr>
        <tr>
          <td colspan="4" style="text-align:right">IVA (${(globals.iva*100).toFixed(0)}%)</td>
          <td style="text-align:right; font-family:monospace;">$${fmtN(iva)}</td>
        </tr>
        <tr class="pdf-total-row">
          <td colspan="4" style="text-align:right; font-size:15px;">TOTAL</td>
          <td style="text-align:right; font-family:monospace; font-size:15px;">$${fmtN(total)}</td>
        </tr>
      </tbody>
    </table>
    <div class="pdf-conditions">
      <div style="font-size:13px; font-weight:700; margin-bottom:8px; text-transform:uppercase; letter-spacing:0.5px;">Condiciones Comerciales</div>
      <ul style="margin:0; padding-left:18px; line-height:1.8; font-size:12px; color:#333;">
        <li>En este presupuesto est√° considerado solamente por lo arriba descrito, cualquier cosa adicional se considerar√° como tal.</li>
        <li>En caso de cancelaci√≥n, el anticipo no es reembolsable.</li>
        <li>Los precios incluyen la idea creativa, dise√±o gr√°fico / industrial y desarrollo total de los productos.</li>
        <li>El proyecto se comenzar√° a realizar una vez confirmado el proyecto del cliente mediante OC.</li>
        <li><strong>Forma de pago:</strong> ${condicion}</li>
        <li><strong>Plazo de producci√≥n estimado:</strong> a confirmar con producci√≥n.</li>
        <li>Los precios anteriores no incluyen IVA.</li>
        <li>Costo de env√≠o total en CABA/AMBA incluido.</li>
        <li>Servicio personalizado por kit puerta a puerta disponible ‚Äî se cotiza aparte.</li>
        <li>Los dise√±os son a modo ilustrativo, la producci√≥n puede presentar peque√±as variaciones.</li>
      </ul>
    </div>
    <p style="font-size:10px; color:#aaa; margin-top:20px; text-align:center;">Propuesta generada por Sistema Cotizador ¬∑ Piola 2025</p>
  `;
}

// ============================================================
// SAVE / HISTORY
// ============================================================
// ============================================================
// COTIZACIONES ‚Äî Firebase
// ============================================================
let currentFirebaseId = null; // ID del doc actualmente cargado

async function saveQuote() {
  // Validar vendedor obligatorio
  const vendedorVal = document.getElementById('f-vendedor').value.trim();
  if (!vendedorVal) {
    toast('‚ö† El campo Vendedor es obligatorio', '');
    document.getElementById('f-vendedor').focus();
    document.getElementById('f-vendedor').style.borderColor = 'var(--danger)';
    setTimeout(() => document.getElementById('f-vendedor').style.borderColor = '', 2000);
    return;
  }

  const g = getGlobals();
  let totalVenta = 0;
  items.forEach(i => { totalVenta += calcItem(i, g).ventaFinal; });

  const quote = {
    fecha:    document.getElementById('f-fecha').value,
    cliente:  document.getElementById('f-cliente').value  || 'Sin cliente',
    proyecto: document.getElementById('f-proyecto').value || 'Sin nombre',
    vendedor: document.getElementById('f-vendedor').value || '‚Äî',
    items:    JSON.parse(JSON.stringify(items)),
    globals: {
      dolarCCL:     parseFloat(document.getElementById('g-dolar-ccl').value),
      logisticaBase:parseFloat(document.getElementById('g-logistica').value),
      depoP:        parseFloat(document.getElementById('g-depo').value),
      comisionP:    parseFloat(document.getElementById('g-comision').value),
      iva:          parseFloat(document.getElementById('g-iva').value),
      cft:          parseFloat(document.getElementById('f-condicion').value),
    },
    totalVenta,
    savedAt:        new Date().toISOString(),
    savedAtDisplay: new Date().toLocaleString('es-AR'),
  };

  try {
    if (currentFirebaseId) {
      // Edici√≥n ‚Äî actualizar el documento existente
      await window._fbUpdateDoc(window._fbDoc(window._db, 'cotizaciones', currentFirebaseId), quote);
      toast('‚úì Cotizaci√≥n actualizada en la nube', 'success');
    } else {
      // Nueva cotizaci√≥n ‚Äî obtener n√∫mero at√≥mico desde Firebase
      const counterRef = window._fbDoc(window._db, 'config', 'counter');
      let newNumber;
      await window._fbRunTransaction(window._db, async (transaction) => {
        const counterDoc = await transaction.get(counterRef);
        if (!counterDoc.exists()) {
          newNumber = 1;
          transaction.set(counterRef, { value: 2 });
        } else {
          newNumber = (counterDoc.data().value || 1);
          transaction.update(counterRef, { value: newNumber + 1 });
        }
      });
      quote.id     = 'COT-' + String(newNumber).padStart(4, '0');
      quote.estado = 'borrador';
      const ref = await window._fbAddDoc(window._fbCollection(window._db, 'cotizaciones'), quote);
      currentFirebaseId = ref.id;
      document.getElementById('display-id').textContent = quote.id;
      toast('‚úì Cotizaci√≥n ' + quote.id + ' guardada en la nube', 'success');
    }
  } catch(e) {
    toast('Error al guardar: ' + e.message, '');
  }
}

async function updateEstado(firebaseId, nuevoEstado) {
  try {
    await window._fbUpdateDoc(window._fbDoc(window._db, 'cotizaciones', firebaseId), { estado: nuevoEstado });
  } catch(e) { toast('Error: ' + e.message, ''); }
}

async function deleteQuote(firebaseId, cotId) {
  if (!confirm('¬øEliminar la cotizaci√≥n ' + cotId + '?')) return;
  try {
    await window._fbDeleteDoc(window._fbDoc(window._db, 'cotizaciones', firebaseId));
    toast('Cotizaci√≥n eliminada', '');
  } catch(e) { toast('Error: ' + e.message, ''); }
}

function renderHistorial() {
  const loading = document.getElementById('cot-loading');
  const empty   = document.getElementById('cot-empty');
  const tbody   = document.getElementById('historial-list');
  const count   = document.getElementById('cot-count');
  if (!tbody) return;
  if (loading) loading.style.display = 'none';

  const db = window._quotesDB || {};
  const all = Object.values(db);

  const search = (document.getElementById('cot-search')?.value || '').toLowerCase();
  const estado = document.getElementById('cot-filtro-estado')?.value || '';

  const filtered = all.filter(q =>
    (!search || q.cliente.toLowerCase().includes(search) || q.proyecto.toLowerCase().includes(search)) &&
    (!estado || q.estado === estado)
  );

  if (count) count.textContent = all.length + ' cotizaci√≥n' + (all.length !== 1 ? 'es' : '');

  if (all.length === 0) {
    empty.style.display = 'block'; tbody.innerHTML = ''; return;
  }
  empty.style.display = 'none';

  const estadoOpts = ['borrador','enviada','aprobada','rechazada'];
  const estadoLabel = { borrador:'Borrador', enviada:'Enviada', aprobada:'Aprobada', rechazada:'Rechazada' };

  tbody.innerHTML = filtered.map(q => `
    <tr style="border-bottom:1px solid rgba(42,42,56,0.4);" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background=''">
      <td style="padding:10px; font-family:var(--font-mono); color:var(--accent); font-size:12px; white-space:nowrap;">${q.id}</td>
      <td style="padding:10px; font-size:13px; font-weight:600;">${q.cliente}</td>
      <td style="padding:10px; font-size:12px; color:var(--muted);">${q.proyecto}</td>
      <td style="padding:10px; font-family:var(--font-mono); font-size:11px; color:var(--muted); white-space:nowrap;">${q.fecha}</td>
      <td style="padding:10px; font-family:var(--font-mono); font-size:13px; font-weight:700; color:var(--col-sale); text-align:right; white-space:nowrap;">$${fmtN(q.totalVenta||0)}</td>
      <td style="padding:10px; text-align:center;">
        <select onchange="updateEstado('${q.firebaseId}', this.value)"
          style="background:transparent; border:none; font-size:11px; font-weight:700; font-family:var(--font-body); cursor:pointer; outline:none;"
          class="badge badge-${q.estado||'borrador'}">
          ${estadoOpts.map(e => `<option value="${e}" ${q.estado===e?'selected':''} style="background:var(--surface2); color:var(--text);">${estadoLabel[e]}</option>`).join('')}
        </select>
      </td>
      <td style="padding:10px; font-size:12px; color:var(--muted);">${q.vendedor||'‚Äî'}</td>
      <td style="padding:10px;">
        <div style="display:flex; gap:6px; justify-content:flex-end;">
          <button class="btn btn-secondary" style="font-size:11px; padding:5px 10px;" onclick="loadQuote('${q.firebaseId}')">‚úèÔ∏è Cargar</button>
          <button class="del-btn" onclick="deleteQuote('${q.firebaseId}','${q.id}')">√ó</button>
        </div>
      </td>
    </tr>
  `).join('') || `<tr><td colspan="8" style="padding:20px; text-align:center; color:var(--muted);">Sin resultados para el filtro aplicado</td></tr>`;
}

function loadQuote(firebaseId) {
  const q = (window._quotesDB || {})[firebaseId];
  if (!q) { toast('No se encontr√≥ la cotizaci√≥n', ''); return; }
  currentFirebaseId = firebaseId; // guardar para poder actualizar
  items = JSON.parse(JSON.stringify(q.items));
  items.forEach(i => {
    if (i.cantLog === undefined) i.cantLog = 0;
    if (i.extra   === undefined) i.extra   = 0;
    if (i.margen  === undefined) i.margen  = 30;
  });
  nextId = items.reduce((m, i) => Math.max(m, i.id), 0) + 1;
  document.getElementById('f-cliente').value   = q.cliente;
  document.getElementById('f-proyecto').value  = q.proyecto;
  document.getElementById('f-fecha').value     = q.fecha;
  document.getElementById('f-vendedor').value  = q.vendedor || '';
  document.getElementById('g-dolar-ccl').value = q.globals.dolarCCL;
  document.getElementById('g-logistica').value = q.globals.logisticaBase;
  document.getElementById('g-depo').value      = q.globals.depoP;
  document.getElementById('g-comision').value  = q.globals.comisionP;
  document.getElementById('g-iva').value       = q.globals.iva;
  document.getElementById('f-condicion').value = q.globals.cft;
  // Mostrar ID de la cotizaci√≥n cargada
  document.getElementById('display-id').textContent = q.id;
  recalcAll();
  showView('editor', document.querySelectorAll('.tab')[0]);
  toast('‚úì Cotizaci√≥n ' + q.id + ' cargada ‚Äî guardar actualiza esta cotizaci√≥n', 'success');
}

function nuevaCotizacion() {
  currentFirebaseId = null;
  items = [];
  nextId = 1;
  document.getElementById('f-cliente').value  = '';
  document.getElementById('f-proyecto').value = '';
  document.getElementById('f-vendedor').value = '';
  document.getElementById('display-id').textContent = 'COT-????';
  recalcAll();
  toast('Nueva cotizaci√≥n lista', '');
}

// ============================================================
// UTILS
// ============================================================
function fmtN(n) {
  if (isNaN(n) || n === undefined) return '0';
  return Math.round(n).toLocaleString('es-AR');
}

function fmtDec(n) {
  if (isNaN(n) || n === undefined) return '0';
  return parseFloat(n).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function toast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show ' + (type || '');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// Theme toggle
function toggleTheme() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') === 'dark';
  html.setAttribute('data-theme', isDark ? 'light' : 'dark');
  document.getElementById('theme-btn').textContent = isDark ? 'üåô Oscuro' : '‚òÄÔ∏è Claro';
  localStorage.setItem('piola-theme', isDark ? 'light' : 'dark');
}
const savedTheme = localStorage.getItem('piola-theme');
if (savedTheme) {
  document.documentElement.setAttribute('data-theme', savedTheme);
  window.addEventListener('load', () => {
    const btn = document.getElementById('theme-btn');
    if (btn) btn.textContent = savedTheme === 'light' ? 'üåô Oscuro' : '‚òÄÔ∏è Claro';
  });
}

// Initial calc
recalcAll();
</script>
</body>
</html>
